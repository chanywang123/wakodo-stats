<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>光堂眼鏡戰情室 (Debug Mode)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
</head>
<body class="p-10">
  <h1 class="text-2xl font-bold mb-4">系統自我診斷中...</h1>
  <div id="debugLog" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm whitespace-pre-wrap">Waiting for response...</div>

  <script>
    window.onload = async () => {
      const log = document.getElementById('debugLog');
      
      try {
        log.textContent += '\n1. Testing Connection...';
        // 嘗試最簡單的查詢，避開 RPC
        const { data, error } = await supabase.from('visits').select('*').limit(1);
        
        if (error) {
          log.textContent += `\n[Fatal Error] Direct Table Access Failed:\n${JSON.stringify(error, null, 2)}`;
        } else {
          log.textContent += `\n[Success] Table Access OK. Found ${data.length} rows.`;
          
          log.textContent += '\n\n2. Testing RPC (get_stats_public)...';
          const { data: rpcData, error: rpcError } = await supabase.rpc('get_stats_public', {
            start_date: '2025-01-01', end_date: '2025-12-31', store_filter: '全部'
          });
          
          if(rpcError) {
             log.textContent += `\n[RPC Error] get_stats_public Failed:\n${JSON.stringify(rpcError, null, 2)}`;
          } else {
             log.textContent += `\n[Success] RPC OK.`;
          }
        }
      } catch (e) {
        log.textContent += `\n[Exception] ${e.message}`;
      }
    };
  </script>
</body>
</html>
