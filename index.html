<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V5.2 Light Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    /* VARIABLES (Pure Light Theme) */
    :root { 
      --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --subtext: #4b5563; 
      --border: #e5e7eb; --accent: #2563eb; --accent-hover: #1d4ed8; 
      
      /* Table Colors (Requested) */
      --table-header-bg: #fcd34d; /* Yellow-300 */
      --table-header-text: #000000;
      --row-hover: #fef3c7; /* Yellow-100 (Goose Yellow) */
    }
    
    body { background-color: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; }
    
    /* INPUTS (Booking Style - Preserved) */
    .date-range-group {
      display: flex; align-items: center; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
      transition: 0.2s;
    }
    .date-range-group:focus-within { border-color: var(--accent); ring: 2px solid var(--accent); }
    .date-input { 
      background: transparent; border: none; color: var(--text); padding: 8px 12px; outline: none; font-size: 14px; width: 130px; 
    }
    
    .input-std { background: #fff; border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 8px; outline: none; width: 100%; }
    
    /* BUTTONS */
    .btn-primary { background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; transition: 0.2s; }
    .btn-primary:hover { background: var(--accent-hover); }
    
    /* STATS */
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat.active { border-color: var(--accent); background: #eff6ff; }

    /* TABLE STYLES (Fixed) */
    .table-header { background-color: var(--table-header-bg) !important; color: var(--table-header-text) !important; font-weight: 800; border-bottom: 2px solid #fbbf24; }
    tr { transition: background-color 0.15s; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background-color: var(--row-hover) !important; }
    
    /* ADMIN */
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: flex !important; }
    
    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(2px); }
    .modal-content { background: #fff; color: #000; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 24px; border: 1px solid #e5e7eb; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    
    .detail-row { display: flex; border-bottom: 1px solid #e5e7eb; padding: 12px 0; align-items: center; }
    .detail-label { width: 100px; font-weight: bold; color: #6b7280; }
    
    /* Trend Chart Box */
    #trendBox { height: 100px; width: 100%; margin-top: 16px; display: none; }
  </style>
</head>
<body class="">

<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold tracking-tight text-gray-900 flex items-center gap-2">
        <span>ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</span>
        <span class="text-xs px-2 py-0.5 rounded border border-gray-400 text-gray-500">V5.2</span>
      </h1>
    </div>
    <div class="flex items-center gap-3">
      <!-- Admin Button -->
      <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-gray-800 p-2 transition" title="ç®¡ç†å“¡">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      </button>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden mb-6 card bg-gray-800 text-white border-0 shadow-xl">
    <div id="loginForm" class="flex flex-col md:flex-row gap-3 items-center">
      <input type="email" id="admEmail" value="chanywang92@gmail.com" class="input-std text-black" placeholder="Email">
      <input type="password" id="admPwd" class="input-std text-black" placeholder="Password">
      <button onclick="login()" class="btn-primary ring-2 ring-offset-2 ring-blue-500">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center justify-between w-full">
      <div class="font-bold text-green-400 flex items-center gap-2">
        <span class="w-2 h-2 bg-green-400 rounded-full"></span> ç®¡ç†å“¡å·²ç™»å…¥
      </div>
      <div class="flex gap-2">
        <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm flex items-center gap-1 transition text-white">
          <span>ğŸ“‚ åŒ¯å…¥ CSV</span>
          <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="previewCSV(this)">
        </label>
        <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm">åŒ¯å‡º CSV</button>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded text-sm">ç™»å‡º</button>
      </div>
      <button onclick="wipeData()" class="text-red-400 hover:text-red-300 text-sm font-bold border border-red-400 px-3 py-1 rounded">âš ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- Filter Bar (Preserved Booking Style) -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center sticky top-2 z-30 shadow-md">
    <div class="date-range-group shadow-sm">
      <div class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wide">Check-in</div>
      <input type="date" id="qFrom" class="date-input font-medium text-gray-700">
      <div class="px-2 text-gray-300">â</div>
      <div class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wide">Check-out</div>
      <input type="date" id="qTo" class="date-input font-medium text-gray-700">
    </div>
    
    <div class="flex-grow relative group">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å‚™è¨»..." class="input-std pl-9 pr-8 shadow-inner bg-gray-50 focus:bg-white transition">
      <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      <button onclick="clearSearch()" id="btnClearSearch" class="hidden absolute right-2 top-2.5 text-gray-400 hover:text-gray-600">âœ•</button>
    </div>
    <button onclick="fetchData()" class="btn-primary shadow-md">æŸ¥è©¢</button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div onclick="setStore('å…¨éƒ¨')" id="btnTotal" class="card btn-stat flex flex-col justify-center items-center active py-6"><div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ç¸½å®¢æ•¸</div><div class="text-4xl font-extrabold text-gray-800" id="statTotal">--</div></div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="btnLinAn" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">è‡¨å®‰åº—</div><div class="text-4xl font-extrabold text-blue-600" id="statLinAn">--</div></div>
    <div onclick="setStore('å—ç§‘åº—')" id="btnNanKe" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">å—ç§‘åº—</div><div class="text-4xl font-extrabold text-green-600" id="statNanKe">--</div></div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card h-[500px] flex flex-col">
      <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2"><h3 class="font-bold text-gray-800">å®¢æºåˆ†æ</h3><select id="sourceFilter" onchange="filterSource()" class="input-std w-auto text-xs py-1"><option value="ALL">é¡¯ç¤ºå…¨éƒ¨å®¢æº</option></select></div>
      <div class="flex-grow relative w-full h-full min-h-0"><canvas id="chartSource"></canvas></div>
      <div id="trendBox">
        <div class="text-xs font-bold text-gray-400 mb-1">ğŸ“… è¶¨å‹¢èµ°å‹¢ (<span id="trendLabel"></span>)</div>
        <div class="relative w-full h-full"><canvas id="chartTrend"></canvas></div>
      </div>
    </div>
    <div class="card h-[500px] flex flex-col">
      <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2"><div class="flex items-center gap-2"><h3 class="font-bold text-gray-800">ä¾†åº—ç›®çš„</h3><span id="purposeSubtitle" class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">(å…¨éƒ¨)</span></div></div>
      <div class="flex-grow relative w-full h-full min-h-0 flex justify-center"><canvas id="chartPurpose"></canvas></div>
    </div>
  </div>

  <!-- Table (Fixed Colors) -->
  <div class="card overflow-hidden border-0 shadow-lg">
    <div class="flex justify-between items-center mb-4 px-2">
      <h3 class="font-bold text-lg text-gray-900">æœ€æ–°ä¾†å®¢ç´€éŒ„ <span class="text-xs font-medium text-white bg-gray-800 px-2 py-0.5 rounded-full ml-2">Top 50</span></h3>
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead class="table-header">
          <tr><th class="p-3 pl-4">æ—¥æœŸ</th><th class="p-3">åˆ†åº—</th><th class="p-3">å§“å</th><th class="p-3">å®¢æº</th><th class="p-3">ç›®çš„</th><th class="p-3 pr-4 admin-only text-right">æ“ä½œ</th></tr>
        </thead>
        <tbody id="tableBody" class="bg-white"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal-overlay">
  <div class="modal-content shadow-2xl">
    <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-2">
      <h2 class="text-xl font-bold text-gray-800">æ–°å¢è³‡æ–™</h2>
      <button onclick="closeModal()" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
    </div>
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 mb-1 block">æ—¥æœŸ</label><input type="date" id="mDate" class="input-std"></div><div><label class="text-xs font-bold text-gray-500 mb-1 block">åˆ†åº—</label><select id="mStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select></div></div>
      <div><label class="text-xs font-bold text-gray-500 mb-1 block">å§“å</label><input type="text" id="mName" class="input-std" placeholder="é¡§å®¢å§“å"></div>
      <div><label class="text-xs font-bold text-gray-500 mb-1 block">å®¢æº (é€—è™Ÿåˆ†éš”)</label><input type="text" id="mSources" class="input-std" placeholder="ä¾‹å¦‚: Googleæœå°‹, è¦ªå‹ä»‹ç´¹"></div>
      <div><label class="text-xs font-bold text-gray-500 mb-1 block">ç›®çš„ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="mPurposes" class="input-std" placeholder="ä¾‹å¦‚: é©—å…‰é…é¡"></div>
      <div><label class="text-xs font-bold text-gray-500 mb-1 block">å‚™è¨»</label><textarea id="mDetail" class="input-std h-20"></textarea></div>
      <button onclick="saveData()" class="btn-primary w-full py-3">å„²å­˜</button>
    </div>
  </div>
</div>

<div id="detailModal" class="modal-overlay">
  <div class="modal-content shadow-2xl">
    <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
      <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ è©³ç´°è³‡æ–™</h2>
      <div class="flex gap-2">
        <button onclick="toggleEditMode()" class="admin-only bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm font-bold hover:bg-blue-200 transition">âœï¸ ç·¨è¼¯</button>
        <button onclick="document.getElementById('detailModal').style.display='none'" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
      </div>
    </div>
    
    <div id="detailView" class="block space-y-2">
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><div class="detail-val text-gray-800" id="dDate"></div></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><div class="detail-val text-gray-800" id="dStore"></div></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><div class="detail-val font-bold text-2xl text-blue-600" id="dName"></div></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><div class="detail-val flex flex-wrap gap-1" id="dSources"></div></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><div class="detail-val flex flex-wrap gap-1" id="dPurposes"></div></div>
      <div class="detail-row border-0"><div class="detail-label">æè¿°</div><div class="detail-val whitespace-pre-wrap bg-gray-50 p-4 rounded text-sm text-gray-600 border border-gray-200 w-full" id="dDetail"></div></div>
    </div>

    <div id="detailEdit" class="hidden space-y-3">
      <input type="hidden" id="eId">
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><input type="date" id="eDate" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><select id="eStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><input type="text" id="eName" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><input type="text" id="eSources" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><input type="text" id="ePurposes" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">æè¿°</div><textarea id="eDetail" class="input-std h-24"></textarea></div>
      <button onclick="saveEdit()" class="btn-primary w-full">å„²å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<script>
  let visits = [], stats = {}, currentStore = 'å…¨éƒ¨', savedSourceFilter = 'ALL';
  let charts = { source: null, purpose: null, trend: null };

  window.onload = async () => {
    // 1. Auto-range fix (Force earliest date)
    const { data: range } = await supabase.from('visits').select('form_date').order('form_date', { ascending: true }).limit(1);
    const { data: rangeEnd } = await supabase.from('visits').select('form_date').order('form_date', { ascending: false }).limit(1);
    
    // Set default range to cover ALL data
    document.getElementById('qFrom').value = (range && range.length) ? range[0].form_date : '2023-01-01';
    document.getElementById('qTo').value = (rangeEnd && rangeEnd.length) ? rangeEnd[0].form_date : new Date().toISOString().split('T')[0];

    checkAuth();
    fetchData();
  };

  // --- DATA FETCH ---
  window.fetchData = async () => {
    const from = document.getElementById('qFrom').value; 
    const to = document.getElementById('qTo').value; 
    const keyword = document.getElementById('qSearch').value;
    
    // Counts
    const { data: allData } = await supabase.from('visits').select('store_branch').gte('form_date', from).lte('form_date', to);
    if(allData) {
      document.getElementById('statTotal').textContent=allData.length; 
      document.getElementById('statLinAn').textContent=allData.filter(r=>r.store_branch==='è‡¨å®‰åº—').length; 
      document.getElementById('statNanKe').textContent=allData.filter(r=>r.store_branch==='å—ç§‘åº—').length; 
    }
    
    // List
    const { data: list, error } = await supabase.rpc('get_visits_public', { start_date: from, end_date: to, keyword: keyword, store_filter: currentStore });
    if(error) console.error(error);
    if(list) {
      visits = list;
      // Calc stats
      const sMap = {}, pMap = {};
      list.forEach(v => {
        (v.source_tags||[]).forEach(s => sMap[s] = (sMap[s]||0)+1);
        (v.visit_purposes||[]).forEach(p => pMap[p] = (pMap[p]||0)+1);
      });
      stats = {
        sources: Object.entries(sMap).map(([k,v])=>({tag:k,c:v})).sort((a,b)=>b.c-a.c),
        purposes: Object.entries(pMap).map(([k,v])=>({purpose:k,c:v})).sort((a,b)=>b.c-a.c)
      };
      
      // Update Dropdown (preserve selection)
      const sel = document.getElementById('sourceFilter');
      const currentVal = sel.value === 'ALL' ? savedSourceFilter : sel.value;
      sel.innerHTML = '<option value="ALL">é¡¯ç¤ºå…¨éƒ¨å®¢æº</option>';
      stats.sources.forEach(s => {
        const opt = document.createElement('option'); opt.value = s.tag; opt.textContent = s.tag;
        sel.appendChild(opt);
      });
      if(stats.sources.find(s=>s.tag === currentVal)) sel.value = currentVal;
      
      renderAll();
    }
  };

  // --- RENDER ---
  function renderAll() {
    // Filter logic
    let chartVisits = visits;
    const filter = document.getElementById('sourceFilter').value;
    if(filter !== 'ALL') {
      chartVisits = visits.filter(v => (v.source_tags||[]).includes(filter));
      document.getElementById('purposeSubtitle').textContent = `(ä¾†è‡ª: ${filter})`;
      document.getElementById('trendBox').style.display = 'block';
      document.getElementById('trendLabel').textContent = filter;
      renderTrend(filter);
    } else {
      document.getElementById('purposeSubtitle').textContent = '(å…¨éƒ¨)';
      document.getElementById('trendBox').style.display = 'none';
    }

    // Recalc Chart Data
    const pMap = {}; chartVisits.forEach(v => (v.visit_purposes||[]).forEach(p => pMap[p] = (pMap[p]||0)+1));
    const pData = Object.entries(pMap).map(([k,v])=>({purpose:k,c:v})).sort((a,b)=>b.c-a.c);

    renderChart('chartSource', 'bar', stats.sources, 'tag', 'å®¢æºæ•¸é‡');
    renderChart('chartPurpose', 'doughnut', pData, 'purpose', 'ç›®çš„åˆ†ä½ˆ');

    // Table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = visits.map(v => `
      <tr class="cursor-pointer" onclick="showDetail('${v.id}')">
        <td class="p-3 pl-4 font-mono text-xs text-gray-500">${v.form_date.slice(5)}</td>
        <td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold tracking-wide ${v.store_branch==='è‡¨å®‰åº—'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${v.store_branch}</span></td>
        <td class="p-3 font-bold text-gray-900">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 max-w-[100px] truncate">${(v.source_tags||[]).join(',')}</td>
        <td class="p-3 text-xs text-gray-500 max-w-[100px] truncate">${(v.visit_purposes||[]).join(',')}</td>
        <td class="p-3 pr-4 admin-only text-right"><button onclick="deleteData('${v.id}', event)" class="text-red-400 hover:text-red-600 p-1.5 font-bold">åˆª</button></td>
      </tr>
    `).join('');
  }

  // --- CHARTS (Light Theme Only) ---
  function renderChart(id, type, data, key, label) {
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    // Classic Bright Colors
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];
    
    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: data.map(x=>x[key]),
        datasets: [{ label: label, data: data.map(x=>x.c), backgroundColor: colors, borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: type==='doughnut', position: 'right', labels: { color: '#374151' } },
          tooltip: {
            backgroundColor: 'rgba(255,255,255,0.95)',
            titleColor: '#000',
            bodyColor: '#000',
            borderColor: '#e5e7eb',
            borderWidth: 1,
            callbacks: {
              label: function(ctx) {
                let val = ctx.raw;
                let total = ctx.chart._metasets[ctx.datasetIndex].total;
                if(!total || total === 0) total = ctx.dataset.data.reduce((a,b)=>a+b, 0); 
                let pct = total > 0 ? Math.round((val/total)*100) + '%' : '0%';
                return `${ctx.dataset.label}: ${val} ç­† (${pct})`;
              }
            }
          }
        },
        scales: type==='bar' ? {
          y: { ticks: { color: '#4b5563' }, grid: { color: '#f3f4f6' } },
          x: { ticks: { color: '#4b5563' }, grid: { display: false } }
        } : {}
      }
    });
  }

  function renderTrend(source) {
    const ctx = document.getElementById('chartTrend').getContext('2d');
    if(charts.trend) charts.trend.destroy();
    
    const map = {};
    visits.filter(v => (v.source_tags||[]).includes(source)).forEach(v => {
      const m = v.form_date.slice(0, 7); // YYYY-MM
      map[m] = (map[m]||0)+1;
    });
    const labels = Object.keys(map).sort();
    
    charts.trend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'æ•¸é‡', data: labels.map(l=>map[l]),
          borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)',
          fill: true, tension: 0.4, pointRadius: 4
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  }

  // --- DETAILS ---
  window.showDetail = (id) => {
    const v = visits.find(x => x.id == id); if(!v) return;
    
    document.getElementById('dDate').textContent = v.form_date;
    document.getElementById('dStore').textContent = v.store_branch;
    document.getElementById('dName').textContent = v.customer_name;
    document.getElementById('dSources').innerHTML = (v.source_tags||[]).map(x=>`<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs border border-gray-200">${x}</span>`).join('');
    document.getElementById('dPurposes').innerHTML = (v.visit_purposes||[]).map(x=>`<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs border border-gray-200">${x}</span>`).join('');
    document.getElementById('dDetail').textContent = v.detail_desc || 'ç„¡';

    // Set Edit
    document.getElementById('eId').value = v.id;
    document.getElementById('eDate').value = v.form_date;
    document.getElementById('eStore').value = v.store_branch;
    document.getElementById('eName').value = v.customer_name;
    document.getElementById('eSources').value = (v.source_tags||[]).join(',');
    document.getElementById('ePurposes').value = (v.visit_purposes||[]).join(',');
    document.getElementById('eDetail').value = v.detail_desc||'';

    document.getElementById('detailView').classList.remove('hidden');
    document.getElementById('detailEdit').classList.add('hidden');
    document.getElementById('detailModal').style.display = 'flex';
  };

  // --- ADMIN & IMPORT ---
  window.previewCSV = (input) => {
    const f=input.files[0]; if(!f)return;
    Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{
      if(confirm(`è§£æåˆ° ${res.data.length} ç­†è³‡æ–™ã€‚ç¢ºå®šåŒ¯å…¥ï¼Ÿ`)) startImport(res.data);
      input.value='';
    }});
  };
  async function startImport(data) {
    let count=0;
    for(let r of data) {
      const d=r['form_date']||r['å¡«è¡¨æ—¥æœŸ']; let n=r['customer_name']||r['é¡§å®¢å§“å'];
      if(!d||!n)continue;
      
      const s=(r['ä¾†æºçµ±è¨ˆ']||r['source_tags']||'').split(/,|ï¼Œ/).filter(x=>x); 
      const p=(r['ä¾†åº—ç›®çš„']||r['visit_purposes']||'').split(/,|ï¼Œ/).filter(x=>x);
      
      const pl={p_date:d.replace(/\//g,'-'),p_store:r['store_branch']||r['é–€åº—']||'è‡¨å®‰åº—',p_name:n,p_gender:'',p_age:'',p_tainan:false,p_sources:s,p_purposes:p,p_keyword:'',p_detail:r['detail_desc']||r['è©³ç´°æè¿°']||''};
      
      const {error}=await supabase.rpc('submit_visit',pl);
      if(!error)count++;
    }
    alert(`åŒ¯å…¥ä½œæ¥­çµæŸã€‚æˆåŠŸæ–°å¢ ${count} ç­†`); fetchData();
  }
  
  // Standard Admin Functions
  window.setStore=store=>{currentStore=store;document.querySelectorAll('.btn-stat').forEach(b=>b.classList.remove('active'));if(store==='å…¨éƒ¨')document.getElementById('btnTotal').classList.add('active');if(store==='è‡¨å®‰åº—')document.getElementById('btnLinAn').classList.add('active');if(store==='å—ç§‘åº—')document.getElementById('btnNanKe').classList.add('active');fetchData();};
  window.filterSource=()=>{savedSourceFilter=document.getElementById('sourceFilter').value;renderAll();};
  window.clearSearch=()=>{document.getElementById('qSearch').value='';document.getElementById('btnClearSearch').classList.add('hidden');fetchData();};
  window.openAddModal=()=>{document.getElementById('modal').style.display='flex';document.getElementById('mDate').value=new Date().toISOString().split('T')[0];};
  window.closeModal=()=>{document.getElementById('modal').style.display='none';};
  window.toggleEditMode=()=>{document.getElementById('detailView').classList.toggle('hidden');document.getElementById('detailEdit').classList.toggle('hidden');};
  window.saveEdit=async()=>{const id=document.getElementById('eId').value;const pl={p_date:document.getElementById('eDate').value,p_store:document.getElementById('eStore').value,p_name:document.getElementById('eName').value,p_sources:document.getElementById('eSources').value.split(','),p_purposes:document.getElementById('ePurposes').value.split(','),p_detail:document.getElementById('eDetail').value};const{error}=await supabase.from('visits').update({form_date:pl.p_date,store_branch:pl.p_store,customer_name:pl.p_name,source_tags:pl.p_sources,visit_purposes:pl.p_purposes,detail_desc:pl.p_detail}).eq('id',id);if(error)alert(error.message);else{alert('æ›´æ–°æˆåŠŸ');document.getElementById('detailModal').style.display='none';fetchData();}};
  window.saveData=async()=>{const n=document.getElementById('mName').value;if(!n)return alert('è«‹å¡«å');const pl={p_date:document.getElementById('mDate').value,p_store:document.getElementById('mStore').value,p_name:n,p_sources:document.getElementById('mSources').value.split(','),p_purposes:document.getElementById('mPurposes').value.split(','),p_detail:document.getElementById('mDetail').value,p_gender:'',p_age:'',p_tainan:false,p_keyword:''};const{error}=await supabase.rpc('submit_visit',pl);if(error)alert(error.message);else{alert('æˆåŠŸ');closeModal();fetchData();}};
  window.deleteData=async(id, e)=>{e.stopPropagation(); if(!confirm('åˆªé™¤?'))return;const{error}=await supabase.from('visits').delete().eq('id',id);if(!error)fetchData();};
  window.toggleAdminPanel=()=>{document.getElementById('adminPanel').classList.toggle('hidden');};
  
  // FIX: Explicit Login Check
  window.login = async () => {
    const email = document.getElementById('admEmail').value;
    const pwd = document.getElementById('admPwd').value;
    // Attempt standard login first
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pwd });
    
    if(error) {
      alert("ç™»å…¥å¤±æ•—: " + error.message);
    } else {
      checkAuth();
    }
  };
  
  window.logout=async()=>{await supabase.auth.signOut();checkAuth();};
  window.wipeData=async()=>{const p=prompt("å¯†ç¢¼ï¼š");if(!p)return;const{error}=await supabase.auth.signInWithPassword({email:document.getElementById('admEmail').value,password:p});if(error)return alert('éŒ¯èª¤');const{error:d}=await supabase.from('visits').delete().neq('id',0);if(!d){alert('å·²æ¸…ç©º');fetchData();}};
  window.exportCSV=()=>{if(visits.length===0)return;const c=Papa.unparse(visits);const b=new Blob([c],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`data.csv`;a.click();};
  async function checkAuth(){
    const{data}=await supabase.auth.getSession();
    if(data.session) {
      document.body.classList.add('is-admin');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('adminActions').classList.remove('hidden');
    } else {
      document.body.classList.remove('is-admin');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminActions').classList.add('hidden');
    }
  }
</script>
</body>
</html>
