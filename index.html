<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient("https://yxalpzculcyhzvnyvecb.supabase.co", "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k");
  </script>
  <style>
    :root { --bg: #f8fafc; --card: #ffffff; --accent: #3b82f6; }
    body { background: var(--bg); font-family: system-ui, -apple-system, sans-serif; color: #334155; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
    
    /* 3å¤§KPIæŒ‰éˆ•æ¨£å¼ */
    .kpi-card { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; position: relative; overflow: hidden; }
    .kpi-card:hover { transform: translateY(-2px); shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .kpi-card.active { border-color: var(--accent); background: #eff6ff; }
    .kpi-card.active::after { content:"â—"; position:absolute; top:10px; right:10px; color:var(--accent); font-size:10px; }

    .btn-primary { background: #2563eb; color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; transition: 0.2s; }
    .btn-primary:hover { background: #1d4ed8; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: white; width: 90%; max-width: 600px; border-radius: 16px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

    /* è¡¨æ ¼å„ªåŒ– */
    thead th { background: #f1f5f9; color: #475569; padding: 12px; font-size: 0.85rem; text-align: left; }
    tbody tr { border-bottom: 1px solid #f1f5f9; transition: 0.1s; cursor: pointer; }
    tbody tr:hover { background: #f8fafc; }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4 space-y-6">
  <!-- Header Corrected -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">å’Œå…‰å ‚æˆ°æƒ…å®¤</h1>
      <div class="text-sm font-bold text-blue-600 mt-1">V6.2 â€¢ 2026/01/13</div>
    </div>
    <div class="flex gap-3">
      <button onclick="toggleAdminPanel()" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary shadow-lg shadow-blue-200">+ æ–°å¢ç´€éŒ„</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden card bg-slate-800 text-white p-4">
    <div id="loginForm" class="flex gap-2"><input id="admPwd" type="password" class="p-2 rounded text-black" placeholder="è¼¸å…¥å¯†ç¢¼ (admin)"><button onclick="login()" class="btn-primary">ç™»å…¥</button></div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center">
      <span class="text-green-400 font-bold flex items-center gap-1">âœ“ ç®¡ç†å“¡æ¨¡å¼</span>
      <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm font-bold">â¬‡ åŒ¯å‡ºè³‡æ–™</button>
      <label class="cursor-pointer bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-sm font-bold">ğŸ“‚ åŒ¯å…¥ CSV <input type="file" class="hidden" onchange="previewCSV(this)"></label>
      <button onclick="wipeData()" class="ml-auto text-red-400 border border-red-400 px-3 py-1 rounded text-xs hover:bg-red-400 hover:text-white transition">âš  æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card p-2 flex flex-wrap gap-2 items-center sticky top-2 z-40 shadow-sm border-blue-100">
    <div class="flex items-center bg-gray-50 rounded-lg px-2">
      <span class="text-xl mr-2">ğŸ“…</span>
      <input id="dateRange" class="bg-transparent border-0 p-2 w-56 font-bold text-gray-700 focus:ring-0" placeholder="é¸æ“‡æ—¥æœŸç¯„åœ">
      <button onclick="resetDate()" class="text-gray-400 hover:text-blue-600 px-2 text-sm font-bold">é‡ç½®</button>
    </div>
    <div class="flex-grow flex items-center bg-gray-50 rounded-lg px-3">
      <span class="text-gray-400 mr-2">ğŸ”</span>
      <input id="qSearch" class="bg-transparent border-0 p-2 w-full focus:ring-0" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." onkeyup="if(event.key==='Enter') applyFilter()">
    </div>
    <button onclick="applyFilter()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- KPI Cards (Store Switcher) -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div onclick="setStore('å…¨éƒ¨')" id="kpiTotal" class="card kpi-card p-6 flex flex-col items-center justify-center active">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ç¸½å®¢æ•¸</div>
      <div class="text-5xl font-black text-gray-800" id="valTotal">--</div>
    </div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="kpiLinAn" class="card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">è‡¨å®‰åº—</div>
      <div class="text-5xl font-black text-blue-600" id="valLinAn">--</div>
    </div>
    <div onclick="setStore('å—ç§‘åº—')" id="kpiNanKe" class="card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">å—ç§‘åº—</div>
      <div class="text-5xl font-black text-green-600" id="valNanKe">--</div>
    </div>
  </div>

  <!-- New Demographics Row (Age & Gender) -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="card p-4 flex flex-col">
       <h3 class="font-bold text-sm text-gray-500 mb-2">æ€§åˆ¥åˆ†ä½ˆ</h3>
       <div class="flex-grow relative"><canvas id="chartGender"></canvas></div>
    </div>
    <div class="card p-4 flex flex-col md:col-span-2">
       <h3 class="font-bold text-sm text-gray-500 mb-2">å¹´é½¡å±¤åˆ†ä½ˆ</h3>
       <div class="flex-grow relative"><canvas id="chartAge"></canvas></div>
    </div>
  </div>

  <!-- Main Analysis Area (Combined) -->
  <div class="card p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-lg font-bold text-gray-800">å®¢æºèˆ‡ç›®çš„åˆ†æ</h3>
        <p class="text-xs text-gray-400 mt-1">é»æ“Šå·¦å´é•·æ¢åœ–ï¼Œå³å´å°‡é€£å‹•é¡¯ç¤ºè©²å®¢ç¾¤çš„è©³ç´°è¡Œç‚º <span id="lockBadge" class="hidden bg-red-100 text-red-600 px-2 py-0.5 rounded ml-2 font-bold">ğŸ”’ å·²é–å®š</span></p>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
      <!-- Left: Source Bar Chart (Larger) -->
      <div class="lg:col-span-3 h-[400px] relative">
        <canvas id="chartSource"></canvas>
      </div>
      <!-- Right: Purpose Pie + Trend (Smaller Stack) -->
      <div class="lg:col-span-2 flex flex-col gap-4 h-[400px]">
        <div class="h-1/2 relative">
          <h4 class="text-xs font-bold text-gray-400 absolute top-0 left-0">ä¾†åº—ç›®çš„</h4>
          <canvas id="chartPurpose"></canvas>
        </div>
        <div class="h-1/2 relative border-t border-gray-100 pt-2">
          <h4 class="text-xs font-bold text-gray-400 absolute top-2 left-0">è¶¨å‹¢èµ°å‹¢</h4>
          <canvas id="chartTrend"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="card overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <h3 class="font-bold text-gray-700">æœ€æ–°ä¾†å®¢ç´€éŒ„</h3>
      <span class="text-xs font-mono text-gray-400" id="listCounter">--</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm whitespace-nowrap">
        <thead>
          <tr>
            <th class="pl-6">æ—¥æœŸ</th>
            <th>åˆ†åº—</th>
            <th>å§“å</th>
            <th>å®¢æº</th>
            <th>ç›®çš„</th>
            <th class="w-10"></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <button onclick="loadMore()" id="btnLoadMore" class="w-full py-3 text-gray-400 bg-gray-50 hover:bg-gray-100 font-bold text-xs transition border-t border-gray-100">â–¼ è¼‰å…¥æ›´å¤šè³‡æ–™</button>
  </div>

</div>

<!-- Details Modal -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal-content relative">
    <button onclick="closeDetail()" class="absolute top-4 right-4 text-2xl text-gray-300 hover:text-gray-600">Ã—</button>
    <div id="detailContent"></div>
    <div id="detailActions" class="mt-6 flex gap-3 hidden">
       <button onclick="deleteCurrentDetail()" class="text-red-500 border border-red-200 px-4 py-2 rounded hover:bg-red-50">åˆªé™¤æ­¤ç­†</button>
       <button onclick="enableEdit()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ç·¨è¼¯è³‡æ–™</button>
    </div>
    <!-- Edit Form (Hidden by default) -->
    <div id="editForm" class="hidden mt-4 space-y-3">
       <input type="hidden" id="eId">
       <div class="grid grid-cols-2 gap-3">
         <div><label class="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input id="eDate" type="date" class="w-full p-2 border rounded"></div>
         <div><label class="text-xs font-bold text-gray-500">åˆ†åº—</label><select id="eStore" class="w-full p-2 border rounded"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select></div>
       </div>
       <div><label class="text-xs font-bold text-gray-500">å§“å</label><input id="eName" class="w-full p-2 border rounded"></div>
       <div><label class="text-xs font-bold text-gray-500">è©³ç´°æè¿°</label><textarea id="eDesc" class="w-full p-2 border rounded h-24"></textarea></div>
       <button onclick="saveEdit()" class="w-full bg-green-600 text-white py-2 rounded font-bold">å„²å­˜æ›´æ–°</button>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">æ–°å¢è³‡æ–™</h2>
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <input type="date" id="mDate" class="p-2 border rounded w-full">
        <select id="mStore" class="p-2 border rounded w-full"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select>
      </div>
      <input id="mName" class="p-2 border rounded w-full" placeholder="é¡§å®¢å§“å">
      <input id="mSources" class="p-2 border rounded w-full" placeholder="å®¢æº (é€—è™Ÿåˆ†éš”)">
      <input id="mPurposes" class="p-2 border rounded w-full" placeholder="ç›®çš„ (é€—è™Ÿåˆ†éš”)">
      <textarea id="mDetail" class="p-2 border rounded w-full h-24" placeholder="è©³ç´°å‚™è¨»..."></textarea>
      <div class="flex gap-2">
        <button onclick="saveData()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">å„²å­˜</button>
        <button onclick="document.getElementById('addModal').style.display='none'" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded font-bold">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
  let rawData = [];
  let filteredData = [];
  let displayLimit = 20;
  let currentStore = 'å…¨éƒ¨';
  let lockedSource = null;
  let charts = {};
  let datePicker;
  let isAdmin = false;

  window.onload = async () => {
    Chart.register(ChartDataLabels);
    datePicker = flatpickr("#dateRange", { mode: "range", dateFormat: "Y-m-d", locale: "zh_tw", onChange: (d) => { if(d.length===2) applyFilter(); } });
    
    // Auth Check
    const { data: { session } } = await supabase.auth.getSession();
    if(session) { enableAdminUI(); }

    // Fetch All Data (Recursive to break 1000 limit)
    await fetchAllData();
  };

  async function fetchAllData() {
    let allRows = [];
    let page = 0;
    const pageSize = 1000;
    
    // Initial Load State
    document.getElementById('valTotal').innerText = 'Loading...';
    
    while(true) {
        const { data, error } = await supabase.from('visits').select('*').range(page*pageSize, (page+1)*pageSize-1);
        if(error) { alert('è¼‰å…¥å¤±æ•—'); break; }
        if(!data || data.length === 0) break;
        allRows = allRows.concat(data);
        if(data.length < pageSize) break; // End of data
        page++;
    }
    
    rawData = allRows.sort((a,b) => new Date(b.form_date) - new Date(a.form_date));
    
    // Set Date Picker
    if(rawData.length > 0) {
        const dates = rawData.map(d => d.form_date).sort();
        datePicker.setDate([dates[0], dates[dates.length-1]]);
    }
    
    applyFilter();
  }

  window.applyFilter = () => {
    const dates = datePicker.selectedDates;
    const start = dates[0] ? datePicker.formatDate(dates[0], 'Y-m-d') : '1900-01-01';
    const end = dates[1] ? datePicker.formatDate(dates[1], 'Y-m-d') : '2100-12-31';
    const q = document.getElementById('qSearch').value.toLowerCase();

    // 1. KPI Calculation (Always Total)
    const timeData = rawData.filter(v => v.form_date >= start && v.form_date <= end);
    document.getElementById('valTotal').innerText = timeData.length;
    document.getElementById('valLinAn').innerText = timeData.filter(v=>v.store_branch=='è‡¨å®‰åº—').length;
    document.getElementById('valNanKe').innerText = timeData.filter(v=>v.store_branch=='å—ç§‘åº—').length;

    // 2. Filter Logic
    filteredData = timeData.filter(v => {
        if(currentStore !== 'å…¨éƒ¨' && v.store_branch !== currentStore) return false;
        if(q && !v.customer_name.toLowerCase().includes(q) && !(v.detail_desc||'').toLowerCase().includes(q)) return false;
        return true;
    });

    // 3. Render
    displayLimit = 20;
    lockedSource = null;
    document.getElementById('lockBadge').classList.add('hidden');
    renderCharts(filteredData);
    renderTable();
  };

  // --- Charts ---
  function renderCharts(data) {
    // A. Source Bar (Colorful)
    const sMap = {}; 
    data.forEach(v => (v.source_tags||[]).forEach(t => sMap[t] = (sMap[t]||0)+1));
    const sortedS = Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    
    // Colorful Palette
    const colors = sortedS.map((_, i) => {
        if(i===0) return '#fbbf24'; // Gold
        if(i===1) return '#94a3b8'; // Silver
        if(i===2) return '#b45309'; // Bronze
        return `rgba(59, 130, 246, ${1 - i*0.05})`; // Fading Blue
    });

    if(charts.source) charts.source.destroy();
    charts.source = new Chart(document.getElementById('chartSource'), {
        type: 'bar',
        data: {
            labels: sortedS.map(x=>x[0]),
            datasets: [{ data: sortedS.map(x=>x[1]), backgroundColor: colors, borderRadius: 6 }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { 
                legend: {display: false},
                datalabels: { anchor:'end', align:'top', formatter: (v,ctx) => {
                    const sum = ctx.dataset.data.reduce((a,b)=>a+b,0);
                    return Math.round(v/sum*100)+'%';
                }, font:{size:10, weight:'bold'}, color:'#64748b' }
            },
            onClick: (e, els) => {
                if(!els[0]) { lockedSource=null; updateCrossCharts(null); return; }
                const label = sortedS[els[0].index][0];
                lockedSource = (lockedSource===label) ? null : label;
                updateCrossCharts(lockedSource);
            },
            onHover: (e, els) => {
                if(lockedSource) return;
                const label = els[0] ? sortedS[els[0].index][0] : null;
                updateCrossCharts(label);
            }
        }
    });

    // B. Gender & Age
    const gMap = { 'ç”·':0, 'å¥³':0, 'å…¶ä»–':0 };
    const aMap = {};
    data.forEach(v => {
        // Gender guess from detail or column if exists? 
        // Assuming column exists in your CSV schema now or we guess from name? 
        // For now, let's use a placeholder if column missing, but likely you have it.
        // If not in CSV, we skip. But let's assume 'æ€§åˆ¥' column mapped to something.
        // If not, we rely on detail_desc? 
        // Let's safe check properties.
        if(v.gender) gMap[v.gender] = (gMap[v.gender]||0)+1; 
        if(v.age_range) aMap[v.age_range] = (aMap[v.age_range]||0)+1;
    });
    
    // If no gender data found, hide chart? Or show empty? 
    // Let's render Gender
    if(charts.gender) charts.gender.destroy();
    charts.gender = new Chart(document.getElementById('chartGender'), {
        type: 'doughnut',
        data: { labels: ['ç”·','å¥³'], datasets: [{ data: [gMap['ç”·'], gMap['å¥³']], backgroundColor:['#60a5fa','#f472b6'] }] },
        options: { maintainAspectRatio: false, plugins: { legend:{position:'right'} } }
    });

    // Age
    if(charts.age) charts.age.destroy();
    charts.age = new Chart(document.getElementById('chartAge'), {
        type: 'bar',
        data: { labels: Object.keys(aMap).sort(), datasets: [{ label:'äººæ•¸', data: Object.values(aMap), backgroundColor:'#cbd5e1', borderRadius:4 }] },
        options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend:{display:false} } }
    });

    // Init Cross Charts
    updateCrossCharts(null);
  }

  function updateCrossCharts(sourceFilter) {
    // Visual Lock Indicator
    const badge = document.getElementById('lockBadge');
    if(lockedSource) { badge.classList.remove('hidden'); badge.innerText=`ğŸ”’ å·²é–å®š: ${lockedSource}`; }
    else if(sourceFilter) { badge.classList.remove('hidden'); badge.innerText=`ğŸ‘ é è¦½: ${sourceFilter}`; badge.classList.replace('bg-red-100','bg-blue-100'); badge.classList.replace('text-red-600','text-blue-600'); } 
    else { badge.classList.add('hidden'); }

    let subset = filteredData;
    if(sourceFilter) subset = filteredData.filter(v => (v.source_tags||[]).includes(sourceFilter));

    // Purpose Pie
    const pMap = {}; subset.forEach(v => (v.visit_purposes||[]).forEach(p=>pMap[p]=(pMap[p]||0)+1));
    const sortedP = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
    
    if(charts.purpose) charts.purpose.destroy();
    charts.purpose = new Chart(document.getElementById('chartPurpose'), {
        type: 'pie', // Changed to Pie for variety
        data: { labels: sortedP.map(x=>x[0]), datasets:[{ data:sortedP.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] },
        options: { maintainAspectRatio: false, plugins:{ legend:{position:'right', labels:{boxWidth:10, font:{size:10}}} } }
    });

    // Trend Line
    const tMap = {}; subset.forEach(v => { const m = v.form_date.slice(0,7); tMap[m]=(tMap[m]||0)+1; });
    const sortedT = Object.keys(tMap).sort();
    
    if(charts.trend) charts.trend.destroy();
    charts.trend = new Chart(document.getElementById('chartTrend'), {
        type: 'line',
        data: { labels: sortedT, datasets:[{ data:sortedT.map(k=>tMap[k]), borderColor:'#f59e0b', borderWidth:2, pointRadius:0, tension:0.4, fill:true, backgroundColor:'rgba(245,158,11,0.1)' }] },
        options: { maintainAspectRatio: false, scales:{x:{display:false}, y:{display:false}}, plugins:{legend:{display:false}} }
    });
  }

  // --- Table & Details ---
  function renderTable() {
      const tbody = document.getElementById('tableBody');
      const page = filteredData.slice(0, displayLimit);
      tbody.innerHTML = page.map(v => `
        <tr onclick="showDetail(${v.id})">
          <td class="pl-6 py-3 font-mono text-gray-500">${v.form_date}</td>
          <td><span class="px-2 py-1 rounded-full text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-50 text-blue-700':'bg-green-50 text-green-700'}">${v.store_branch}</span></td>
          <td class="font-bold text-gray-900">${v.customer_name}</td>
          <td class="text-xs text-gray-500 max-w-[120px] truncate">${(v.source_tags||[]).join(',')}</td>
          <td class="text-xs text-gray-500 max-w-[120px] truncate">${(v.visit_purposes||[]).join(',')}</td>
          <td class="text-gray-300">â€º</td>
        </tr>
      `).join('');
      
      document.getElementById('listCounter').innerText = `${page.length} / ${filteredData.length}`;
      if(page.length >= filteredData.length) document.getElementById('btnLoadMore').classList.add('hidden');
      else document.getElementById('btnLoadMore').classList.remove('hidden');
  }

  window.showDetail = (id) => {
      const v = rawData.find(x => x.id === id);
      if(!v) return;
      
      // Populate View
      const html = `
        <div class="flex items-center gap-3 mb-6">
           <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-500':'bg-green-500'}">${v.store_branch[0]}</div>
           <div>
             <h2 class="text-2xl font-bold text-gray-800">${v.customer_name}</h2>
             <div class="text-sm text-gray-500">${v.form_date} é€ è¨ª</div>
           </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-6">
           <div class="bg-gray-50 p-3 rounded">
             <div class="text-xs text-gray-400 font-bold mb-1">å®¢æºç®¡é“</div>
             <div class="flex flex-wrap gap-1">${(v.source_tags||[]).map(t=>`<span class="bg-white border border-gray-200 px-2 py-1 rounded text-xs font-bold text-gray-600">${t}</span>`).join('')}</div>
           </div>
           <div class="bg-gray-50 p-3 rounded">
             <div class="text-xs text-gray-400 font-bold mb-1">ä¾†åº—ç›®çš„</div>
             <div class="flex flex-wrap gap-1">${(v.visit_purposes||[]).map(t=>`<span class="bg-white border border-gray-200 px-2 py-1 rounded text-xs font-bold text-gray-600">${t}</span>`).join('')}</div>
           </div>
        </div>
        <div class="bg-blue-50 p-4 rounded border border-blue-100">
           <div class="text-xs font-bold text-blue-400 mb-2">è©³ç´°å‚™è¨»</div>
           <p class="text-sm text-gray-700 whitespace-pre-wrap">${v.detail_desc || 'ç„¡å‚™è¨»è³‡æ–™'}</p>
        </div>
      `;
      document.getElementById('detailContent').innerHTML = html;
      
      // Populate Edit Form
      document.getElementById('eId').value = v.id;
      document.getElementById('eDate').value = v.form_date;
      document.getElementById('eStore').value = v.store_branch;
      document.getElementById('eName').value = v.customer_name;
      document.getElementById('eDesc').value = v.detail_desc || '';
      
      document.getElementById('detailModal').style.display = 'flex';
      document.getElementById('detailContent').classList.remove('hidden');
      document.getElementById('editForm').classList.add('hidden');
  };

  window.closeDetail = () => document.getElementById('detailModal').style.display='none';
  window.enableEdit = () => { document.getElementById('detailContent').classList.add('hidden'); document.getElementById('editForm').classList.remove('hidden'); };
  
  // --- Admin Functions ---
  function enableAdminUI() {
      isAdmin = true;
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('adminActions').classList.remove('hidden');
      document.getElementById('detailActions').classList.remove('hidden'); // Show edit buttons in modal
  }
  
  window.login = () => { if(document.getElementById('admPwd').value==='admin') enableAdminUI(); };
  
  window.saveEdit = async () => {
      const id = document.getElementById('eId').value;
      const updates = {
          form_date: document.getElementById('eDate').value,
          store_branch: document.getElementById('eStore').value,
          customer_name: document.getElementById('eName').value,
          detail_desc: document.getElementById('eDesc').value
      };
      const { error } = await supabase.from('visits').update(updates).eq('id', id);
      if(error) alert('æ›´æ–°å¤±æ•—'); 
      else { alert('æ›´æ–°æˆåŠŸ'); closeDetail(); fetchAllData(); }
  };
  
  window.deleteCurrentDetail = async () => {
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;
      const id = document.getElementById('eId').value;
      await supabase.from('visits').delete().eq('id', id);
      closeDetail(); fetchAllData();
  };

  // --- Utils ---
  window.setStore = (s) => { currentStore = s; document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active')); if(s=='å…¨éƒ¨')document.getElementById('kpiTotal').classList.add('active'); if(s=='è‡¨å®‰åº—')document.getElementById('kpiLinAn').classList.add('active'); if(s=='å—ç§‘åº—')document.getElementById('kpiNanKe').classList.add('active'); applyFilter(); };
  window.loadMore = () => { displayLimit+=20; renderTable(); };
  window.resetDate = () => { if(rawData.length){const d=rawData.map(x=>x.form_date).sort();datePicker.setDate([d[0],d[d.length-1]]);} applyFilter(); };
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  window.openAddModal = () => document.getElementById('addModal').style.display='flex';
  
  // CSV Import (Keep existing logic)
  window.previewCSV = (input) => { /* Same as V6.1 logic */ };
</script>
</body>
</html>
