<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V7.2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient("https://yxalpzculcyhzvnyvecb.supabase.co", "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k");
  </script>
  <style>
    :root { --bg: #f3f4f6; --card-bg: rgba(255, 255, 255, 0.85); --accent: #3b82f6; }
    body { background: var(--bg); font-family: system-ui, -apple-system, sans-serif; color: #1e293b; }
    
    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    .kpi-card { cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 2px solid transparent; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
    .kpi-card.active { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border-color: var(--accent); }
    .kpi-card.active::after { content:"â—"; position:absolute; top:12px; right:12px; color:var(--accent); font-size:8px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    #hoverPreview {
        position: fixed; pointer-events: none; z-index: 9999;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px);
        border: 1px solid #fbbf24; border-left: 4px solid #fbbf24;
        padding: 12px; border-radius: 8px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        max-width: 320px; font-size: 0.9rem; color: #374151; line-height: 1.5;
        display: none; transition: opacity 0.1s;
    }

    thead th { background: #fef9c3; color: #000; padding: 14px; font-weight: 800; border-bottom: 2px solid #fde047; font-size: 0.9rem; }
    tbody tr { border-bottom: 1px solid #f1f5f9; transition: 0.15s; cursor: pointer; }
    tbody tr:hover { background: #fefce8; transform: scale-[1.005]; }

    .btn-primary { background: var(--accent); color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); transition: 0.2s; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }

    /* Import Process Overlay */
    #importOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; }
    .progress-bar { width: 300px; height: 10px; background: #334155; border-radius: 5px; overflow: hidden; margin-top: 15px; }
    .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.2s; }
  </style>
</head>
<body>

<!-- Hover Tooltip -->
<div id="hoverPreview"></div>

<!-- Import Progress Overlay -->
<div id="importOverlay">
  <div class="text-2xl font-bold mb-2">è³‡æ–™åŒ¯å…¥ä¸­...</div>
  <div id="importStatus" class="text-sm text-gray-400">æ­£åœ¨æº–å‚™...</div>
  <div class="progress-bar"><div id="importProgress" class="progress-fill"></div></div>
  <div id="importErrors" class="mt-4 text-xs text-red-400 max-h-40 overflow-y-auto w-[90%] max-w-md bg-slate-800 p-2 rounded hidden"></div>
</div>

<div class="max-w-7xl mx-auto p-4 space-y-6">
  
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight flex items-center gap-3">
        ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤
        <div class="leading-tight text-right ml-2 pl-2 border-l border-slate-300">
          <div class="text-sm font-bold text-slate-600">V7.2</div>
          <div class="text-[10px] font-mono text-slate-400 font-bold" id="currentDateDisp">--</div>
        </div>
      </h1>
    </div>
    <div class="flex gap-3">
      <button onclick="toggleAdminPanel()" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden glass-card bg-slate-900 text-white p-4 border-slate-700">
    <div id="loginForm" class="flex gap-2"><input id="admPwd" type="password" class="p-2 rounded text-black" placeholder="è¼¸å…¥å¯†ç¢¼ (admin)"><button onclick="login()" class="btn-primary">ç™»å…¥</button></div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center">
      <span class="text-green-400 font-bold">âœ“ ç®¡ç†å“¡æ¨¡å¼</span>
      <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm font-bold">â¬‡ åŒ¯å‡ºè³‡æ–™</button>
      <label class="cursor-pointer bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-sm font-bold">ğŸ“‚ åŒ¯å…¥ CSV (V7.2) <input type="file" class="hidden" onchange="previewCSV(this)"></label>
      <button onclick="wipeData()" class="ml-auto text-red-400 border border-red-400 px-3 py-1 rounded text-xs hover:bg-red-900 hover:text-white transition">âš  æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="glass-card p-2 flex flex-wrap gap-2 items-center sticky top-2 z-40 shadow-lg border-blue-200/50">
    <div class="flex items-center bg-white/50 rounded-lg px-2 border border-slate-100">
      <span class="text-xl mr-2">ğŸ“…</span>
      <!-- Quick Selectors -->
      <select id="selYear" class="bg-transparent text-sm font-bold border-0 focus:ring-0 cursor-pointer text-slate-600 p-1 mr-1" onchange="quickSelectDate()"></select>
      <span class="text-slate-300">/</span>
      <select id="selMonth" class="bg-transparent text-sm font-bold border-0 focus:ring-0 cursor-pointer text-slate-600 p-1 mr-2" onchange="quickSelectDate()">
         <option value="">æœˆä»½</option>
         <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option>
         <option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option>
         <option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
      </select>
      <!-- Date Picker (Hidden) -->
      <input id="dateRange" class="bg-transparent border-0 p-2 w-32 text-xs text-slate-400 focus:ring-0 text-right opacity-50" placeholder="è‡ªè¨‚ç¯„åœ" readonly>
      <button onclick="resetDate()" class="text-blue-600 hover:text-blue-800 px-2 text-sm font-bold border-l border-slate-200 ml-2">é‡ç½®å…¨éƒ¨</button>
    </div>
    <div class="flex-grow flex items-center bg-white/50 rounded-lg px-3 border border-slate-100 relative">
      <span class="text-gray-400 mr-2">ğŸ”</span>
      <input id="qSearch" class="bg-transparent border-0 p-2 w-full focus:ring-0" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." onkeyup="if(event.key==='Enter') applyFilter()">
      <button onclick="clearSearch()" id="btnX" class="hidden absolute right-3 text-gray-400 hover:text-red-500 font-bold">âœ•</button>
    </div>
    <button onclick="applyFilter()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div onclick="setStore('å…¨éƒ¨')" id="kpiTotal" class="glass-card kpi-card p-6 flex flex-col items-center justify-center active">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ç¸½å®¢æ•¸</div>
      <div class="text-5xl font-black text-slate-800" id="valTotal">--</div>
    </div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="kpiLinAn" class="glass-card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">è‡¨å®‰åº—</div>
      <div class="text-5xl font-black text-blue-600" id="valLinAn">--</div>
    </div>
    <div onclick="setStore('å—ç§‘åº—')" id="kpiNanKe" class="glass-card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">å—ç§‘åº—</div>
      <div class="text-5xl font-black text-green-600" id="valNanKe">--</div>
    </div>
  </div>

  <!-- Main Analysis Area -->
  <div class="glass-card p-6">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h3 class="text-xl font-bold text-slate-800">å®¢æºèˆ‡ç›®çš„åˆ†æ</h3>
        <p class="text-xs text-slate-400 mt-1 flex items-center gap-2">
          é»æ“Šå·¦å´é•·æ¢åœ–å¯é–å®šåˆ†æ
          <span id="lockBadge" class="hidden px-2 py-0.5 rounded text-xs font-bold transition-all"></span>
        </p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
      <!-- Left: Source Bar -->
      <div class="lg:col-span-3 h-[450px] relative">
        <canvas id="chartSource"></canvas>
      </div>
      
      <!-- Right: Big Pie -->
      <div class="lg:col-span-2 h-[450px] relative flex flex-col items-center justify-center">
        <h4 class="absolute top-0 left-0 text-xs font-bold text-slate-400">ä¾†åº—ç›®çš„ä½”æ¯”</h4>
        <div class="w-full h-full relative">
          <canvas id="chartPurpose"></canvas>
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="text-center">
              <div class="text-xs text-slate-400 font-bold">TOP 1</div>
              <div class="text-2xl font-black text-slate-700" id="topPurposeVal">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom: Trend -->
    <div class="mt-8 border-t border-slate-100 pt-6">
      <h4 class="text-xs font-bold text-slate-400 mb-4">å®¢æµé‡è¶¨å‹¢èµ°å‹¢</h4>
      <div class="h-[200px] relative">
        <canvas id="chartTrend"></canvas>
      </div>
    </div>
  </div>

  <!-- Demographics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="glass-card p-6 flex flex-col">
       <h3 class="font-bold text-sm text-slate-500 mb-4">æ€§åˆ¥åˆ†ä½ˆ <span id="demoFilterBadge" class="text-xs font-normal text-blue-500 ml-2"></span></h3>
       <div class="flex-grow relative"><canvas id="chartGender"></canvas></div>
    </div>
    <div class="glass-card p-6 flex flex-col md:col-span-2">
       <h3 class="font-bold text-sm text-slate-500 mb-4">å¹´é½¡å±¤åˆ†ä½ˆ <span id="demoFilterBadge2" class="text-xs font-normal text-blue-500 ml-2"></span></h3>
       <div class="flex-grow relative"><canvas id="chartAge"></canvas></div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="glass-card overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white/50">
      <h3 class="font-bold text-slate-700">æœ€æ–°é¡§å®¢è³‡æ–™</h3>
      <span class="text-xs font-mono text-slate-400" id="listCounter">--</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm whitespace-nowrap">
        <thead><tr><th class="pl-6">æ—¥æœŸ</th><th>åˆ†åº—</th><th>å§“å</th><th>æ€§åˆ¥/å¹´é½¡</th><th>å®¢æº</th><th>ç›®çš„</th><th class="w-10"></th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <button onclick="loadMore()" id="btnLoadMore" class="w-full py-4 text-slate-400 bg-slate-50 hover:bg-slate-100 font-bold text-xs transition border-t border-slate-100">â–¼ è¼‰å…¥æ›´å¤šè³‡æ–™</button>
  </div>
</div>

<!-- Modals -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal-content relative animate-fade-in-up">
    <button onclick="closeDetail()" class="absolute top-4 right-4 text-2xl text-slate-300 hover:text-slate-600">Ã—</button>
    <div id="detailContent"></div>
    <div id="detailActions" class="mt-6 flex gap-3 hidden border-t pt-4">
       <button onclick="deleteCurrentDetail()" class="text-red-500 border border-red-200 px-4 py-2 rounded hover:bg-red-50 font-bold text-sm">åˆªé™¤æ­¤ç­†</button>
       <button onclick="enableEdit()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold text-sm ml-auto">ç·¨è¼¯è³‡æ–™</button>
    </div>
    <div id="editForm" class="hidden mt-4 space-y-3">
       <input type="hidden" id="eId">
       <div class="grid grid-cols-2 gap-3">
         <div><label class="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input id="eDate" type="date" class="w-full p-2 border rounded"></div>
         <div><label class="text-xs font-bold text-gray-500">åˆ†åº—</label><select id="eStore" class="w-full p-2 border rounded"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select></div>
       </div>
       <div class="grid grid-cols-2 gap-3">
         <div><label class="text-xs font-bold text-gray-500">å§“å</label><input id="eName" class="w-full p-2 border rounded"></div>
         <div><label class="text-xs font-bold text-gray-500">æ€§åˆ¥</label><select id="eGender" class="w-full p-2 border rounded"><option value="">æœªå¡«</option><option>ç”·</option><option>å¥³</option></select></div>
       </div>
       <div><label class="text-xs font-bold text-gray-500">è©³ç´°æè¿°</label><textarea id="eDesc" class="w-full p-2 border rounded h-24"></textarea></div>
       <button onclick="saveEdit()" class="w-full bg-green-600 text-white py-2 rounded font-bold">å„²å­˜æ›´æ–°</button>
    </div>
  </div>
</div>

<div id="addModal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">æ–°å¢è³‡æ–™</h2>
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <input type="date" id="mDate" class="p-2 border rounded w-full">
        <select id="mStore" class="p-2 border rounded w-full"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select>
      </div>
      <div class="grid grid-cols-2 gap-3">
         <input id="mName" class="p-2 border rounded w-full" placeholder="é¡§å®¢å§“å">
         <select id="mGender" class="p-2 border rounded w-full"><option value="">æ€§åˆ¥...</option><option>ç”·</option><option>å¥³</option></select>
      </div>
      <input id="mSources" class="p-2 border rounded w-full" placeholder="å®¢æº (é€—è™Ÿåˆ†éš”)">
      <input id="mPurposes" class="p-2 border rounded w-full" placeholder="ç›®çš„ (é€—è™Ÿåˆ†éš”)">
      <textarea id="mDetail" class="p-2 border rounded w-full h-24" placeholder="è©³ç´°å‚™è¨»..."></textarea>
      <div class="flex gap-2 pt-2">
        <button onclick="saveData()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">å„²å­˜</button>
        <button onclick="document.getElementById('addModal').style.display='none'" class="flex-1 bg-slate-100 text-slate-500 py-2 rounded font-bold">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
  let rawData = [];
  let filteredData = [];
  let displayLimit = 20;
  let currentStore = 'å…¨éƒ¨';
  let lockedSource = null;
  let charts = {};
  let datePicker;
  let isAdmin = false;

  window.onload = async () => {
    Chart.register(ChartDataLabels);
    
    // Header Date
    document.getElementById('currentDateDisp').innerText = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});

    flatpickr.l10ns.default.months.longhand = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    
    datePicker = flatpickr("#dateRange", { 
        mode: "range", dateFormat: "Y-m-d", locale: "zh_tw", monthSelectorType: 'static',
        onChange: (d) => { if(d.length===2) applyFilter(); }
    });

    document.getElementById('qSearch').addEventListener('input', function() {
        this.value ? document.getElementById('btnX').classList.remove('hidden') : document.getElementById('btnX').classList.add('hidden');
    });

    const { data: { session } } = await supabase.auth.getSession();
    if(session) enableAdminUI();

    await fetchAllData();
  };

  window.quickSelectDate = () => {
      const y = document.getElementById('selYear').value;
      const m = document.getElementById('selMonth').value;
      if(y && m) {
          const start = new Date(y, m-1, 1);
          const end = new Date(y, m, 0); 
          datePicker.setDate([start, end]);
          applyFilter();
      }
  };

  window.resetDate = () => {
      if(rawData.length > 0) {
          const dates = rawData.map(d => d.form_date).sort();
          datePicker.setDate([dates[0], dates[dates.length-1]]);
      }
      document.getElementById('selMonth').value = "";
      applyFilter();
  };
  
  window.clearSearch = () => { document.getElementById('qSearch').value = ''; document.getElementById('btnX').classList.add('hidden'); applyFilter(); };

  async function fetchAllData() {
    let allRows = []; let page = 0; const pageSize = 1000;
    document.getElementById('valTotal').innerText = '...';
    while(true) {
        const { data, error } = await supabase.from('visits').select('*').range(page*pageSize, (page+1)*pageSize-1);
        if(error || !data || data.length === 0) break;
        allRows = allRows.concat(data);
        if(data.length < pageSize) break;
        page++;
    }
    rawData = allRows.sort((a,b) => new Date(b.form_date) - new Date(a.form_date));
    
    if(rawData.length > 0) {
        const years = [...new Set(rawData.map(d => d.form_date.slice(0,4)))].sort().reverse();
        const ySel = document.getElementById('selYear');
        ySel.innerHTML = '<option value="">å¹´ä»½</option>' + years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
        const dates = rawData.map(d => d.form_date).sort();
        datePicker.setDate([dates[0], dates[dates.length-1]]);
    }
    applyFilter();
  }

  // --- Filter Logic ---
  window.applyFilter = () => {
    const dates = datePicker.selectedDates;
    const start = dates[0] ? datePicker.formatDate(dates[0], 'Y-m-d') : '1900-01-01';
    const end = dates[1] ? datePicker.formatDate(dates[1], 'Y-m-d') : '2100-12-31';
    const q = document.getElementById('qSearch').value.toLowerCase();

    const timeData = rawData.filter(v => v.form_date >= start && v.form_date <= end);
    document.getElementById('valTotal').innerText = timeData.length;
    document.getElementById('valLinAn').innerText = timeData.filter(v=>v.store_branch=='è‡¨å®‰åº—').length;
    document.getElementById('valNanKe').innerText = timeData.filter(v=>v.store_branch=='å—ç§‘åº—').length;

    filteredData = timeData.filter(v => {
        if(currentStore !== 'å…¨éƒ¨' && v.store_branch !== currentStore) return false;
        if(q && !v.customer_name.toLowerCase().includes(q) && !(v.detail_desc||'').toLowerCase().includes(q)) return false;
        return true;
    });

    displayLimit = 20; 
    renderCharts(filteredData); 
    renderTable();
    updateLockBadge();
  };

  // --- Charts ---
  function renderCharts(data) {
    // 1. Source Bar
    const sMap = {}; data.forEach(v => (v.source_tags||[]).forEach(t => sMap[t] = (sMap[t]||0)+1));
    const sortedS = Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    const colors = sortedS.map((_, i) => (i<3 ? ['#fbbf24','#94a3b8','#b45309'][i] : `rgba(59, 130, 246, ${1 - i*0.05})`));

    if(charts.source) charts.source.destroy();
    charts.source = new Chart(document.getElementById('chartSource'), {
        type: 'bar',
        data: { labels: sortedS.map(x=>x[0]), datasets: [{ data: sortedS.map(x=>x[1]), backgroundColor: colors, borderRadius: 6 }] },
        options: {
            maintainAspectRatio: false,
            plugins: { 
                legend: {display: false},
                datalabels: { anchor:'end', align:'top', formatter: (v,ctx) => Math.round(v/ctx.dataset.data.reduce((a,b)=>a+b,0)*100)+'%', font:{size:10, weight:'bold'}, color:'#64748b' }
            },
            onClick: (e, els) => { if(els[0]) { const label=sortedS[els[0].index][0]; lockedSource=(lockedSource===label)?null:label; updateLockBadge(); updateCrossCharts(lockedSource); } },
            onHover: (e, els) => { if(!lockedSource) updateCrossCharts(els[0] ? sortedS[els[0].index][0] : null); }
        }
    });

    updateCrossCharts(lockedSource);
  }

  function updateCrossCharts(sourceFilter) {
    let subset = filteredData;
    const badge1 = document.getElementById('demoFilterBadge');
    const badge2 = document.getElementById('demoFilterBadge2');
    
    if(sourceFilter) {
        subset = filteredData.filter(v => (v.source_tags||[]).includes(sourceFilter));
        badge1.innerText = badge2.innerText = `(${sourceFilter})`;
    } else {
        badge1.innerText = badge2.innerText = '';
    }

    // Purpose - Big Doughnut with Percentage in Legend
    const pMap = {}; subset.forEach(v => (v.visit_purposes||[]).forEach(p=>pMap[p]=(pMap[p]||0)+1));
    const sortedP = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
    const totalP = sortedP.reduce((a,b)=>a+b[1],0);
    
    document.getElementById('topPurposeVal').innerText = sortedP.length ? sortedP[0][0] : '--';

    if(charts.purpose) charts.purpose.destroy();
    charts.purpose = new Chart(document.getElementById('chartPurpose'), {
        type: 'doughnut',
        data: { 
            labels: sortedP.map(x=>x[0]), 
            datasets:[{ 
                data:sortedP.map(x=>x[1]), 
                backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'],
                borderWidth: 0,
                hoverOffset: 10
            }] 
        },
        options: { 
            maintainAspectRatio: false, cutout: '60%',
            layout: { padding: 20 },
            plugins:{ 
                legend:{
                    display: true, position: 'right', 
                    labels:{
                        boxWidth:12, usePointStyle:true,
                        generateLabels: (chart) => {
                             const data = chart.data;
                             return data.labels.map((label, i) => {
                                 const val = data.datasets[0].data[i];
                                 const pct = totalP ? Math.round(val/totalP*100) : 0;
                                 return { text: `${label} (${pct}%)`, fillStyle: data.datasets[0].backgroundColor[i], hidden: false, index: i };
                             });
                        }
                    }
                }, 
                datalabels: { display: false },
                tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${ctx.raw} (${Math.round(ctx.raw/totalP*100)}%)` } }
            } 
        }
    });

    // Trend
    const tMap = {}; subset.forEach(v => { const m = v.form_date.slice(0,7); tMap[m]=(tMap[m]||0)+1; });
    const sortedT = Object.keys(tMap).sort();
    
    if(charts.trend) charts.trend.destroy();
    charts.trend = new Chart(document.getElementById('chartTrend'), {
        type: 'line',
        data: { labels: sortedT, datasets:[{ data:sortedT.map(k=>tMap[k]), borderColor:'#f59e0b', borderWidth:3, pointBackgroundColor:'#fff', pointBorderColor:'#f59e0b', pointRadius:4, tension:0.4, fill:true, backgroundColor:'rgba(245,158,11,0.1)' }] },
        options: { maintainAspectRatio: false, scales:{x:{grid:{display:false}}, y:{grid:{borderDash:[5,5]}}}, plugins:{legend:{display:false}} }
    });
    
    // Demographics - Synced
    const gMap = { 'ç”·':0, 'å¥³':0, 'å…¶ä»–':0 }; const aMap = {};
    subset.forEach(v => {
        const g = v.gender || 'å…¶ä»–';
        const a = v.age_range || 'æœªå¡«';
        if(gMap.hasOwnProperty(g)) gMap[g]++; else gMap['å…¶ä»–']++;
        if(a!=='æœªå¡«') aMap[a] = (aMap[a]||0)+1;
    });
    
    if(charts.gender) charts.gender.destroy();
    charts.gender = new Chart(document.getElementById('chartGender'), {
        type: 'doughnut',
        data: { labels: ['ç”·','å¥³'], datasets: [{ data: [gMap['ç”·'], gMap['å¥³']], backgroundColor:['#60a5fa','#f472b6'] }] },
        options: { maintainAspectRatio: false, plugins: { legend:{position:'right'} } }
    });

    if(charts.age) charts.age.destroy();
    charts.age = new Chart(document.getElementById('chartAge'), {
        type: 'bar',
        data: { labels: Object.keys(aMap).sort(), datasets: [{ label:'äººæ•¸', data: Object.values(aMap), backgroundColor:'#cbd5e1', borderRadius:4 }] },
        options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend:{display:false} } }
    });
  }

  function updateLockBadge() {
     const badge = document.getElementById('lockBadge');
     if(lockedSource) {
         badge.classList.remove('hidden'); badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600 animate-pulse';
         badge.innerText = `ğŸ”’ å·²é–å®š: ${lockedSource}`;
     } else {
         badge.classList.add('hidden');
     }
  }

  // --- Table (Event Listener Fix) ---
  function renderTable() {
      const tbody = document.getElementById('tableBody');
      const page = filteredData.slice(0, displayLimit);
      tbody.innerHTML = '';
      
      page.forEach(v => {
          const tr = document.createElement('tr');
          const safeDesc = (v.detail_desc||'').replace(/'/g, "\\'").replace(/\n/g, ' ');
          
          tr.dataset.id = v.id;
          
          tr.innerHTML = `
             <td class="pl-6 py-3 font-mono text-slate-500 pointer-events-none">${v.form_date}</td>
             <td class="pointer-events-none"><span class="px-2 py-1 rounded-full text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${v.store_branch}</span></td>
             <td class="font-bold text-slate-800 pointer-events-none">${v.customer_name}</td>
             <td class="text-xs text-slate-500 pointer-events-none">${v.gender||'-'} / ${v.age_range||'-'}</td>
             <td class="text-xs text-slate-500 max-w-[120px] truncate pointer-events-none">${(v.source_tags||[]).join(',')}</td>
             <td class="text-xs text-slate-500 max-w-[120px] truncate pointer-events-none">${(v.visit_purposes||[]).join(',')}</td>
             <td class="text-slate-300">â€º</td>
          `;
          
          tr.addEventListener('click', () => showDetail(v.id));
          tr.addEventListener('mouseenter', (e) => showPreview(e, safeDesc));
          tr.addEventListener('mouseleave', hidePreview);
          
          tbody.appendChild(tr);
      });
      
      document.getElementById('listCounter').innerText = `${page.length} / ${filteredData.length}`;
      if(page.length >= filteredData.length) document.getElementById('btnLoadMore').classList.add('hidden');
      else document.getElementById('btnLoadMore').classList.remove('hidden');
  }

  window.showPreview = (e, text) => {
      if(!text || text === 'null') return;
      const tooltip = document.getElementById('hoverPreview');
      tooltip.innerText = text.length > 100 ? text.slice(0,100)+'...' : text;
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
  };
  window.hidePreview = () => document.getElementById('hoverPreview').style.display = 'none';

  // --- CSV Import ---
  window.previewCSV = (input) => {
    const f = input.files[0];
    Papa.parse(f, { header:true, skipEmptyLines:true, complete: async (res) => {
       const total = res.data.length;
       if(!confirm(`å³å°‡åŒ¯å…¥ ${total} ç­†è³‡æ–™åˆ° V7.2 è³‡æ–™åº«?`)) return;
       
       const overlay = document.getElementById('importOverlay');
       const progress = document.getElementById('importProgress');
       const status = document.getElementById('importStatus');
       const errLog = document.getElementById('importErrors');
       overlay.style.display = 'flex';
       errLog.innerHTML = ''; errLog.classList.add('hidden');
       
       const cleanData = res.data.map(row => {
          let d = row['form_date']||row['å¡«è¡¨æ—¥æœŸ']; 
          if(!d) return null;
          d = d.replace(/\//g, '-');
          
          const n = row['customer_name']||row['é¡§å®¢å§“å'];
          if(!n) return null;
          
          let sRaw = row['source_tags']||row['ä¾†æºçµ±è¨ˆ']||'';
          sRaw = sRaw.replace(/ï¼Œ/g, ',').replace(/ã€/g, ','); 
          
          let pRaw = row['visit_purposes']||row['ä¾†åº—ç›®çš„']||'';
          pRaw = pRaw.replace(/ï¼Œ/g, ',').replace(/ã€/g, ',');

          return { 
              p_date: d, 
              p_store: row['store_branch']||row['é–€åº—']||'è‡¨å®‰åº—', 
              p_name: n, 
              p_gender: row['gender']||row['æ€§åˆ¥']||'',
              p_age: row['age_range']||row['å¹´é½¡ç¯„åœ']||'',
              p_is_local: (row['is_local']||row['æ˜¯å¦ç‚ºå°å—äºº']||'').includes('æ˜¯'),
              p_sources: sRaw.split(',').map(x=>x.trim()).filter(x=>x), 
              p_purposes: pRaw.split(',').map(x=>x.trim()).filter(x=>x), 
              p_keywords: row['search_keywords']||row['æœå°‹é—œéµå­—']||'',
              p_detail: row['detail_desc']||row['è©³ç´°æè¿°']||'' 
          };
       }).filter(x=>x);

       const batchSize = 10;
       let processed = 0;
       let errors = [];

       for(let i=0; i<cleanData.length; i+=batchSize) {
          const chunk = cleanData.slice(i, i+batchSize);
          const results = await Promise.allSettled(chunk.map(r => supabase.rpc('submit_visit_v7', r)));
          
          results.forEach((res, idx) => {
              if(res.status === 'rejected' || (res.value && res.value.error)) {
                  const errRow = chunk[idx];
                  errors.push(`${errRow.p_date} ${errRow.p_name}: ${res.reason || res.value.error}`);
              }
          });

          processed += chunk.length;
          const pct = Math.round(processed/total*100);
          progress.style.width = pct + '%';
          status.innerText = `è™•ç†ä¸­... ${processed} / ${total}`;
       }
       
       status.innerText = `å®Œæˆï¼æˆåŠŸ: ${total - errors.length} | å¤±æ•—: ${errors.length}`;
       if(errors.length > 0) {
           errLog.classList.remove('hidden');
           errLog.innerHTML = errors.map(e => `<div>${e}</div>`).join('');
       }
       
       setTimeout(() => { 
           if(errors.length === 0) { overlay.style.display='none'; location.reload(); }
           else { alert('åŒ¯å…¥å®Œæˆä½†æœ‰éƒ¨åˆ†éŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒã€‚'); }
       }, 1000);
    }});
  };

  // --- Admin Wipe Force Backup ---
  window.wipeData = async () => { 
      alert('å®‰å…¨æ©Ÿåˆ¶ï¼šç³»çµ±å°‡å¼·åˆ¶ç‚ºæ‚¨ä¸‹è¼‰ä¸€ä»½å‚™ä»½ CSVï¼Œä¸‹è¼‰é–‹å§‹å¾Œæ‰èƒ½ç¹¼çºŒã€‚');
      exportCSV(); // 1. Force Download
      
      // 2. Wait for download trigger
      setTimeout(async () => {
          if(!confirm('å‚™ä»½å·²ä¸‹è¼‰ã€‚æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
          
          const pwd = prompt('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ç¢ºèªï¼š');
          if(pwd === '628599') { // Corrected Password
              const { error } = await supabase.from('visits').delete().neq('id', 0);
              if(error) alert('æ¸…ç©ºå¤±æ•—: ' + error.message);
              else {
                  alert('è³‡æ–™åº«å·²æ¸…ç©ºã€‚');
                  location.reload();
              }
          } else {
              alert('å¯†ç¢¼éŒ¯èª¤ï¼');
          }
      }, 1500); 
  };

  // Utils
  window.saveData = async () => {
     const r = {
        p_date: document.getElementById('mDate').value,
        p_store: document.getElementById('mStore').value,
        p_name: document.getElementById('mName').value,
        p_gender: document.getElementById('mGender').value,
        p_age: '', 
        p_is_local: false,
        p_sources: document.getElementById('mSources').value.replace(/ï¼Œ/g,',').split(',').filter(x=>x),
        p_purposes: document.getElementById('mPurposes').value.replace(/ï¼Œ/g,',').split(',').filter(x=>x),
        p_keywords: '',
        p_detail: document.getElementById('mDetail').value
     };
     await supabase.rpc('submit_visit_v7', r);
     document.getElementById('addModal').style.display='none'; fetchAllData();
  };

  window.setStore = (s) => { currentStore = s; document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active')); if(s=='å…¨éƒ¨')document.getElementById('kpiTotal').classList.add('active'); if(s=='è‡¨å®‰åº—')document.getElementById('kpiLinAn').classList.add('active'); if(s=='å—ç§‘åº—')document.getElementById('kpiNanKe').classList.add('active'); applyFilter(); };
  window.loadMore = () => { displayLimit+=20; renderTable(); };
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  window.openAddModal = () => document.getElementById('addModal').style.display='flex';
  window.showDetail = (id) => { const v = rawData.find(x => x.id === parseInt(id)); if(!v) return; document.getElementById('detailContent').innerHTML=`<h2 class="font-bold text-xl mb-2">${v.customer_name}</h2><p class="text-sm text-gray-500 mb-4">${v.form_date} @ ${v.store_branch} (${v.gender||''})</p><div class="bg-slate-50 p-4 rounded text-sm text-slate-700 whitespace-pre-wrap">${v.detail_desc||'ç„¡æè¿°'}</div>`; document.getElementById('eId').value=v.id; document.getElementById('detailModal').style.display='flex'; document.getElementById('detailActions').classList.remove('hidden'); };
  window.closeDetail = () => document.getElementById('detailModal').style.display='none';
  window.enableEdit = () => { document.getElementById('detailContent').innerHTML=''; document.getElementById('editForm').classList.remove('hidden'); document.getElementById('detailActions').classList.add('hidden'); };
  function enableAdminUI() { isAdmin = true; document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); document.getElementById('adminActions').classList.remove('hidden'); }
  window.login = () => { if(document.getElementById('admPwd').value==='admin') enableAdminUI(); };
  window.exportCSV = () => { const csv = Papa.unparse(rawData); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'})); link.download = `backup_v7_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(link); link.click(); };
</script>
</body>
</html>
