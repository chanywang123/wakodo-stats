<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V5.5</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Flatpickr (Agoda Style) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    :root { 
      --bg: #f3f4f6; 
      --card: #ffffff; 
      --text: #1f2937; 
      --accent: #2563eb; 
      --table-header-bg: #fcd34d; 
      --table-header-text: #000000;
      --row-hover: #fef9c3; 
    }
    
    body { background-color: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; }
    
    /* Agoda Style Date Picker */
    .date-range-container {
      display: flex; align-items: center; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
    }
    .date-range-container:hover { border-color: var(--accent); }
    .date-range-input {
      border: none; padding: 10px 12px; font-size: 14px; outline: none; width: 220px; text-align: center; font-weight: 600; cursor: pointer; color: #374151;
    }
    
    .input-std { background: #fff; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; width: 100%; }
    .btn-primary { background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat.active { border-color: var(--accent); background: #eff6ff; }

    thead tr th { background-color: var(--table-header-bg) !important; color: var(--table-header-text) !important; font-weight: 800; }
    tbody tr { transition: background-color 0.1s; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
    tbody tr:hover { background-color: var(--row-hover) !important; }
    
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: flex !important; }
    body.is-admin td.admin-only { display: table-cell !important; } 

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal-content { background: #fff; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 24px; border-radius: 12px; }
    .detail-row { display: flex; border-bottom: 1px solid #eee; padding: 12px 0; align-items: center; }
    .detail-label { width: 100px; font-weight: bold; color: #666; }
    
    /* Load More Button Style */
    .load-more-btn {
        width: 100%; padding: 12px;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        color: #6b7280; font-weight: 600; font-size: 13px;
        background: #f9fafb; border: none; border-top: 1px solid #e5e7eb;
        cursor: pointer; transition: 0.2s;
    }
    .load-more-btn:hover { background: #f3f4f6; color: var(--accent); }
    .arrow-down { 
        width: 0; height: 0; 
        border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid currentColor; 
    }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold tracking-tight text-blue-600 flex items-center gap-2">
        <span>ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</span>
        <span class="text-sm font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">V5.5 â€¢ 2026/01/13</span>
      </h1>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-gray-800 p-2" title="ç®¡ç†å“¡">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden mb-6 card bg-gray-800 text-white border-0 shadow-xl">
    <div id="loginForm" class="flex gap-3 items-center">
      <input type="email" id="admEmail" value="chanywang92@gmail.com" class="input-std text-black" placeholder="Email">
      <input type="password" id="admPwd" class="input-std text-black" placeholder="Password">
      <button onclick="login()" class="btn-primary">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center justify-between w-full">
      <div class="font-bold text-green-400 flex items-center gap-2">âœ… ç®¡ç†å“¡ <span class="text-xs text-gray-400 font-normal">(å·²ç™»å…¥)</span></div>
      <div class="flex gap-2">
        <!-- åŒ¯å‡º CSV æŒ‰éˆ• -->
        <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1">
            â¬‡ï¸ åŒ¯å‡º CSV
        </button>
        <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm flex items-center gap-1 text-white">
          <span>ğŸ“‚ åŒ¯å…¥ CSV</span>
          <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="previewCSV(this)">
        </label>
        <button onclick="logout()" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm">ç™»å‡º</button>
      </div>
      <button onclick="wipeData()" class="text-red-400 text-sm border border-red-400 px-3 py-1 rounded hover:bg-red-900">âš ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center sticky top-2 z-30 shadow-md">
    <div class="date-range-container">
      <span class="pl-3 text-gray-400">ğŸ“…</span>
      <input type="text" id="dateRange" class="date-range-input" placeholder="è¼‰å…¥ä¸­..." readonly>
    </div>
    
    <div class="flex-grow relative">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." class="input-std pl-9" onkeyup="if(event.key==='Enter') fetchData()">
      <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
      <button onclick="clearSearch()" id="btnClearSearch" class="hidden absolute right-2 top-2.5 text-gray-400 font-bold">âœ•</button>
    </div>
    <button onclick="fetchData()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div onclick="setStore('å…¨éƒ¨')" id="btnTotal" class="card btn-stat flex flex-col justify-center items-center active py-6"><div class="text-xs font-bold text-gray-500 mb-1">ç¸½å®¢æ•¸</div><div class="text-4xl font-extrabold text-gray-800" id="statTotal">--</div></div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="btnLinAn" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">è‡¨å®‰åº—</div><div class="text-4xl font-extrabold text-blue-600" id="statLinAn">--</div></div>
    <div onclick="setStore('å—ç§‘åº—')" id="btnNanKe" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">å—ç§‘åº—</div><div class="text-4xl font-extrabold text-green-600" id="statNanKe">--</div></div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">å®¢æºåˆ†æ</h3><select id="sourceFilter" onchange="filterSource()" class="border rounded text-xs p-1"><option value="ALL">å…¨éƒ¨</option></select></div>
      <div class="flex-grow relative">anvas id="chartSource"></canvas></div>
      <div id="trendBox" class="hidden mt-4 h-24 w-full"><div class="text-xs font-bold text-gray-400">è¶¨å‹¢: <span id="trendLabel"></span></div><div class="relative w-full h-full">anvas id="chartTrend"></canvas></div></div>
    </div>
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">ä¾†åº—ç›®çš„</h3></div>
      <div class="flex-grow relative flex justify-center">anvas id="chartPurpose"></canvas></div>
    </div>
  </div>

  <!-- Table -->
  <div class="card overflow-hidden shadow-lg border-0 p-0">
    <div class="p-4 bg-white border-b flex justify-between">
      <h3 class="font-bold text-lg text-gray-800">æœ€æ–°ä¾†å®¢ç´€éŒ„</h3>
      <span class="text-xs text-gray-400" id="recordCountDisplay">--</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead>
          <tr>
            <th class="p-3 pl-4">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 pr-4 admin-only text-right" style="width: 80px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-white"></tbody>
      </table>
    </div>
    <!-- Load More Button (ç¾åŒ–ç‰ˆ) -->
    <button onclick="loadMore()" id="btnLoadMore" class="load-more-btn hidden">
        <span>é¡¯ç¤ºæ›´å¤š</span>
        <div class="arrow-down"></div>
    </button>
  </div>
</div>

<!-- Details Modal -->
<div id="detailModal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h2 class="text-xl font-bold">è©³ç´°è³‡æ–™</h2>
      <div class="flex gap-2">
        <button onclick="toggleEditMode()" class="admin-only bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold">ç·¨è¼¯</button>
        <button onclick="closeDetailModal()" class="text-2xl text-gray-400">&times;</button>
      </div>
    </div>
    <!-- View Mode -->
    <div id="detailView"></div>
    <!-- Edit Mode -->
    <div id="detailEdit" class="hidden space-y-3">
      <input type="hidden" id="eId">
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><input type="date" id="eDate" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><select id="eStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><input type="text" id="eName" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">å®¢æº(é€—è™Ÿéš”é–‹)</div><input type="text" id="eSources" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„(é€—è™Ÿéš”é–‹)</div><input type="text" id="ePurposes" class="input-std"></div>
      <div class="detail-row flex-col items-start"><div class="detail-label mb-2">å‚™è¨»</div><textarea id="eDetail" class="input-std h-24"></textarea></div>
      <button onclick="saveEdit()" class="btn-primary w-full bg-green-600 hover:bg-green-700">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">æ–°å¢è³‡æ–™</h2>
    <div class="space-y-3">
      <input type="date" id="mDate" class="input-std">
      <select id="mStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select>
      <input type="text" id="mName" class="input-std" placeholder="å§“å">
      <input type="text" id="mSources" class="input-std" placeholder="å®¢æº (å¯è¤‡é¸)">
      <input type="text" id="mPurposes" class="input-std" placeholder="ç›®çš„ (å¯è¤‡é¸)">
      <textarea id="mDetail" class="input-std" placeholder="å‚™è¨»"></textarea>
      <button onclick="saveData()" class="btn-primary w-full">å„²å­˜</button>
      <button onclick="closeModal()" class="w-full text-center text-sm text-gray-500 mt-2">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  let visits = [], stats = {}, currentStore = 'å…¨éƒ¨', savedSourceFilter = 'ALL', charts = {};
  let currentLimit = 10;
  let datePicker;

  window.onload = async () => {
    // 1. åˆå§‹åŒ– Flatpickrï¼Œå…ˆçµ¦ä¸€å€‹ç©ºçš„ï¼Œç­‰æŠ“åˆ°æ¥µå€¼å† update
    datePicker = flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        locale: "zh_tw",
        onChange: function(selectedDates) {
            // åªæœ‰ç•¶é¸æ»¿å…©å€‹æ—¥æœŸæ™‚æ‰è§¸ç™¼æŸ¥è©¢
            if(selectedDates.length === 2) fetchData();
        }
    });

    // 2. è‡ªå‹•æŠ“å–è³‡æ–™åº«ã€Œæœ€æ—©ã€èˆ‡ã€Œæœ€æ™šã€æ—¥æœŸä¾†è¨­å®šé è¨­å€¼
    await initDateRange();

    // 3. æª¢æŸ¥ç®¡ç†å“¡ç™»å…¥
    const { data: { session } } = await supabase.auth.getSession();
    if(session) {
        document.body.classList.add('is-admin');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminActions').classList.remove('hidden');
    }

    // 4. é¦–æ¬¡è¼‰å…¥
    fetchData();
  };

  async function initDateRange() {
      // æŸ¥è©¢æœ€æ—©çš„ä¸€ç­†
      const { data: minData } = await supabase.from('visits').select('form_date').order('form_date', {ascending:true}).limit(1);
      // æŸ¥è©¢æœ€æ™šçš„ä¸€ç­† (é€šå¸¸æ˜¯ä»Šå¤©ï¼Œä½†ç‚ºäº†ä¿éšª)
      const { data: maxData } = await supabase.from('visits').select('form_date').order('form_date', {ascending:false}).limit(1);

      let minDate = minData?.[0]?.form_date || '2023-01-01';
      let maxDate = maxData?.[0]?.form_date || new Date().toISOString().split('T')[0];
      
      // æ›´æ–° Flatpickr
      datePicker.setDate([minDate, maxDate]);
      console.log(`Auto Date Range Set: ${minDate} to ${maxDate}`);
  }

  window.fetchData = async () => {
    // ä¿®æ­£ï¼šå¾ Flatpickr çš„ selectedDates é™£åˆ—å–å€¼ï¼Œè€Œä¸æ˜¯è§£æ inputå­—ä¸²
    // å¦‚æœä½¿ç”¨è€…é‚„æ²’é¸ï¼Œå°±ç”¨é è¨­çš„
    const dates = datePicker.selectedDates;
    let from, to;
    
    if (dates.length === 2) {
        // Flatpickr çµ¦çš„æ˜¯ Date ç‰©ä»¶ï¼Œè½‰æˆ YYYY-MM-DDï¼Œä¸¦è€ƒæ…®æ™‚å€å•é¡Œ
        // ç°¡å–®åšæ³•ï¼šåˆ©ç”¨ text input çš„å€¼ä¾†åˆ‡ï¼Œå› ç‚º flatpickr æœƒè‡ªå‹• format å¥½
        const rawStr = document.getElementById('dateRange').value; 
        const parts = rawStr.split(' to '); // é€™æ˜¯æœ€ç©©çš„ï¼Œç›´æ¥åˆ‡å­—ä¸²
        from = parts[0];
        to = parts[1];
    } else {
        // Fallback
        from = '2023-01-01';
        to = new Date().toISOString().split('T')[0];
    }
    
    // å¦‚æœåˆ‡å‡ºä¾†æ˜¯ undefined (ä¾‹å¦‚é‚„æ²’é¸å¥½)ï¼Œå°±æš«æ™‚ä¸æŸ¥
    if(!from || !to) return;

    const key = document.getElementById('qSearch').value;
    if(key) document.getElementById('btnClearSearch').classList.remove('hidden');
    
    document.getElementById('statTotal').innerText = '...';

    // å‘¼å« RPC
    const { data, error } = await supabase.rpc('get_visits_public', { 
        start_date: from, 
        end_date: to, 
        keyword: key, 
        store_filter: currentStore 
    });

    if(error) {
        // éš±è—è©³ç´°éŒ¯èª¤çµ¦ä½¿ç”¨è€…ï¼Œä½† log å‡ºä¾†
        console.error("Fetch Error:", error);
        if(error.message.includes('invalid input syntax')) {
            alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œç³»çµ±æ­£åœ¨å˜—è©¦è‡ªå‹•ä¿®æ­£ï¼Œè«‹é‡è©¦ä¸€æ¬¡ã€‚');
        } else {
            alert('è®€å–å¤±æ•—: ' + error.message);
        }
        return;
    }

    if(data) {
      visits = data;
      document.getElementById('statTotal').innerText = visits.length;
      document.getElementById('statLinAn').innerText = visits.filter(x=>x.store_branch=='è‡¨å®‰åº—').length;
      document.getElementById('statNanKe').innerText = visits.filter(x=>x.store_branch=='å—ç§‘åº—').length;
      
      currentLimit = 10;
      renderAll();
    }
  };

  function renderAll() {
    let list = visits;
    if(savedSourceFilter !== 'ALL') {
      list = visits.filter(v => (v.source_tags||[]).includes(savedSourceFilter));
      document.getElementById('trendBox').classList.remove('hidden');
      document.getElementById('trendLabel').innerText = savedSourceFilter;
      renderTrend(savedSourceFilter);
    } else {
      document.getElementById('trendBox').classList.add('hidden');
    }

    const sMap = {}, pMap = {};
    list.forEach(v => {
      (v.source_tags||[]).forEach(x => sMap[x] = (sMap[x]||0)+1);
      (v.visit_purposes||[]).forEach(x => pMap[x] = (pMap[x]||0)+1);
    });

    const sortedSource = Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    const sortedPurpose = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0, 8);

    renderChart('chartSource', 'bar', sortedSource, 'å®¢æºTop15');
    renderChart('chartPurpose', 'doughnut', sortedPurpose, 'ç›®çš„åˆ†ä½ˆ');

    const sel = document.getElementById('sourceFilter');
    if(sel.options.length <= 1 || savedSourceFilter === 'ALL') {
        sel.innerHTML = '<option value="ALL">å…¨éƒ¨</option>';
        Object.keys(sMap).sort().forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`);
        sel.value = savedSourceFilter;
    }

    renderTableList();
  }

  function renderTableList() {
    const tbody = document.getElementById('tableBody');
    const sortedVisits = [...visits].sort((a, b) => new Date(b.form_date) - new Date(a.form_date));
    const visibleData = sortedVisits.slice(0, currentLimit);

    tbody.innerHTML = visibleData.map(v => `
      <tr data-id="${v.id}" onclick="showDetail(${v.id})">
        <td class="p-3 pl-4 font-mono text-gray-500">${v.form_date.slice(5)}</td>
        <td class="p-3"><span class="px-2 py-0.5 rounded text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${v.store_branch}</span></td>
        <td class="p-3 font-bold text-gray-900">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]" title="${(v.source_tags||[]).join(',')}">${(v.source_tags||[]).join(',')}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]" title="${(v.visit_purposes||[]).join(',')}">${(v.visit_purposes||[]).join(',')}</td>
        <td class="p-3 pr-4 admin-only text-right" onclick="event.stopPropagation()">
            <button class="text-red-500 hover:bg-red-50 p-2 rounded font-bold" onclick="deleteData(${v.id})">åˆª</button>
        </td>
      </tr>
    `).join('');

    document.getElementById('recordCountDisplay').innerText = `é¡¯ç¤º ${visibleData.length} / ${visits.length} ç­†`;
    
    // ç¾åŒ–å¾Œçš„æŒ‰éˆ•é‚è¼¯
    const btn = document.getElementById('btnLoadMore');
    if(visibleData.length >= visits.length) {
        btn.classList.add('hidden');
    } else {
        btn.classList.remove('hidden');
    }
  }

  window.loadMore = () => { currentLimit += 20; renderTableList(); };

  window.showDetail = (id) => {
    const v = visits.find(x => x.id == id);
    if(!v) return;
    
    document.getElementById('detailView').innerHTML = `
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><div>${v.form_date}</div></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><div>${v.store_branch}</div></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><div class="text-2xl font-bold text-blue-600">${v.customer_name}</div></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><div class="flex flex-wrap gap-1">${(v.source_tags||[]).map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><div class="flex flex-wrap gap-1">${(v.visit_purposes||[]).map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="mt-4 p-4 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap">${v.detail_desc||'ç„¡å‚™è¨»'}</div>
    `;
    document.getElementById('eId').value = v.id;
    document.getElementById('eDate').value = v.form_date;
    document.getElementById('eStore').value = v.store_branch;
    document.getElementById('eName').value = v.customer_name;
    document.getElementById('eSources').value = (v.source_tags||[]).join(',');
    document.getElementById('ePurposes').value = (v.visit_purposes||[]).join(',');
    document.getElementById('eDetail').value = v.detail_desc||'';
    
    document.getElementById('detailView').classList.remove('hidden');
    document.getElementById('detailEdit').classList.add('hidden');
    document.getElementById('detailModal').style.display = 'flex';
  };
  window.closeDetailModal = () => document.getElementById('detailModal').style.display='none';

  // --- CHART ---
  function renderChart(id, type, data, label) {
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: data.map(x=>x[0]),
        datasets: [{ label: label, data: data.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#6366f1','#ec4899'], borderWidth:1, borderRadius: 4 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right', labels: {boxWidth: 12}} } }
    });
  }

  function renderTrend(tag) {
    const ctx = document.getElementById('chartTrend').getContext('2d');
    if(charts.trend) charts.trend.destroy();
    const map = {};
    visits.filter(v=>(v.source_tags||[]).includes(tag)).forEach(v => { const m = v.form_date.slice(0,7); map[m] = (map[m]||0)+1; });
    const lbls = Object.keys(map).sort();
    charts.trend = new Chart(ctx, {
      type: 'line',
      data: { labels: lbls, datasets: [{ label:'æ•¸é‡', data:lbls.map(k=>map[k]), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.1)', fill:true, tension: 0.3 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
    });
  }

  // --- IMPORT / EXPORT / ADMIN ---
  window.exportCSV = () => {
      // ä½¿ç”¨ PapaParse å°‡ visits é™£åˆ—è½‰ç‚º CSV
      const csv = Papa.unparse(visits);
      const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'}); // åŠ  BOM é¿å… Excel äº‚ç¢¼
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `visits_export_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  };

  window.previewCSV = (input) => {
    const f = input.files[0]; if(!f) return;
    const label = input.parentElement.querySelector('span');
    const oldText = label.innerText;
    label.innerText = 'è™•ç†ä¸­...';
    Papa.parse(f, {
      header: true, skipEmptyLines: true,
      complete: async (res) => {
        if(!confirm(`æº–å‚™åŒ¯å…¥ ${res.data.length} ç­†è³‡æ–™ï¼Ÿ`)) { label.innerText=oldText; return; }
        let success = 0;
        const chunkSize = 50; 
        for (let i = 0; i < res.data.length; i += chunkSize) {
            const chunk = res.data.slice(i, i + chunkSize);
            const promises = chunk.map(r => {
                const d = r['form_date']||r['å¡«è¡¨æ—¥æœŸ']; 
                const n = r['customer_name']||r['é¡§å®¢å§“å'];
                if(!d || !n) return null;
                const s = (r['ä¾†æºçµ±è¨ˆ']||r['source_tags']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                const p = (r['ä¾†åº—ç›®çš„']||r['visit_purposes']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                return supabase.rpc('submit_visit', { p_date: d.replace(/\//g,'-'), p_store: r['store_branch']||r['é–€åº—']||'è‡¨å®‰åº—', p_name: n, p_sources: s, p_purposes: p, p_gender:'', p_age:'', p_tainan:false, p_keyword:'', p_detail: r['detail_desc']||r['è©³ç´°æè¿°']||'' });
            }).filter(p=>p);
            const results = await Promise.all(promises);
            success += results.filter(x => x && !x.error).length;
            label.innerText = `åŒ¯å…¥ä¸­...${i}/${res.data.length}`;
        }
        alert(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸ: ${success} ç­†`);
        label.innerText = oldText;
        input.value = '';
        fetchData();
      }
    });
  };

  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  window.login = async () => {
    const { error } = await supabase.auth.signInWithPassword({ email: document.getElementById('admEmail').value, password: document.getElementById('admPwd').value });
    if(error) alert(error.message);
    else { 
        document.body.classList.add('is-admin'); document.getElementById('adminPanel').classList.add('hidden'); 
        document.getElementById('loginForm').classList.add('hidden'); document.getElementById('adminActions').classList.remove('hidden');
        alert("ç™»å…¥æˆåŠŸï¼"); fetchData();
    }
  };
  window.logout = async () => { await supabase.auth.signOut(); document.body.classList.remove('is-admin'); document.getElementById('adminActions').classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); alert("å·²ç™»å‡º"); };
  window.wipeData = async () => { if(prompt('è¼¸å…¥ admin ç¢ºèªæ¸…ç©º') === 'admin') { await supabase.from('visits').delete().neq('id', 0); alert('è³‡æ–™å·²æ¸…ç©º'); fetchData(); } };
  window.deleteData = async (id) => { if(confirm('åˆªé™¤ç„¡æ³•å¾©åŸï¼Œç¢ºå®šï¼Ÿ')) { await supabase.from('visits').delete().eq('id', id); visits = visits.filter(v => v.id != id); renderAll(); } };
  
  // --- HELPERS ---
  window.setStore = s => { currentStore=s; document.querySelectorAll('.btn-stat').forEach(b=>b.classList.remove('active')); if(s=='å…¨éƒ¨')document.getElementById('btnTotal').classList.add('active'); if(s=='è‡¨å®‰åº—')document.getElementById('btnLinAn').classList.add('active'); if(s=='å—ç§‘åº—')document.getElementById('btnNanKe').classList.add('active'); fetchData(); };
  window.filterSource = () => { savedSourceFilter=document.getElementById('sourceFilter').value; renderAll(); };
  window.clearSearch = () => { document.getElementById('qSearch').value=''; document.getElementById('btnClearSearch').classList.add('hidden'); fetchData(); };
  window.openAddModal = () => { document.getElementById('mDate').value=new Date().toISOString().split('T')[0]; document.getElementById('modal').style.display='flex'; };
  window.closeModal = () => document.getElementById('modal').style.display='none';
  window.toggleEditMode = () => { document.getElementById('detailView').classList.toggle('hidden'); document.getElementById('detailEdit').classList.toggle('hidden'); };
  
  window.saveEdit = async () => {
    const id = document.getElementById('eId').value;
    const updates = {
      form_date: document.getElementById('eDate').value, store_branch: document.getElementById('eStore').value,
      customer_name: document.getElementById('eName').value, source_tags: document.getElementById('eSources').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x),
      visit_purposes: document.getElementById('ePurposes').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x), detail_desc: document.getElementById('eDetail').value
    };
    const { error } = await supabase.from('visits').update(updates).eq('id', id);
    if(error) alert('æ›´æ–°å¤±æ•—: ' + error.message); else { alert('æ›´æ–°æˆåŠŸ'); const idx = visits.findIndex(v => v.id == id); if(idx !== -1) visits[idx] = { ...visits[idx], ...updates }; document.getElementById('detailModal').style.display='none'; renderAll(); }
  };
  
  window.saveData = async () => {
    const { error } = await supabase.rpc('submit_visit', {
      p_date: document.getElementById('mDate').value, p_store: document.getElementById('mStore').value,
      p_name: document.getElementById('mName').value, p_sources: document.getElementById('mSources').value.split(/,|ï¼Œ/).filter(x=>x),
      p_purposes: document.getElementById('mPurposes').value.split(/,|ï¼Œ/).filter(x=>x), p_detail: document.getElementById('mDetail').value, p_gender:'', p_age:'', p_tainan:false, p_keyword:''
    });
    if(error) alert('æ–°å¢å¤±æ•—: '+error.message); else { alert('æ–°å¢æˆåŠŸ'); closeModal(); fetchData(); }
  };
</script>
</body>
</html>
