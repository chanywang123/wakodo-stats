<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V6.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    :root { 
      --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --accent: #2563eb; 
      --table-header-bg: #fcd34d; --table-header-text: #000000; --row-hover: #fef9c3; 
    }
    body { background-color: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; }
    
    .date-range-container {
      display: flex; align-items: center; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
    }
    .date-range-container:hover { border-color: var(--accent); }
    .date-range-input {
      border: none; padding: 10px 12px; font-size: 14px; outline: none; width: 220px; text-align: center; font-weight: 600; cursor: pointer; color: #374151;
    }
    
    .input-std { background: #fff; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; width: 100%; }
    .btn-primary { background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat.active { border-color: var(--accent); background: #eff6ff; }

    thead tr th { background-color: var(--table-header-bg) !important; color: var(--table-header-text) !important; font-weight: 800; }
    tbody tr { transition: background-color 0.1s; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
    tbody tr:hover { background-color: var(--row-hover) !important; }
    
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: flex !important; }
    body.is-admin td.admin-only { display: table-cell !important; } 

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal-content { background: #fff; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 24px; border-radius: 12px; }
    .detail-row { display: flex; border-bottom: 1px solid #eee; padding: 12px 0; align-items: center; }
    .detail-label { width: 100px; font-weight: bold; color: #666; }
    
    /* Load More Button (Triangle) */
    .load-more-btn {
        width: 100%; padding: 12px;
        display: flex; align-items: center; justify-content: center;
        background: #f9fafb; border: none; border-top: 1px solid #e5e7eb;
        cursor: pointer; transition: 0.2s; color: #9ca3af;
    }
    .load-more-btn:hover { background: #f3f4f6; color: var(--accent); }
    .arrow-down { 
        width: 0; height: 0; 
        border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid currentColor; 
    }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4">
  <!-- Header V6.0 -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold tracking-tight text-blue-600 flex items-center gap-2">
        <span>ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</span>
        <span class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded border border-blue-100 tracking-wide">
          V6.0 â€¢ 2026/01/13
        </span>
      </h1>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-gray-800 p-2" title="ç®¡ç†å“¡">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden mb-6 card bg-gray-800 text-white border-0 shadow-xl">
    <div id="loginForm" class="flex gap-3 items-center">
      <input type="email" id="admEmail" value="chanywang92@gmail.com" class="input-std text-black" placeholder="Email">
      <input type="password" id="admPwd" class="input-std text-black" placeholder="Password">
      <button onclick="login()" class="btn-primary">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center justify-between w-full">
      <div class="font-bold text-green-400 flex items-center gap-2">âœ… ç®¡ç†å“¡ <span class="text-xs text-gray-400 font-normal">(å·²ç™»å…¥)</span></div>
      <div class="flex gap-2">
        <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 font-bold">â¬‡ï¸ åŒ¯å‡º CSV</button>
        <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm flex items-center gap-1 text-white">
          <span>ğŸ“‚ åŒ¯å…¥ CSV</span>
          <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="previewCSV(this)">
        </label>
        <button onclick="logout()" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm">ç™»å‡º</button>
      </div>
      <button onclick="wipeData()" class="text-red-400 text-sm border border-red-400 px-3 py-1 rounded hover:bg-red-900">âš ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center sticky top-2 z-30 shadow-md">
    <div class="date-range-container">
      <span class="pl-3 text-gray-400">ğŸ“…</span>
      <input type="text" id="dateRange" class="date-range-input" placeholder="è¼‰å…¥ä¸­..." readonly>
    </div>
    <div class="flex-grow relative">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." class="input-std pl-9" onkeyup="if(event.key==='Enter') reloadAll()">
      <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
      <button onclick="clearSearch()" id="btnClearSearch" class="hidden absolute right-2 top-2.5 text-gray-400 font-bold">âœ•</button>
    </div>
    <button onclick="reloadAll()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div onclick="setStore('å…¨éƒ¨')" id="btnTotal" class="card btn-stat flex flex-col justify-center items-center active py-6"><div class="text-xs font-bold text-gray-500 mb-1">ç¸½å®¢æ•¸</div><div class="text-4xl font-extrabold text-gray-800" id="statTotal">--</div></div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="btnLinAn" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">è‡¨å®‰åº—</div><div class="text-4xl font-extrabold text-blue-600" id="statLinAn">--</div></div>
    <div onclick="setStore('å—ç§‘åº—')" id="btnNanKe" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">å—ç§‘åº—</div><div class="text-4xl font-extrabold text-green-600" id="statNanKe">--</div></div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">å®¢æºåˆ†æ</h3></div>
      <div class="flex-grow relative w-full h-full"><canvas id="chartSource"></canvas></div>
    </div>
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">ä¾†åº—ç›®çš„</h3></div>
      <div class="flex-grow relative flex justify-center w-full h-full"><canvas id="chartPurpose"></canvas></div>
    </div>
  </div>

  <!-- Table -->
  <div class="card overflow-hidden shadow-lg border-0 p-0">
    <div class="p-4 bg-white border-b flex justify-between">
      <h3 class="font-bold text-lg text-gray-800">æœ€æ–°ä¾†å®¢ç´€éŒ„</h3>
      <span class="text-xs text-gray-400" id="pageInfoDisplay">--</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead>
          <tr>
            <th class="p-3 pl-4">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 pr-4 admin-only text-right" style="width: 80px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-white"></tbody>
      </table>
    </div>
    <!-- Load More Button -->
    <button onclick="loadNextPage()" id="btnLoadMore" class="load-more-btn hidden" title="è¼‰å…¥æ›´å¤š">
        <div class="arrow-down"></div>
    </button>
  </div>
</div>

<!-- Details Modal -->
<div id="detailModal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h2 class="text-xl font-bold">è©³ç´°è³‡æ–™</h2>
      <div class="flex gap-2">
        <button onclick="toggleEditMode()" class="admin-only bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold">ç·¨è¼¯</button>
        <button onclick="closeDetailModal()" class="text-2xl text-gray-400">&times;</button>
      </div>
    </div>
    <div id="detailView"></div>
    <div id="detailEdit" class="hidden space-y-3">
      <input type="hidden" id="eId">
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><input type="date" id="eDate" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><select id="eStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><input type="text" id="eName" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><input type="text" id="eSources" class="input-std" placeholder="é€—è™Ÿåˆ†éš”"></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><input type="text" id="ePurposes" class="input-std" placeholder="é€—è™Ÿåˆ†éš”"></div>
      <div class="detail-row flex-col items-start"><div class="detail-label mb-2">å‚™è¨»</div><textarea id="eDetail" class="input-std h-24"></textarea></div>
      <button onclick="saveEdit()" class="btn-primary w-full bg-green-600 hover:bg-green-700">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">æ–°å¢è³‡æ–™</h2>
    <div class="space-y-3">
      <input type="date" id="mDate" class="input-std">
      <select id="mStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select>
      <input type="text" id="mName" class="input-std" placeholder="å§“å">
      <input type="text" id="mSources" class="input-std" placeholder="å®¢æº (å¯è¤‡é¸, é€—è™Ÿåˆ†éš”)">
      <input type="text" id="mPurposes" class="input-std" placeholder="ç›®çš„ (å¯è¤‡é¸, é€—è™Ÿåˆ†éš”)">
      <textarea id="mDetail" class="input-std" placeholder="å‚™è¨»"></textarea>
      <button onclick="saveData()" class="btn-primary w-full">å„²å­˜</button>
      <button onclick="closeModal()" class="w-full text-center text-sm text-gray-500 mt-2">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  // Global State (V6.0)
  let currentPage = 1, currentStore = 'å…¨éƒ¨', charts = {}, datePicker;
  let cachedParams = {}; // To freeze params during pagination

  window.onload = async () => {
    // 1. DatePicker Init
    datePicker = flatpickr("#dateRange", { mode: "range", dateFormat: "Y-m-d", locale: "zh_tw", onChange: (d) => { if(d.length===2) reloadAll(); } });
    
    // 2. Auth Check
    const { data: { session } } = await supabase.auth.getSession();
    if(session) { document.body.classList.add('is-admin'); document.getElementById('loginForm').classList.add('hidden'); document.getElementById('adminActions').classList.remove('hidden'); }
    
    // 3. Auto Range
    await initDateRange();
    
    // 4. Initial Load
    reloadAll();
  };

  async function initDateRange() {
      const { data: minData } = await supabase.from('visits').select('form_date').order('form_date', {ascending:true}).limit(1);
      const { data: maxData } = await supabase.from('visits').select('form_date').order('form_date', {ascending:false}).limit(1);
      let minDate = minData?.[0]?.form_date || '2023-01-01';
      let maxDate = maxData?.[0]?.form_date || new Date().toISOString().split('T')[0];
      datePicker.setDate([minDate, maxDate]);
  }

  // --- CORE: CLOUD FETCH (V6.0 Logic) ---
  window.reloadAll = async () => {
    currentPage = 1;
    document.getElementById('tableBody').innerHTML = ''; // Clear table
    
    // Update Params Cache
    const dates = datePicker.selectedDates;
    cachedParams = {
      start: dates[0] ? datePicker.formatDate(dates[0], 'Y-m-d') : '2020-01-01',
      end: dates[1] ? datePicker.formatDate(dates[1], 'Y-m-d') : '2030-12-31',
      key: document.getElementById('qSearch').value,
      store: currentStore
    };

    // Parallel Fetch (Dashboard Stats + First Page)
    await Promise.all([fetchDashboardStats(), fetchTablePage()]);
  };

  async function fetchDashboardStats() {
    const p = cachedParams;
    // Call V6.0 RPC
    const { data, error } = await supabase.rpc('get_dashboard_data_v6', {
      start_date: p.start, end_date: p.end, search_keyword: p.key, store_filter: p.store
    });

    if(error) { console.error("Stats Error:", error); return; }
    
    // Update Stats UI
    const stats = data.stats || {total:0, linan:0, nanke:0};
    document.getElementById('statTotal').innerText = stats.total;
    document.getElementById('statLinAn').innerText = stats.linan;
    document.getElementById('statNanKe').innerText = stats.nanke;

    // Render Charts
    renderChart('chartSource', 'bar', data.sources || {}, 'å®¢æº');
    renderChart('chartPurpose', 'doughnut', data.purposes || {}, 'ç›®çš„');
  }

  async function fetchTablePage() {
    const p = cachedParams;
    // Call V6.0 Paged RPC
    const { data, error } = await supabase.rpc('get_visits_paged_v6', {
      page_no: currentPage, page_size: 20,
      start_date: p.start, end_date: p.end, search_keyword: p.key, store_filter: p.store
    });

    if(error) { console.error("Table Error:", error); return; }

    const tbody = document.getElementById('tableBody');
    
    if(data && data.length > 0) {
      data.forEach(v => {
        // Safe join for arrays (handles null)
        const sources = Array.isArray(v.source_tags) ? v.source_tags.join(',') : '';
        const purposes = Array.isArray(v.visit_purposes) ? v.visit_purposes.join(',') : '';
        
        tbody.innerHTML += `
          <tr class="border-b hover:bg-yellow-50 cursor-pointer" onclick="showDetail(${v.id})">
            <td class="p-3 pl-4 font-mono text-gray-500">${(v.form_date||'').slice(5)}</td>
            <td class="p-3"><span class="px-2 py-0.5 rounded text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${v.store_branch}</span></td>
            <td class="p-3 font-bold text-gray-900">${v.customer_name}</td>
            <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]">${sources}</td>
            <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]">${purposes}</td>
            <td class="p-3 pr-4 admin-only text-right" onclick="event.stopPropagation()">
                <button class="text-red-500 hover:bg-red-50 p-2 rounded font-bold" onclick="deleteData(${v.id})">åˆª</button>
            </td>
          </tr>
        `;
      });
      document.getElementById('btnLoadMore').classList.remove('hidden');
    } else {
      document.getElementById('btnLoadMore').classList.add('hidden');
    }
    document.getElementById('pageInfoDisplay').innerText = `ç›®å‰é¡¯ç¤ºè‡³ç¬¬ ${currentPage} é `;
  }

  window.loadNextPage = () => { currentPage++; fetchTablePage(); };
  window.setStore = (s) => { 
      currentStore = s; 
      document.querySelectorAll('.btn-stat').forEach(b=>b.classList.remove('active')); 
      if(s=='å…¨éƒ¨')document.getElementById('btnTotal').classList.add('active'); 
      if(s=='è‡¨å®‰åº—')document.getElementById('btnLinAn').classList.add('active'); 
      if(s=='å—ç§‘åº—')document.getElementById('btnNanKe').classList.add('active'); 
      reloadAll(); 
  };
  window.clearSearch = () => { document.getElementById('qSearch').value=''; document.getElementById('btnClearSearch').classList.add('hidden'); reloadAll(); };

  // --- CHART RENDERER ---
  function renderChart(id, type, jsonMap, label) {
    const canvas = document.getElementById(id);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    // Sort Desc
    const entries = Object.entries(jsonMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    
    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: entries.map(x=>x[0]),
        datasets: [{ label: label, data: entries.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'], borderRadius:4 }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right'} } }
    });
  }

  // --- DETAIL & EDIT ---
  window.showDetail = async (id) => {
    // We need to fetch single item detail because grid might not have full info
    const { data, error } = await supabase.from('visits').select('*').eq('id', id).single();
    if(error || !data) return;
    
    const v = data;
    const sources = Array.isArray(v.source_tags) ? v.source_tags : (v.source_tags||'').split(',');
    const purposes = Array.isArray(v.visit_purposes) ? v.visit_purposes : (v.visit_purposes||'').split(',');

    document.getElementById('detailView').innerHTML = `
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><div>${v.form_date}</div></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><div>${v.store_branch}</div></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><div class="text-2xl font-bold text-blue-600">${v.customer_name}</div></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><div class="flex flex-wrap gap-1">${sources.map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><div class="flex flex-wrap gap-1">${purposes.map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="mt-4 p-4 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap">${v.detail_desc||'ç„¡å‚™è¨»'}</div>
    `;
    
    // Fill Edit Form
    document.getElementById('eId').value = v.id;
    document.getElementById('eDate').value = v.form_date;
    document.getElementById('eStore').value = v.store_branch;
    document.getElementById('eName').value = v.customer_name;
    document.getElementById('eSources').value = sources.join(',');
    document.getElementById('ePurposes').value = purposes.join(',');
    document.getElementById('eDetail').value = v.detail_desc||'';

    document.getElementById('detailView').classList.remove('hidden');
    document.getElementById('detailEdit').classList.add('hidden');
    document.getElementById('detailModal').style.display = 'flex';
  };
  
  // Save Edit (Direct Update)
  window.saveEdit = async () => {
    const id = document.getElementById('eId').value;
    const updates = {
      form_date: document.getElementById('eDate').value,
      store_branch: document.getElementById('eStore').value,
      customer_name: document.getElementById('eName').value,
      source_tags: document.getElementById('eSources').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x),
      visit_purposes: document.getElementById('ePurposes').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x),
      detail_desc: document.getElementById('eDetail').value
    };
    const { error } = await supabase.from('visits').update(updates).eq('id', id);
    if(error) alert('æ›´æ–°å¤±æ•—: '+error.message); else { alert('æ›´æ–°æˆåŠŸ'); document.getElementById('detailModal').style.display='none'; reloadAll(); }
  };

  // --- CRUD (Admin) ---
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  window.openAddModal = () => { document.getElementById('mDate').value=new Date().toISOString().split('T')[0]; document.getElementById('modal').style.display='flex'; };
  window.closeModal = () => document.getElementById('modal').style.display='none';
  window.toggleEditMode = () => { document.getElementById('detailView').classList.toggle('hidden'); document.getElementById('detailEdit').classList.toggle('hidden'); };
  window.closeDetailModal = () => document.getElementById('detailModal').style.display='none';

  window.login = async () => { const { error } = await supabase.auth.signInWithPassword({ email: document.getElementById('admEmail').value, password: document.getElementById('admPwd').value }); if(!error) location.reload(); };
  window.logout = async () => { await supabase.auth.signOut(); location.reload(); };
  window.wipeData = async () => { if(prompt('è¼¸å…¥ admin ç¢ºèªæ¸…ç©º') === 'admin') { await supabase.from('visits').delete().neq('id', 0); reloadAll(); } };
  window.deleteData = async (id) => { if(confirm('åˆªé™¤?')) { await supabase.from('visits').delete().eq('id', id); reloadAll(); } };

  // New Save Data (Uses RPC for consistency)
  window.saveData = async () => {
      const { error } = await supabase.rpc('submit_visit', {
          p_date: document.getElementById('mDate').value, p_store: document.getElementById('mStore').value,
          p_name: document.getElementById('mName').value, 
          p_sources: document.getElementById('mSources').value.split(/,|ï¼Œ/).filter(x=>x), 
          p_purposes: document.getElementById('mPurposes').value.split(/,|ï¼Œ/).filter(x=>x), 
          p_detail: document.getElementById('mDetail').value,
          p_gender:'', p_age:'', p_tainan:false, p_keyword:''
      });
      if(error) alert('å¤±æ•—: '+error.message); else { closeModal(); reloadAll(); }
  };
  
  // CSV Import (Client-side Parse -> RPC Loop)
  window.previewCSV = (input) => {
    const f = input.files[0]; if(!f) return;
    const label = input.parentElement.querySelector('span'); const oldText = label.innerText; label.innerText = 'è™•ç†ä¸­...';
    Papa.parse(f, { header: true, skipEmptyLines: true, complete: async (res) => {
        if(!confirm(`åŒ¯å…¥ ${res.data.length} ç­†?`)) { label.innerText=oldText; return; }
        let success = 0; const chunkSize = 50;
        for (let i = 0; i < res.data.length; i += chunkSize) {
            const chunk = res.data.slice(i, i + chunkSize);
            const promises = chunk.map(r => {
                const d = r['form_date']||r['å¡«è¡¨æ—¥æœŸ']; const n = r['customer_name']||r['é¡§å®¢å§“å']; if(!d || !n) return null;
                const s = (r['ä¾†æºçµ±è¨ˆ']||r['source_tags']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                const p = (r['ä¾†åº—ç›®çš„']||r['visit_purposes']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                return supabase.rpc('submit_visit', { p_date: d.replace(/\//g,'-'), p_store: r['store_branch']||r['é–€åº—']||'è‡¨å®‰åº—', p_name: n, p_sources: s, p_purposes: p, p_gender:'', p_age:'', p_tainan:false, p_keyword:'', p_detail: r['detail_desc']||r['è©³ç´°æè¿°']||'' });
            }).filter(p=>p);
            const results = await Promise.all(promises); success += results.filter(x => x && !x.error).length; label.innerText = `åŒ¯å…¥ä¸­...${i}/${res.data.length}`;
        }
        alert(`å®Œæˆï¼æˆåŠŸ: ${success}`); label.innerText = oldText; input.value = ''; reloadAll();
    }});
  };
  
  window.exportCSV = async () => {
     // Fetch ALL data for export (using raw select because RPC is paged)
     // Be careful with large data, but for 2000 rows it's fine.
     const { data } = await supabase.from('visits').select('*').order('form_date', {ascending:false});
     if(!data) return;
     const csv = Papa.unparse(data);
     const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'});
     const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `export.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  };
</script>
</body>
</html>
