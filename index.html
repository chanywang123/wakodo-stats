<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V8.0.3.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient("https://yxalpzculcyhzvnyvecb.supabase.co", "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k");
  </script>
  <style>
    :root { --bg: #f3f4f6; --card-bg: rgba(255, 255, 255, 0.85); --accent: #3b82f6; }
    body { background: var(--bg); font-family: system-ui, -apple-system, sans-serif; color: #1e293b; }
    
    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    .kpi-card { cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 2px solid transparent; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
    .kpi-card.active { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border-color: var(--accent); }
    .kpi-card.active::after { content:"â—"; position:absolute; top:12px; right:12px; color:var(--accent); font-size:8px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    #hoverPreview {
        position: fixed; pointer-events: none; z-index: 9999;
        background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(8px);
        border: 1px solid #fbbf24; border-left: 4px solid #fbbf24;
        padding: 14px; border-radius: 10px;
        box-shadow: 0 20px 30px -5px rgba(251, 191, 36, 0.3);
        max-width: 340px; font-size: 0.9rem; color: #374151; line-height: 1.6;
        display: none; transition: opacity 0.15s;
    }

    thead th { background: #fef9c3; color: #000; padding: 14px; font-weight: 800; border-bottom: 2px solid #fde047; font-size: 0.9rem; }
    tbody tr { border-bottom: 1px solid #f1f5f9; transition: all 0.2s; cursor: pointer; }
    tbody tr:hover { background: #fefce8; transform: translateX(2px); box-shadow: 0 2px 4px rgba(251, 191, 36, 0.1); }

    .btn-primary { background: var(--accent); color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); transition: 0.2s; cursor: pointer; border: none; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }

    #importOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; backdrop-filter: blur(4px); }
    .progress-bar { width: 320px; height: 12px; background: #334155; border-radius: 6px; overflow: hidden; margin-top: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #10b981); width: 0%; transition: width 0.3s ease; }
    
    .radio-group { display: flex; flex-wrap: wrap; gap: 6px; }
    .radio-btn { padding: 6px 14px; border: 1.5px solid #e5e7eb; border-radius: 50px; font-size: 13px; color: #4b5563; cursor: pointer; transition: all 0.15s; user-select: none; background: white; }
    .radio-btn:active { transform: scale(0.96); }
    .radio-btn.selected { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-color: #2563eb; font-weight: 600; box-shadow: 0 3px 8px rgba(59, 130, 246, 0.4); }

    .chk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; }
    .chk-btn { padding: 8px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 12px; color: #4b5563; cursor: pointer; transition: all 0.15s; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 40px; background: white; }
    .chk-btn.checked { background: linear-gradient(135deg, #eff6ff, #dbeafe); color: #1e40af; border-color: #3b82f6; font-weight: 700; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25); }
    
    .modal-content { background: white; width: 95%; max-width: 650px; border-radius: 20px; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 100; }
    .required-mark { color: #ef4444; margin-left: 2px; font-weight: bold; }
    
    .lock-badge-container { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 50px; text-xs; font-bold; background: #fef2f2; color: #dc2626; border: 1.5px solid #fca5a5; }
    .lock-badge-x { cursor: pointer; font-size: 16px; padding: 0 4px; border-radius: 50%; transition: 0.15s; font-weight: 900; }
    .lock-badge-x:hover { background: rgba(239, 68, 68, 0.2); transform: scale(1.15); }
    
    .tech-glow {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      animation: glow-pulse 2s ease-in-out infinite;
      position: relative;
      top: -2px;
      margin-right: 6px;
    }
    
    @keyframes glow-pulse {
      0%, 100% { 
        opacity: 1;
        transform: scale(1);
        box-shadow: 
          0 0 10px #3b82f6,
          0 0 20px #3b82f6,
          0 0 30px #3b82f6;
      }
      50% { 
        opacity: 0.6;
        transform: scale(0.85);
        box-shadow: 
          0 0 5px #3b82f6,
          0 0 10px #3b82f6;
      }
    }
    
    /* ğŸ”¥ æ–°å¢ï¼šåœ–ä¾‹ç™¼å…‰æ•ˆæœ */
    .legend-glow-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      animation: legend-pulse 2s ease-in-out infinite;
    }
    
    @keyframes legend-pulse {
      0%, 100% { 
        opacity: 1;
        transform: scale(1);
        box-shadow: 
          0 0 8px currentColor,
          0 0 16px currentColor,
          0 0 24px currentColor;
      }
      50% { 
        opacity: 0.7;
        transform: scale(0.9);
        box-shadow: 
          0 0 4px currentColor,
          0 0 8px currentColor;
      }
    }
    
    .logout-btn {
      background: rgba(239, 68, 68, 0.1);
      border: 1.5px solid rgba(239, 68, 68, 0.3);
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: #dc2626;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      transform: translateY(-1px);
    }
    
    /* ğŸ”¥ æ–°å¢ï¼šéæ¿¾æ¨™ç±¤æ¨£å¼ */
    .filter-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 700;
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      border: 1.5px solid #3b82f6;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .filter-badge-close {
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 50%;
      transition: 0.15s;
      font-weight: 900;
      line-height: 1;
    }
    
    .filter-badge-close:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: scale(1.2);
    }
  </style>
</head>
<body>

<div id="hoverPreview"></div>

<div id="importOverlay">
  <div class="text-3xl font-black mb-3">ğŸ“¦ è³‡æ–™åŒ¯å…¥ä¸­...</div>
  <div id="importStatus" class="text-base text-gray-300">æ­£åœ¨æº–å‚™...</div>
  <div class="progress-bar"><div id="importProgress" class="progress-fill"></div></div>
  <div id="importErrors" class="mt-6 text-xs text-red-300 max-h-48 overflow-y-auto w-[90%] max-w-lg bg-slate-900/50 p-4 rounded-lg hidden backdrop-blur"></div>
</div>

<div class="max-w-7xl mx-auto p-4 space-y-6 pb-8">
  
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight flex items-center gap-3">
        <span class="tech-glow"></span> å’Œå…‰å ‚æˆ°æƒ…å®¤
        <div class="leading-tight text-right ml-2 pl-2 border-l border-slate-300">
          <div class="text-sm font-bold text-slate-600">V8.0.3</div>
          <div class="text-[10px] font-mono text-slate-400 font-bold" id="currentDateDisp">--</div>
        </div>
      </h1>
    </div>
    <div class="flex gap-3">
      <button onclick="toggleAdminPanel()" class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition">âš™ï¸</button>
      <button id="logoutBtn" onclick="logout()" class="logout-btn hidden">ğŸšª ç™»å‡ºç®¡ç†</button>
      <button onclick="window.location.href='form.html'" class="btn-primary">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <div id="adminPanel" class="hidden glass-card bg-slate-900 text-white p-4 border-slate-700">
    <div id="loginForm" class="flex gap-2">
      <input id="admEmail" type="email" class="p-2 rounded text-black flex-1" placeholder="ç®¡ç†å“¡ä¿¡ç®±">
      <input id="admPwd" type="password" class="p-2 rounded text-black flex-1" placeholder="å¯†ç¢¼">
      <button onclick="loginSupabase()" class="btn-primary">Supabase ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center">
      <span class="text-green-400 font-bold">âœ“ ç®¡ç†å“¡æ¨¡å¼</span>
      <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm font-bold">â¬‡ åŒ¯å‡ºè³‡æ–™</button>
      <label class="cursor-pointer bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-sm font-bold">ğŸ“‚ åŒ¯å…¥ CSV <input type="file" accept=".csv" class="hidden" onchange="previewCSV(this)"></label>
      <button onclick="wipeData()" class="ml-auto text-red-400 border border-red-400 px-3 py-1 rounded text-xs hover:bg-red-900 hover:text-white transition">âš  æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <div class="glass-card p-2 flex flex-wrap gap-2 items-center sticky top-2 z-40 shadow-lg border-blue-200/50">
    <div class="flex items-center bg-white/50 rounded-lg px-2 border border-slate-100">
      <span class="text-xl mr-2">ğŸ“…</span>
      <select id="selYear" class="bg-transparent text-sm font-bold border-0 focus:ring-0 cursor-pointer text-slate-600 p-1 mr-1" onchange="quickSelectDate()"></select>
      <span class="text-slate-300">/</span>
      <select id="selMonth" class="bg-transparent text-sm font-bold border-0 focus:ring-0 cursor-pointer text-slate-600 p-1 mr-2" onchange="quickSelectDate()">
         <option value="">æœˆä»½</option>
         <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option><option value="4">4æœˆ</option>
         <option value="5">5æœˆ</option><option value="6">6æœˆ</option><option value="7">7æœˆ</option><option value="8">8æœˆ</option>
         <option value="9">9æœˆ</option><option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
      </select>
      <input id="dateRange" class="bg-transparent border-0 p-2 w-32 text-xs text-slate-400 focus:ring-0 text-right opacity-50" placeholder="è‡ªè¨‚ç¯„åœ" readonly>
      <button onclick="resetDate()" class="text-blue-600 hover:text-blue-800 px-2 text-sm font-bold border-l border-slate-200 ml-2">é‡ç½®å…¨éƒ¨</button>
    </div>
    <div class="flex-grow flex items-center bg-white/50 rounded-lg px-3 border border-slate-100 relative">
      <span class="text-gray-400 mr-2">ğŸ”</span>
      <input id="qSearch" class="bg-transparent border-0 p-2 w-full focus:ring-0" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." onkeyup="if(event.key==='Enter') applyFilter()">
      <button onclick="clearSearch()" id="btnX" class="hidden absolute right-3 text-gray-400 hover:text-red-500 font-bold">âœ•</button>
    </div>
    <button onclick="applyFilter()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div onclick="setStore('å…¨éƒ¨')" id="kpiTotal" class="glass-card kpi-card p-6 flex flex-col items-center justify-center active">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ç¸½å®¢æ•¸</div>
      <div class="text-5xl font-black text-slate-800" id="valTotal">--</div>
    </div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="kpiLinAn" class="glass-card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">è‡¨å®‰åº—</div>
      <div class="text-5xl font-black text-blue-600" id="valLinAn">--</div>
    </div>
    <div onclick="setStore('å—ç§‘åº—')" id="kpiNanKe" class="glass-card kpi-card p-6 flex flex-col items-center justify-center">
      <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">å—ç§‘åº—</div>
      <div class="text-5xl font-black text-green-600" id="valNanKe">--</div>
    </div>
  </div>

  <!-- ğŸ”¥ ä¿®æ”¹ï¼šæ–°å¸ƒå±€ - å·¦å³50%åˆ†å‰² -->
  <div class="glass-card p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-xl font-bold text-slate-800">å®¢æºèˆ‡ç›®çš„åˆ†æ</h3>
        <p class="text-xs text-slate-400 mt-1">é»æ“Šä»»ä½•åœ–è¡¨é …ç›®å¯é€£å‹•å…¶ä»–åˆ†æ</p>
      </div>
    </div>
    
    <!-- ğŸ”¥ éæ¿¾æ¨™ç±¤é¡¯ç¤ºå€ -->
    <div id="filterBadgesContainer" class="hidden flex flex-wrap gap-2 mb-4 pb-4 border-b border-slate-100"></div>
    
    <!-- ğŸ”¥ æ–°å¸ƒå±€ï¼šå·¦å´50%ï¼ˆå®¢æº+è¶¨å‹¢ï¼‰ï¼Œå³å´50%ï¼ˆç›®çš„ï¼‰ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- å·¦å´ï¼šå®¢æº + è¶¨å‹¢ï¼ˆå‚ç›´å †ç–Šï¼‰-->
      <div class="space-y-6">
        <!-- å®¢æºçµ±è¨ˆ -->
        <div class="h-[350px] relative">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">å®¢æºçµ±è¨ˆ</h4>
          <canvas id="chartSource"></canvas>
        </div>
        
        <!-- å®¢æµè¶¨å‹¢ -->
        <div class="h-[250px] relative">
          <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">å®¢æµè¶¨å‹¢</h4>
          <canvas id="chartTrend"></canvas>
        </div>
      </div>
      
      <!-- å³å´ï¼šä¾†åº—ç›®çš„ï¼ˆç¨ç«‹ä½”50%ï¼‰-->
      <div class="h-[620px] relative">
        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">ä¾†åº—ç›®çš„ä½”æ¯”</h4>
        <div class="h-full">
          <canvas id="chartPurpose"></canvas>
        </div>
      </div>
      
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="glass-card p-6 flex flex-col">
       <h3 class="font-bold text-sm text-slate-500 mb-4">æ€§åˆ¥åˆ†ä½ˆ</h3>
       <div class="flex-grow relative"><canvas id="chartGender"></canvas></div>
    </div>
    <div class="glass-card p-6 flex flex-col md:col-span-2">
       <h3 class="font-bold text-sm text-slate-500 mb-4">å¹´é½¡å±¤åˆ†ä½ˆ</h3>
       <div class="flex-grow relative"><canvas id="chartAge"></canvas></div>
    </div>
  </div>

  <div class="glass-card overflow-hidden">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white/50">
      <h3 class="font-bold text-slate-700">æœ€æ–°é¡§å®¢è³‡æ–™</h3>
      <span class="text-xs font-mono text-slate-400" id="listCounter">--</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm whitespace-nowrap">
        <thead><tr><th class="pl-6">æ—¥æœŸ</th><th>åˆ†åº—</th><th>å§“å</th><th>æ€§åˆ¥/å¹´é½¡</th><th>å®¢æº</th><th>ç›®çš„</th><th class="w-10"></th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <button onclick="loadMore()" id="btnLoadMore" class="w-full py-4 text-slate-400 bg-slate-50 hover:bg-slate-100 font-bold text-xs transition border-t border-slate-100">â–¼ è¼‰å…¥æ›´å¤šè³‡æ–™</button>
  </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay" onclick="if(event.target===this)closeAddModal()">
  <div class="modal-content relative">
    <button onclick="closeAddModal()" class="absolute top-4 right-4 text-2xl text-slate-300 hover:text-slate-600 transition">Ã—</button>
    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸ“ æ–°å¢é¡§å®¢è³‡æ–™</h2>
    <div class="space-y-5">
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
          <input type="date" id="mDate" class="w-full p-2 border rounded-lg bg-gray-50 font-bold">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†åº—</label>
          <select id="mStore" class="w-full p-2 border rounded-lg bg-gray-50 font-bold"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select>
        </div>
      </div>

      <div class="flex gap-4">
         <div class="flex-grow">
           <label class="block text-xs font-bold text-gray-500 mb-1">å§“å <span class="required-mark">*</span></label>
           <input id="mName" class="w-full p-2 border rounded-lg" placeholder="é¡§å®¢å§“å">
         </div>
         <div class="flex flex-col justify-end pb-2">
            <label class="flex items-center gap-2 cursor-pointer bg-blue-50 px-3 py-2 rounded-lg border border-blue-100">
               <input type="checkbox" id="mTainan" class="w-4 h-4 text-blue-600" checked>
               <span class="text-sm font-bold text-blue-800">ä½å°å—</span>
            </label>
         </div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">æ€§åˆ¥ <span class="required-mark">*</span></label>
        <div class="radio-group" id="grpGender">
           <div class="radio-btn" onclick="selectRadio('grpGender','ç”·',this)">ç”·</div>
           <div class="radio-btn" onclick="selectRadio('grpGender','å¥³',this)">å¥³</div>
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">å¹´é½¡å±¤ <span class="required-mark">*</span></label>
        <div class="radio-group" id="grpAge"></div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">å®¢æº (å¯å¤šé¸) <span class="required-mark">*</span></label>
        <div class="chk-grid" id="grpSource"></div>
        <div id="boxKeyword" class="hidden mt-3 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
           <label class="block text-xs font-bold text-yellow-700 mb-1">Google æœå°‹äº†ä»€éº¼ï¼Ÿ</label>
           <input id="mKeyword" type="text" class="w-full p-2 border border-yellow-400 rounded text-sm" placeholder="ä¾‹å¦‚ï¼šé©—å…‰æ¨è–¦...">
        </div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">ç›®çš„ (å¯å¤šé¸) <span class="required-mark">*</span></label>
        <div class="chk-grid" id="grpPurpose"></div>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">è©³ç´°å‚™è¨» <span class="required-mark">*</span></label>
        <textarea id="mDetail" class="w-full p-3 border rounded-lg h-24 resize-none" placeholder="å®¢äººæè¿°..."></textarea>
      </div>

      <button onclick="saveData()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg hover:bg-blue-700 transition">ç¢ºèªå„²å­˜</button>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal-content relative">
    <button onclick="closeDetail()" class="absolute top-4 right-4 text-2xl text-slate-300 hover:text-slate-600 transition">Ã—</button>
    <div id="detailContent"></div>
    <div id="detailActions" class="mt-6 flex gap-3 hidden border-t pt-4">
       <button onclick="deleteCurrentDetail()" class="text-red-500 border border-red-200 px-4 py-2 rounded hover:bg-red-50 font-bold text-sm transition">åˆªé™¤æ­¤ç­†</button>
    </div>
  </div>
</div>

<script>
  // ğŸ”¥ ä¿ç•™åŸæœ‰å¸¸æ•¸
  const SOURCES = ["Google æœå°‹", "Google Map", "Facebook å»£å‘Š", "Instagram å»£å‘Š", "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "Mobile 01", "PTT", "è¦ªå‹ä»‹ç´¹", "é€”ç¶“è·¯é", "å…¶ä»–", "æ¥­é…è²¼æ–‡ (FBã€IG)", "è€å®¢å›è³¼", "è€å®¢-æœªè³¼", "å»£å‘Šçœ‹æ¿", "FB ç¤¾åœ˜æ–‡"];
  const PURPOSES = ["é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢", "å–®ç´”çœ‹çœ‹", "è³¼è²·å…¶ä»–å•†å“", "ä½æˆ¶è¦–åŠ›æª¢æŸ¥"];
  const AGES = ["18æ­²ä»¥ä¸‹", "18-24", "25-34", "35-44", "45-54", "55æ­²ä»¥ä¸Š"];

  // ğŸ”¥ æ–°å¢ï¼šå®¢æºå›ºå®šé †åº
  const SOURCE_ORDER = [
    "Google æœå°‹",
    "Google Map", 
    "è¦ªå‹ä»‹ç´¹",
    "Instagram å»£å‘Š",
    "Facebook å»£å‘Š",
    "FBã€IG ä¸€èˆ¬æ–‡ç« ",
    "è€å®¢å›è³¼",
    "é€”ç¶“è·¯é",
    "TikTok & YouTube",
    "è€å®¢-æœªè³¼",
    "æ¥­é…è²¼æ–‡ (FBã€IG)",
    "Dcard",
    "PTT",
    "Mobile 01",
    "å»£å‘Šçœ‹æ¿",
    "FB ç¤¾åœ˜æ–‡",
    "å…¶ä»–"
  ];

  // ğŸ”¥ æ–°å¢ï¼šå®¢æºå›ºå®šé¡è‰²ï¼ˆå½©è‰²ç¹½ç´›ï¼‰
  const SOURCE_COLORS = {
    "Google æœå°‹": "#fbbf24",
    "Google Map": "#10b981",
    "è¦ªå‹ä»‹ç´¹": "#3b82f6",
    "Instagram å»£å‘Š": "#ec4899",
    "Facebook å»£å‘Š": "#8b5cf6",
    "FBã€IG ä¸€èˆ¬æ–‡ç« ": "#f59e0b",
    "è€å®¢å›è³¼": "#06b6d4",
    "é€”ç¶“è·¯é": "#f97316",
    "TikTok & YouTube": "#ef4444",
    "è€å®¢-æœªè³¼": "#a855f7",
    "æ¥­é…è²¼æ–‡ (FBã€IG)": "#14b8a6",
    "Dcard": "#f43f5e",
    "PTT": "#6366f1",
    "Mobile 01": "#059669",
    "å»£å‘Šçœ‹æ¿": "#d97706",
    "FB ç¤¾åœ˜æ–‡": "#7c3aed",
    "å…¶ä»–": "#94a3b8"
  };

  // ğŸ”¥ æ–°å¢ï¼šå…¨å±€éæ¿¾ç‹€æ…‹
  let globalFilter = {
    source: null,
    purpose: null,
    gender: null,
    age: null,
    sourceLocked: false,
    purposeLocked: false,
    genderLocked: false,
    ageLocked: false
  };

  let rawData = [], filteredData = [], displayLimit = 20, currentStore = 'å…¨éƒ¨', charts = {}, datePicker, isAdmin = false;

  window.onload = async () => {
    Chart.register(ChartDataLabels);
    document.getElementById('currentDateDisp').innerText = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
    flatpickr.l10ns.default.months.longhand = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    datePicker = flatpickr("#dateRange", { mode: "range", dateFormat: "Y-m-d", locale: "zh_tw", monthSelectorType: 'static', onChange: (d) => { if(d.length===2) applyFilter(); } });
    document.getElementById('qSearch').addEventListener('input', function() { this.value ? document.getElementById('btnX').classList.remove('hidden') : document.getElementById('btnX').classList.add('hidden'); });
    initAddModal();
    const { data: { session } } = await supabase.auth.getSession();
    if(session) enableAdminUI();
    await fetchAllData();
  };

  function initAddModal() {
     document.getElementById('mDate').value = new Date().toISOString().split('T')[0];
     document.getElementById('grpAge').innerHTML = AGES.map(a => `<div class="radio-btn" onclick="selectRadio('grpAge','${a}',this)">${a}</div>`).join('');
     document.getElementById('grpSource').innerHTML = SOURCES.map(s => `<div class="chk-btn" onclick="toggleChk(this, '${s}')">${s}</div>`).join('');
     document.getElementById('grpPurpose').innerHTML = PURPOSES.map(p => `<div class="chk-btn" onclick="toggleChk(this, '${p}')">${p}</div>`).join('');
  }

  window.selectRadio = (grp, val, el) => {
     document.getElementById(grp).querySelectorAll('.radio-btn').forEach(b => b.classList.remove('selected'));
     el.classList.add('selected'); el.dataset.value = val;
  };
  
  window.toggleChk = (el) => {
     el.classList.toggle('checked');
     const grp = el.parentElement;
     if(grp.id === 'grpSource') {
         const hasGoogle = Array.from(grp.querySelectorAll('.checked')).some(b => b.innerText.includes('Google'));
         document.getElementById('boxKeyword').classList.toggle('hidden', !hasGoogle);
     }
  };

  window.saveData = async () => {
     const name = document.getElementById('mName').value.trim();
     const genderEl = document.querySelector('#grpGender .selected');
     const ageEl = document.querySelector('#grpAge .selected');
     const sources = Array.from(document.querySelectorAll('#grpSource .checked')).map(e=>e.innerText);
     const purposes = Array.from(document.querySelectorAll('#grpPurpose .checked')).map(e=>e.innerText);
     const detail = document.getElementById('mDetail').value.trim();

     if(!name || !genderEl || !ageEl || sources.length===0 || purposes.length===0 || !detail) {
         alert('âš ï¸ è³‡æ–™ä¸å®Œæ•´ï¼è«‹æª¢æŸ¥å§“åã€æ€§åˆ¥ã€å¹´é½¡ã€å®¢æºã€ç›®çš„ã€å‚™è¨»ã€‚');
         return;
     }

     const payload = {
        p_date: document.getElementById('mDate').value,
        p_store: document.getElementById('mStore').value,
        p_name: name,
        p_gender: genderEl.dataset.value,
        p_age: ageEl.dataset.value,
        p_is_local: document.getElementById('mTainan').checked,
        p_sources: sources,
        p_purposes: purposes,
        p_keywords: document.getElementById('mKeyword').value,
        p_detail: detail
     };

     const { error } = await supabase.rpc('submit_visit_v7', payload);
     if(error) { alert('å„²å­˜å¤±æ•—: '+error.message); console.error(error); }
     else { 
         alert('ğŸ‰ æ–°å¢æˆåŠŸï¼'); 
         closeAddModal();
         fetchAllData(); 
     }
  };

  window.closeAddModal = () => {
      document.getElementById('addModal').style.display='none';
      document.getElementById('mName').value=''; document.getElementById('mDetail').value=''; document.getElementById('mKeyword').value='';
      document.querySelectorAll('.selected, .checked').forEach(e=>e.classList.remove('selected','checked'));
      document.getElementById('boxKeyword').classList.add('hidden');
  };

  window.quickSelectDate = () => { const y=document.getElementById('selYear').value; const m=document.getElementById('selMonth').value; if(y&&m){ datePicker.setDate([new Date(y,m-1,1), new Date(y,m,0)]); applyFilter(); } };
  window.resetDate = () => { if(rawData.length){const d=rawData.map(x=>x.form_date).sort();datePicker.setDate([d[0],d[d.length-1]]);} document.getElementById('selMonth').value=""; applyFilter(); };
  window.clearSearch = () => { document.getElementById('qSearch').value=''; document.getElementById('btnX').classList.add('hidden'); applyFilter(); };

  async function fetchAllData() {
    let allRows = [], page = 0; const pageSize = 1000;
    document.getElementById('valTotal').innerText = '...';
    while(true) {
        const { data, error } = await supabase.from('visits').select('*').range(page*pageSize, (page+1)*pageSize-1);
        if(error) {
            console.error('è³‡æ–™è¼‰å…¥éŒ¯èª¤:', error);
            alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
            break;
        }
        if(!data || data.length === 0) break;
        allRows = allRows.concat(data);
        console.log(`å·²è¼‰å…¥ ${allRows.length} ç­†è³‡æ–™...`);
        if(data.length < pageSize) break;
        page++;
    }
    rawData = allRows.sort((a,b) => new Date(b.form_date) - new Date(a.form_date));
    console.log(`âœ… å…±è¼‰å…¥ ${rawData.length} ç­†è³‡æ–™`);
    if(rawData.length > 0) {
        const years = [...new Set(rawData.map(d => d.form_date.slice(0,4)))].sort().reverse();
        const ySel = document.getElementById('selYear');
        ySel.innerHTML = '<option value="">å¹´ä»½</option>' + years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
        const dates = rawData.map(d => d.form_date).sort();
        datePicker.setDate([dates[0], dates[dates.length-1]]);
    }
    applyFilter();
  }

  window.applyFilter = () => {
    const dates = datePicker.selectedDates;
    const start = dates[0] ? datePicker.formatDate(dates[0], 'Y-m-d') : '1900-01-01';
    const end = dates[1] ? datePicker.formatDate(dates[1], 'Y-m-d') : '2100-12-31';
    const q = document.getElementById('qSearch').value.toLowerCase();
    const timeData = rawData.filter(v => v.form_date >= start && v.form_date <= end);
    document.getElementById('valTotal').innerText = timeData.length;
    document.getElementById('valLinAn').innerText = timeData.filter(v=>v.store_branch=='è‡¨å®‰åº—').length;
    document.getElementById('valNanKe').innerText = timeData.filter(v=>v.store_branch=='å—ç§‘åº—').length;
    filteredData = timeData.filter(v => {
        if(currentStore !== 'å…¨éƒ¨' && v.store_branch !== currentStore) return false;
        if(q && !v.customer_name.toLowerCase().includes(q) && !(v.detail_desc||'').toLowerCase().includes(q)) return false;
        return true;
    });
    
    // ğŸ”¥ æ¸…ç©ºå…¨å±€éæ¿¾ç‹€æ…‹
    // ä¿æŒæ‰€æœ‰é–å®šæ¢ä»¶
    if (!globalFilter.sourceLocked) {
        globalFilter.source = null;
    }
    if (!globalFilter.purposeLocked) {
        globalFilter.purpose = null;
    }
    if (!globalFilter.genderLocked) {
        globalFilter.gender = null;
    }
    if (!globalFilter.ageLocked) {
        globalFilter.age = null;
    }
    
    displayLimit = 20; 
    renderCharts(filteredData); 
    renderTable(); 
    updateFilterBadges();
    updateAllCharts(); // ğŸ”¥ é—œéµï¼šåˆ‡æ›é–€åº—å¾Œé‡ç®—æ‰€æœ‰åœ–è¡¨
  };

  // ğŸ”¥ ä¿®æ”¹ï¼šrenderCharts - åªæ¸²æŸ“å®¢æºåœ–ï¼ˆå›ºå®šé †åº+å›ºå®šé¡è‰²ï¼‰
  function renderCharts(data) {
    const sMap = {}; 
    data.forEach(v => (v.source_tags||[]).forEach(t => sMap[t] = (sMap[t]||0)+1));
    
    // ğŸ”¥ æŒ‰ç…§å›ºå®šé †åºæ’åˆ—ï¼ˆä¸å†æŒ‰æ•¸é‡æ’åºï¼‰
    const orderedLabels = SOURCE_ORDER.filter(s => sMap[s] > 0);
    const orderedData = orderedLabels.map(s => sMap[s]);
    const orderedColors = orderedLabels.map(s => SOURCE_COLORS[s] || '#94a3b8');

    if(charts.source) charts.source.destroy();
    charts.source = new Chart(document.getElementById('chartSource'), {
        type: 'bar',
        data: { 
            labels: orderedLabels, 
            datasets: [{ 
                data: orderedData, 
                backgroundColor: orderedColors,
                borderRadius: 6,
                hoverBackgroundColor: orderedColors.map(c => c + 'dd')
            }] 
        },
        options: {
            indexAxis: 'y',
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: { 
                legend: {display: false}, 
                datalabels: { 
                    anchor:'end', 
                    align:'right', 
                    offset: 4,
                    formatter: (v,ctx) => {
                        const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                        return Math.round(v/total*100)+'%';
                    }, 
                    font:{size:11, weight:'bold'}, 
                    color:'#475569',
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    borderRadius: 4,
                    padding: { top: 2, bottom: 2, left: 4, right: 4 }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.85)',
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                x: { 
                    grid: { display: false },
                    ticks: { font: { size: 10 } }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { size: 11, weight: '600' } }
                }
            },
            onClick: (e, els) => { 
                if(els[0]) { 
                    const label = orderedLabels[els[0].index]; 
                    if (globalFilter.source === label) {
                        globalFilter.source = null;
                        globalFilter.sourceLocked = false;
                    } else {
                        globalFilter.source = label;
                        globalFilter.sourceLocked = true;
                    }
                    updateAllCharts();
                } 
            }
        }
    });
    
    updateAllCharts();
  }

  // ğŸ”¥ æ–°å¢ï¼šçµ±ä¸€æ›´æ–°æ‰€æœ‰åœ–è¡¨ï¼ˆå…¨é›™å‘é€£å‹•ï¼‰
  function updateAllCharts() {
    // æ ¹æ“š globalFilter ç¯©é¸æ•¸æ“š
    let subset = filteredData.filter(v => {
        if(globalFilter.source && !(v.source_tags||[]).includes(globalFilter.source)) return false;
        if(globalFilter.purpose && !(v.visit_purposes||[]).includes(globalFilter.purpose)) return false;
        if(globalFilter.gender && v.gender !== globalFilter.gender) return false;
        if(globalFilter.age && v.age_range !== globalFilter.age) return false;
        return true;
    });

    // ğŸ”¥ åå‘é€£å‹•ï¼šæ›´æ–°å®¢æºçµ±è¨ˆ
    const sMap_reverse = {}; 
    subset.forEach(v => (v.source_tags||[]).forEach(t => sMap_reverse[t] = (sMap_reverse[t]||0) + 1));
    const orderedLabels_reverse = SOURCE_ORDER.filter(s => sMap_reverse[s] > 0);
    const orderedData_reverse = orderedLabels_reverse.map(s => sMap_reverse[s]);
    const orderedColors_reverse = orderedLabels_reverse.map(s => SOURCE_COLORS[s] || '#94a3b8');

    if (charts.source) {
        charts.source.data.labels = orderedLabels_reverse;
        charts.source.data.datasets[0].data = orderedData_reverse;
        charts.source.data.datasets[0].backgroundColor = orderedColors_reverse;
        charts.source.data.datasets[0].hoverBackgroundColor = orderedColors_reverse.map(c => c + 'dd');
        charts.source.update('active');
    }

    // æ›´æ–°éæ¿¾æ¨™ç±¤
    updateFilterBadges();

    // === ä¾†åº—ç›®çš„åœ–è¡¨ ===
    const pMap = {}; 
    subset.forEach(v => (v.visit_purposes||[]).forEach(p=>pMap[p]=(pMap[p]||0)+1));
    const sortedP = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const totalP = sortedP.reduce((a,b)=>a+b[1],0);
    
    const purposeColors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#f97316'];

    if(charts.purpose) {
        charts.purpose.data.labels = sortedP.map(x=>x[0]);
        charts.purpose.data.datasets[0].data = sortedP.map(x=>x[1]);
        charts.purpose.data.datasets[0].backgroundColor = purposeColors.slice(0, sortedP.length);
        charts.purpose.update('active');
    } else {
        charts.purpose = new Chart(document.getElementById('chartPurpose'), {
            type: 'doughnut',
            data: { 
                labels: sortedP.map(x=>x[0]), 
                datasets:[{ 
                    data:sortedP.map(x=>x[1]), 
                    backgroundColor: purposeColors.slice(0, sortedP.length),
                    borderWidth: 0, 
                    hoverOffset: 15
                }] 
            },
            options: { 
                maintainAspectRatio: false, 
                cutout: '60%', 
                layout: { padding: 20 },
                animation: { animateRotate: true, animateScale: true, duration: 800 },
                plugins:{ 
                    legend:{ 
                        display: true, 
                        position: 'right', 
                        labels:{
                            boxWidth:14, 
                            boxHeight:14, 
                            usePointStyle:true,
                            pointStyle: 'circle',
                            padding: 14, 
                            font: { size: 12, weight: '700' },
                            color: '#1e293b',
                            generateLabels: (chart) => {
                                 const data = chart.data;
                                 return data.labels.map((label, i) => {
                                     const val = data.datasets[0].data[i];
                                     const pct = totalP ? Math.round(val/totalP*100) : 0;
                                     
                                     return { 
                                         text: `${label}  ${pct}%`,
                                         fillStyle: data.datasets[0].backgroundColor[i],
                                         hidden: false, 
                                         index: i,
                                         fontColor: '#1e293b',
                                         pointStyle: 'circle'
                                     };
                                 });
                            }
                        }
                    }, 
                    datalabels: { display: false },
                    tooltip: { 
                        backgroundColor: 'rgba(0,0,0,0.85)', 
                        padding: 14, 
                        cornerRadius: 8,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: { label: (ctx) => ` ${ctx.label}: ${ctx.raw} äºº (${Math.round(ctx.raw/totalP*100)}%)` } 
                    }
                },
                onClick: (e, els) => {
                    if(els[0]) {
                        const label = sortedP[els[0].index][0];
                        if (globalFilter.purpose === label) {
                            globalFilter.purpose = null;
                            globalFilter.purposeLocked = false;
                        } else {
                            globalFilter.purpose = label;
                            globalFilter.purposeLocked = true;
                        }
                        updateAllCharts();
                    }
                }
            }
        });
    }

    // === è¶¨å‹¢åœ–è¡¨ ===
    const tMap = {}; 
    subset.forEach(v => { const m = v.form_date.slice(0,7); tMap[m]=(tMap[m]||0)+1; });
    const sortedT = Object.keys(tMap).sort();
    const maxTrendValue = Math.max(...sortedT.map(k=>tMap[k]), 1);
    const suggestedMaxTrend = Math.ceil(maxTrendValue * 1.2);
    
    if(charts.trend) {
        charts.trend.data.labels = sortedT;
        charts.trend.data.datasets[0].data = sortedT.map(k=>tMap[k]);
        charts.trend.options.scales.y.suggestedMax = suggestedMaxTrend;
        charts.trend.update('active');
    } else {
        charts.trend = new Chart(document.getElementById('chartTrend'), {
            type: 'line',
            data: { 
                labels: sortedT, 
                datasets:[{ 
                    data:sortedT.map(k=>tMap[k]), 
                    borderColor:'#f59e0b', 
                    borderWidth:2.5, 
                    pointBackgroundColor:'#fff', 
                    pointBorderColor:'#f59e0b', 
                    pointRadius:5, 
                    pointHoverRadius:7, 
                    tension:0.4, 
                    fill:true, 
                    backgroundColor:'rgba(245,158,11,0.15)' 
                }] 
            },
            options: { 
                maintainAspectRatio: false, 
                animation: { duration: 800, easing: 'easeInOutQuart' },
                scales:{
                    x:{
                        grid:{display:false},
                        ticks: { font: { size: 10 } }
                    }, 
                    y:{
                        beginAtZero: true,
                        suggestedMax: suggestedMaxTrend,
                        grid:{borderDash:[5,5], color:'#f1f5f9'},
                        ticks: { font: { size: 10 } }
                    }
                }, 
                plugins:{
                    legend:{display:false}, 
                    datalabels: {
                        align: 'top',
                        anchor: 'end',
                        offset: 4,
                        font: { size: 10, weight: 'bold' },
                        color: '#f59e0b',
                        backgroundColor: 'rgba(255,255,255,0.9)',
                        borderRadius: 4,
                        padding: { top: 2, bottom: 2, left: 3, right: 3 },
                        formatter: (v) => v
                    },
                    tooltip: { 
                        backgroundColor: 'rgba(0,0,0,0.8)', 
                        padding: 10, 
                        cornerRadius: 6,
                        callbacks: { label: (ctx) => ` å®¢æ•¸: ${ctx.raw} äºº` }
                    } 
                } 
            }
        });
    }
    
    // === æ€§åˆ¥åœ–è¡¨ ===
    const gMap = { 'ç”·':0, 'å¥³':0 };
    subset.forEach(v => { 
        const g = v.gender || 'å…¶ä»–'; 
        if(g === 'ç”·' || g === 'å¥³') gMap[g]++; 
    });
    
    if(charts.gender) {
        charts.gender.data.datasets[0].data = [gMap['ç”·'], gMap['å¥³']];
        charts.gender.update('active');
    } else {
        charts.gender = new Chart(document.getElementById('chartGender'), { 
            type: 'doughnut', 
            data: { 
                labels: ['ç”·','å¥³'], 
                datasets: [{ 
                    data: [gMap['ç”·'], gMap['å¥³']], 
                    backgroundColor:['#60a5fa','#f472b6'], 
                    hoverOffset: 10 
                }] 
            }, 
            options: { 
                maintainAspectRatio: false, 
                cutout: '60%', 
                animation: { animateRotate: true, duration: 600 },
                plugins: { 
                    legend:{
                        position:'right', 
                        labels: { 
                            font: { size: 13, weight: '600' }, 
                            padding: 12 
                        }
                    }, 
                    tooltip: { 
                        backgroundColor: 'rgba(0,0,0,0.8)', 
                        padding: 10, 
                        cornerRadius: 6 
                    },
                    datalabels: { display: false }
                },
                onClick: (e, els) => {
                    if(els[0]) {
                        const label = els[0].index === 0 ? 'ç”·' : 'å¥³';
                        if (globalFilter.gender === label) {
                            globalFilter.gender = null;
                            globalFilter.genderLocked = false;
                        } else {
                            globalFilter.gender = label;
                            globalFilter.genderLocked = true;
                        }
                        updateAllCharts();
                    }
                }
            } 
        });
    }
    
    // === å¹´é½¡åœ–è¡¨ ===
    const aMap = {};
    subset.forEach(v => { 
        const a = v.age_range || 'æœªå¡«'; 
        if(a !== 'æœªå¡«') aMap[a] = (aMap[a]||0)+1; 
    });
    
    const sortedAges = AGES.filter(age => aMap[age] > 0);
    
    if(charts.age) {
        charts.age.data.labels = sortedAges;
        charts.age.data.datasets[0].data = sortedAges.map(age => aMap[age]);
        charts.age.update('active');
    } else {
        charts.age = new Chart(document.getElementById('chartAge'), { 
            type: 'bar', 
            data: { 
                labels: sortedAges, 
                datasets: [{ 
                    label:'äººæ•¸', 
                    data: sortedAges.map(age => aMap[age]),
                    backgroundColor:'#cbd5e1', 
                    borderRadius:6, 
                    hoverBackgroundColor: '#94a3b8' 
                }] 
            }, 
            options: { 
                maintainAspectRatio: false, 
                indexAxis: 'y', 
                animation: { duration: 600, easing: 'easeOutQuart' },
                plugins: { 
                    legend:{display:false}, 
                    tooltip: { 
                        backgroundColor: 'rgba(0,0,0,0.8)', 
                        padding: 10, 
                        cornerRadius: 6 
                    },
                    datalabels: { display: false }
                }, 
                scales: { 
                    x: { 
                        grid: { display: false },
                        ticks: { font: { size: 10 } }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { font: { size: 11, weight: '600' } }
                    }
                },
                onClick: (e, els) => {
                    if(els[0]) {
                        const label = sortedAges[els[0].index];
                        if (globalFilter.age === label) {
                            globalFilter.age = null;
                            globalFilter.ageLocked = false;
                        } else {
                            globalFilter.age = label;
                            globalFilter.ageLocked = true;
                        }
                        updateAllCharts();
                    }
                }
            } 
        });
    }
  }

  // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°éæ¿¾æ¨™ç±¤é¡¯ç¤º
  function updateFilterBadges() {
      const container = document.getElementById('filterBadgesContainer');
      const badges = [];
      
      if(globalFilter.source) {
          badges.push(`<div class="filter-badge">
              <span>å®¢æº: ${globalFilter.source}</span>
              <span class="filter-badge-close" onclick="clearFilter('source')">âœ•</span>
          </div>`);
      }
      
      if(globalFilter.purpose) {
          badges.push(`<div class="filter-badge">
              <span>ç›®çš„: ${globalFilter.purpose}</span>
              <span class="filter-badge-close" onclick="clearFilter('purpose')">âœ•</span>
          </div>`);
      }
      
      if(globalFilter.gender) {
          badges.push(`<div class="filter-badge">
              <span>æ€§åˆ¥: ${globalFilter.gender}</span>
              <span class="filter-badge-close" onclick="clearFilter('gender')">âœ•</span>
          </div>`);
      }
      
      if(globalFilter.age) {
          badges.push(`<div class="filter-badge">
              <span>å¹´é½¡: ${globalFilter.age}</span>
              <span class="filter-badge-close" onclick="clearFilter('age')">âœ•</span>
          </div>`);
      }
      
      if(badges.length > 0) {
          container.innerHTML = badges.join('');
          container.classList.remove('hidden');
      } else {
          container.classList.add('hidden');
      }
  }

  // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤å–®å€‹éæ¿¾æ¢ä»¶
  window.clearFilter = (type) => {
      globalFilter[type] = null;
      if (type === 'source') globalFilter.sourceLocked = false;
      else if (type === 'purpose') globalFilter.purposeLocked = false;
      else if (type === 'gender') globalFilter.genderLocked = false;
      else if (type === 'age') globalFilter.ageLocked = false;
      updateAllCharts();
  };

  function renderTable() {
      const tbody = document.getElementById('tableBody'), page = filteredData.slice(0, displayLimit); tbody.innerHTML = '';
      page.forEach(v => {
          const tr = document.createElement('tr');
          const safeDesc = (v.detail_desc||'ç„¡å‚™è¨»').replace(/'/g, "\\'").replace(/\n/g, ' ');
          tr.innerHTML = `
             <td class="pl-6 py-3 font-mono text-slate-500">${v.form_date}</td>
             <td><span class="px-2 py-1 rounded-full text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${v.store_branch}</span></td>
             <td class="font-bold text-slate-800">${v.customer_name}</td>
             <td class="text-xs text-slate-500">${v.gender||'-'} / ${v.age_range||'-'}</td>
             <td class="text-xs text-slate-500 max-w-[120px] truncate">${(v.source_tags||[]).join(', ')}</td>
             <td class="text-xs text-slate-500 max-w-[120px] truncate">${(v.visit_purposes||[]).join(', ')}</td>
             <td class="text-slate-300">â€º</td>
          `;
          tr.addEventListener('click', () => showDetail(v.id)); 
          tr.addEventListener('mouseenter', (e) => showPreview(e, safeDesc)); 
          tr.addEventListener('mouseleave', hidePreview); 
          tbody.appendChild(tr);
      });
      document.getElementById('listCounter').innerText = `${page.length} / ${filteredData.length}`;
      document.getElementById('btnLoadMore').classList.toggle('hidden', page.length >= filteredData.length);
  }

  window.showPreview = (e, text) => { 
      if(!text || text === 'null' || text === 'ç„¡å‚™è¨»') return; 
      const tooltip = document.getElementById('hoverPreview'); 
      tooltip.innerText = text.length > 120 ? text.slice(0,120)+'...' : text; 
      tooltip.style.display = 'block'; 
      tooltip.style.left = Math.min(e.clientX + 15, window.innerWidth - 360) + 'px'; 
      tooltip.style.top = (e.clientY + 15) + 'px'; 
  };
  window.hidePreview = () => document.getElementById('hoverPreview').style.display = 'none';

  window.previewCSV = (input) => {
    const f = input.files[0]; if(!f) return;
    Papa.parse(f, { header:true, skipEmptyLines:true, complete: async (res) => {
       const total = res.data.length;
       if(!confirm(`å³å°‡åŒ¯å…¥ ${total} ç­†è³‡æ–™ï¼Œç¢ºèªç¹¼çºŒï¼Ÿ`)) return;
       
       const overlay = document.getElementById('importOverlay');
       const progress = document.getElementById('importProgress');
       const status = document.getElementById('importStatus');
       const errLog = document.getElementById('importErrors');
       overlay.style.display = 'flex';
       errLog.innerHTML = ''; errLog.classList.add('hidden');
       
       const cleanData = res.data.map((row, idx) => {
          let d = row['form_date']||row['å¡«è¡¨æ—¥æœŸ']; 
          if(!d) { console.warn(`Row ${idx}: Missing date`); return null; }
          
          d = d.trim().replace(/\//g, '-');
          const dateParts = d.split('-');
          if(dateParts.length === 3) {
              const year = dateParts[0];
              const month = dateParts[1].padStart(2, '0');
              const day = dateParts[2].padStart(2, '0');
              d = `${year}-${month}-${day}`;
          }
          
          const n = row['customer_name']||row['é¡§å®¢å§“å'];
          if(!n) { console.warn(`Row ${idx}: Missing name`); return null; }
          
          const invalidNames = ['ç¾å ´å®¢', 'èª¿æ•´å®¢', 'ç¾å ´é¡§å®¢', 'çœ‹çœ‹å®¢', 'é›»è©±å®¢', 'è«®è©¢å®¢', 'ä½æˆ¶', 'ç„¡', 'ä¸çŸ¥', '-', 'æœªçŸ¥'];
          const cleanName = invalidNames.includes(n.trim()) ? 'æœªç•™è³‡æ–™' : n;
          
          let sRaw = row['source_tags']||row['ä¾†æºçµ±è¨ˆ']||'';
          sRaw = sRaw.replace(/ï¼Œ/g, ',');
          
          let pRaw = row['visit_purposes']||row['ä¾†åº—ç›®çš„']||'';
          pRaw = pRaw.replace(/ï¼Œ/g, ',');
          
          let cleanAge = row['age_range']||row['å¹´é½¡ç¯„åœ']||'';
          if(cleanAge === '18ä»¥ä¸‹') cleanAge = '18æ­²ä»¥ä¸‹';

          return { 
              p_date: d, 
              p_store: row['store_branch']||row['é–€åº—']||'è‡¨å®‰åº—', 
              p_name: cleanName, 
              p_gender: row['gender']||row['æ€§åˆ¥']||'',
              p_age: cleanAge,
              p_is_local: (row['is_local']||row['æ˜¯å¦ç‚ºå°å—äºº']||'').includes('æ˜¯'),
              p_sources: sRaw.split(',').map(x=>x.trim()).filter(x=>x), 
              p_purposes: pRaw.split(',').map(x=>x.trim()).filter(x=>x), 
              p_keywords: row['search_keywords']||row['æœå°‹é—œéµå­—']||'',
              p_detail: row['detail_desc']||row['è©³ç´°æè¿°']||'' 
          };
       }).filter(x=>x);

       let processed = 0, errors = [];
       for(let i = 0; i < cleanData.length; i++) {
          const row = cleanData[i];
          try {
              const { error } = await supabase.rpc('submit_visit_v7', row);
              if(error) throw error;
          } catch(err) {
              errors.push(`${row.p_date} ${row.p_name}: ${err.message}`);
          }
          processed++;
          progress.style.width = Math.round(processed/cleanData.length*100) + '%';
          status.innerText = `è™•ç†ä¸­... ${processed} / ${cleanData.length}`;
       }
       
       status.innerText = `âœ… å®Œæˆï¼æˆåŠŸ: ${cleanData.length - errors.length} | å¤±æ•—: ${errors.length}`;
       if(errors.length > 0) {
           errLog.classList.remove('hidden');
           errLog.innerHTML = '<div class="font-bold mb-2">ä»¥ä¸‹è³‡æ–™åŒ¯å…¥å¤±æ•—ï¼š</div>' + errors.map(e => `<div class="mb-1">â€¢ ${e}</div>`).join('');
       }
       
       setTimeout(() => { 
           overlay.style.display='none'; 
           if(errors.length === 0) location.reload(); 
           else alert(`åŒ¯å…¥å®Œæˆï¼Œä½†æœ‰ ${errors.length} ç­†å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤è¨˜éŒ„ã€‚`);
       }, 2000);
    }});
  };

  window.loginSupabase = async () => {
      const email = document.getElementById('admEmail').value.trim();
      const pwd = document.getElementById('admPwd').value;
      
      if(!email || !pwd) {
          alert('è«‹è¼¸å…¥ä¿¡ç®±å’Œå¯†ç¢¼');
          return;
      }
      
      const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: pwd
      });
      
      if(error) {
          alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
      } else {
          enableAdminUI();
          alert('âœ… ç™»å…¥æˆåŠŸï¼');
      }
  };

  window.logout = async () => {
      await supabase.auth.signOut();
      isAdmin = false;
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminActions').classList.add('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('admEmail').value = '';
      document.getElementById('admPwd').value = '';
      alert('å·²ç™»å‡ºç®¡ç†æ¨¡å¼');
  };

  function enableAdminUI() { 
      isAdmin = true; 
      document.getElementById('adminPanel').classList.remove('hidden'); 
      document.getElementById('loginForm').classList.add('hidden'); 
      document.getElementById('adminActions').classList.remove('hidden'); 
      document.getElementById('logoutBtn').classList.remove('hidden');
  }

  window.exportCSV = () => { 
      const csv = Papa.unparse(rawData); 
      const link = document.createElement("a"); 
      link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'})); 
      link.download = `wakodo_backup_${new Date().toISOString().slice(0,10)}.csv`; 
      document.body.appendChild(link); 
      link.click(); 
      document.body.removeChild(link); 
  };

  window.wipeData = async () => { 
      if(!isAdmin) {
          alert('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼');
          return;
      }
      alert('âš ï¸ å®‰å…¨æ©Ÿåˆ¶ï¼šç³»çµ±å°‡å¼·åˆ¶ä¸‹è¼‰å‚™ä»½ CSVã€‚'); 
      exportCSV(); 
      setTimeout(async () => {
          if(!confirm('å‚™ä»½å·²ä¸‹è¼‰ã€‚ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
          const pwd = prompt('è«‹è¼¸å…¥äºŒæ¬¡ç¢ºèªå¯†ç¢¼ï¼š');
          if(pwd === '628599') { 
              const { error } = await supabase.from('visits').delete().neq('id', 0); 
              if(error) alert('å¤±æ•—: '+error.message); 
              else { alert('âœ… è³‡æ–™åº«å·²æ¸…ç©ºã€‚'); location.reload(); } 
          } else { alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼'); }
      }, 1500); 
  };

  window.setStore = (s) => { 
      currentStore = s; 
      document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active')); 
      if(s=='å…¨éƒ¨')document.getElementById('kpiTotal').classList.add('active'); 
      if(s=='è‡¨å®‰åº—')document.getElementById('kpiLinAn').classList.add('active'); 
      if(s=='å—ç§‘åº—')document.getElementById('kpiNanKe').classList.add('active'); 
      applyFilter(); 
  };
  
  window.loadMore = () => { displayLimit+=20; renderTable(); };
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  
  window.showDetail = (id) => { 
      const v = rawData.find(x => x.id === parseInt(id)); 
      if(!v) return; 
      document.getElementById('detailContent').innerHTML=`
         <h2 class="font-bold text-2xl mb-3 text-slate-800">${v.customer_name}</h2>
         <p class="text-sm text-gray-500 mb-4 flex items-center gap-2">
            <span class="px-2 py-1 rounded-full text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${v.store_branch}</span>
            <span>${v.form_date}</span>
            <span>â€¢</span>
            <span>${v.gender||'-'} / ${v.age_range||'-'}</span>
         </p>
         <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-blue-50 p-3 rounded-lg">
               <div class="text-xs font-bold text-blue-700 mb-1">å®¢æº</div>
               <div class="text-sm text-blue-900">${(v.source_tags||[]).join(', ') || 'ç„¡'}</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
               <div class="text-xs font-bold text-green-700 mb-1">ç›®çš„</div>
               <div class="text-sm text-green-900">${(v.visit_purposes||[]).join(', ') || 'ç„¡'}</div>
            </div>
         </div>
         ${v.search_keywords ? `<div class="bg-yellow-50 p-3 rounded-lg mb-3 border border-yellow-200"><div class="text-xs font-bold text-yellow-700 mb-1">ğŸ” æœå°‹é—œéµå­—</div><div class="text-sm text-yellow-900">${v.search_keywords}</div></div>` : ''}
         <div class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${v.detail_desc||'ç„¡è©³ç´°æè¿°'}</div>
      `; 
      document.getElementById('detailModal').style.display='flex'; 
      if(isAdmin) {
          document.getElementById('detailActions').classList.remove('hidden'); 
      } else {
          document.getElementById('detailActions').classList.add('hidden'); 
      }
      window.currentDetailId = v.id; 
  };
  
  window.closeDetail = () => document.getElementById('detailModal').style.display='none';
  
  window.deleteCurrentDetail = async () => { 
      if(!isAdmin) {
          alert('âš ï¸ éœ€è¦ç®¡ç†å“¡æ¬Šé™æ‰èƒ½åˆªé™¤ï¼');
          return;
      }
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return; 
      const { error } = await supabase.from('visits').delete().eq('id', window.currentDetailId); 
      if(error) alert('åˆªé™¤å¤±æ•—: ' + error.message); 
      else { alert('å·²åˆªé™¤'); closeDetail(); fetchAllData(); } 
  };

  /* =====================================================
     V8.0.3 è£œä¸ï¼šé–å®šæ©Ÿåˆ¶ + åœ–è¡¨é»æ“Šé‡æ–°ç¶å®š
     ===================================================== */

  // çµ±ä¸€é–å®šåˆ‡æ›å‡½æ•¸
  window.toggleLock = (type, value) => {
    const lockKey = type + 'Locked';
    if (!globalFilter) return;

    if (globalFilter[type] === value) {
      globalFilter[type] = null;
      if (lockKey in globalFilter) globalFilter[lockKey] = false;
    } else {
      globalFilter[type] = value;
      if (lockKey in globalFilter) globalFilter[lockKey] = true;
    }
    updateAllCharts();
  };

  // é‡æ–°ç¶å®šæ‰€æœ‰åœ–è¡¨é»æ“Šäº‹ä»¶
  function bindChartClicks() {
    if (!window.charts) return;

    if (charts.source && charts.source.options) {
      charts.source.options.onClick = (e, els) => {
        if (!els || !els.length) return;
        const label = charts.source.data.labels[els[0].index];
        window.toggleLock('source', label);
      };
      charts.source.update('none');
    }

    if (charts.purpose && charts.purpose.options) {
      charts.purpose.options.onClick = (e, els) => {
        if (!els || !els.length) return;
        const label = charts.purpose.data.labels[els[0].index];
        window.toggleLock('purpose', label);
      };
      charts.purpose.update('none');
    }

    if (charts.gender && charts.gender.options) {
      charts.gender.options.onClick = (e, els) => {
        if (!els || !els.length) return;
        const label = (els[0].index === 0) ? 'ç”·' : 'å¥³';
        window.toggleLock('gender', label);
      };
      charts.gender.update('none');
    }

    if (charts.age && charts.age.options) {
      charts.age.options.onClick = (e, els) => {
        if (!els || !els.length) return;
        const label = charts.age.data.labels[els[0].index];
        window.toggleLock('age', label);
      };
      charts.age.update('none');
    }
  }

  // åŒ…è£ updateAllCharts
  if (typeof window.updateAllCharts === 'function') {
    const __origUpdateAllCharts = window.updateAllCharts;
    window.updateAllCharts = function() {
      __origUpdateAllCharts();
      bindChartClicks();
      updateFilterBadges();
    };
  }

  // åŒ…è£ renderCharts
  if (typeof window.renderCharts === 'function') {
    const __origRenderCharts = window.renderCharts;
    window.renderCharts = function(data) {
      __origRenderCharts(data);
      bindChartClicks();
    };
  }

  // åŒ…è£ applyFilter
  if (typeof window.applyFilter === 'function') {
    const __origApplyFilter = window.applyFilter;
    window.applyFilter = function() {
      __origApplyFilter();
      if (typeof window.updateAllCharts === 'function') {
        window.updateAllCharts();
      }
    };
  }

  // åˆå§‹åŒ–ï¼šç¢ºä¿é–å®šæ——æ¨™å­˜åœ¨
  if (typeof globalFilter === 'object' && globalFilter) {
    if (globalFilter.sourceLocked === undefined) globalFilter.sourceLocked = false;
    if (globalFilter.purposeLocked === undefined) globalFilter.purposeLocked = false;
    if (globalFilter.genderLocked === undefined) globalFilter.genderLocked = false;
    if (globalFilter.ageLocked === undefined) globalFilter.ageLocked = false;
  }


</script>
</body>
</html>
