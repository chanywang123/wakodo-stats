<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V5.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- å¼•å…¥ Flatpickr (Agoda é¢¨æ ¼æ—¥æœŸé¸æ“‡å™¨) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    // è«‹ç¢ºèªæ‚¨çš„ URL å’Œ Key æ˜¯æ­£ç¢ºçš„
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    :root { 
      --bg: #f3f4f6; 
      --card: #ffffff; 
      --text: #1f2937; 
      --accent: #2563eb; 
      --table-header-bg: #fcd34d; /* éµé»ƒè‰²æ¨™é¡Œ */
      --table-header-text: #000000;
      --row-hover: #fef9c3; /* æ·ºé»ƒè‰² hover */
    }
    
    body { background-color: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; }
    
    /* Agoda Style Date Picker Input */
    .date-range-container {
      display: flex; align-items: center; background: #fff; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer;
    }
    .date-range-input {
      border: none; padding: 10px 12px; font-size: 14px; outline: none; width: 220px; text-align: center; font-weight: 500; cursor: pointer;
    }
    
    .input-std { background: #fff; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; width: 100%; }
    .btn-primary { background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat.active { border-color: var(--accent); background: #eff6ff; }

    /* Table Styles */
    thead tr th { background-color: var(--table-header-bg) !important; color: var(--table-header-text) !important; font-weight: 800; }
    tbody tr { transition: background-color 0.1s; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
    tbody tr:hover { background-color: var(--row-hover) !important; }
    
    /* Admin Visibility */
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: flex !important; }
    /* Table cell fix for admin buttons */
    body.is-admin td.admin-only { display: table-cell !important; } 

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal-content { background: #fff; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 24px; border-radius: 12px; }
    .detail-row { display: flex; border-bottom: 1px solid #eee; padding: 12px 0; align-items: center; }
    .detail-label { width: 100px; font-weight: bold; color: #666; }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4">
  <!-- 1. Header & Version -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold tracking-tight text-blue-600 flex items-center gap-2">
        <span>ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</span>
        <!-- ç‰ˆæœ¬è™Ÿï¼šè—è‰²å­—é«” + æ—¥æœŸ -->
        <span class="text-sm font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">V5.4 â€¢ 2026/01/13</span>
      </h1>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-gray-800 p-2" title="ç®¡ç†å“¡">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden mb-6 card bg-gray-800 text-white border-0 shadow-xl">
    <div id="loginForm" class="flex gap-3 items-center">
      <input type="email" id="admEmail" value="chanywang92@gmail.com" class="input-std text-black" placeholder="Email">
      <input type="password" id="admPwd" class="input-std text-black" placeholder="Password">
      <button onclick="login()" class="btn-primary">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center justify-between w-full">
      <div class="font-bold text-green-400">âœ… ç®¡ç†å“¡æ¨¡å¼</div>
      <div class="flex gap-2">
        <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm flex items-center gap-1 text-white">
          <span>ğŸ“‚ åŒ¯å…¥ CSV (ç©©å¥ç‰ˆ)</span>
          <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="previewCSV(this)">
        </label>
        <button onclick="logout()" class="bg-red-600 text-white px-3 py-1.5 rounded text-sm">ç™»å‡º</button>
      </div>
      <button onclick="wipeData()" class="text-red-400 text-sm border border-red-400 px-3 py-1 rounded">âš ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
    </div>
  </div>

  <!-- 2. Filter Bar (Agoda Style) -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center sticky top-2 z-30 shadow-md">
    <div class="date-range-container">
      <span class="pl-3 text-gray-400">ğŸ“…</span>
      <!-- é€™è£¡ç¶å®š Flatpickr -->
      <input type="text" id="dateRange" class="date-range-input" placeholder="é¸æ“‡æ—¥æœŸå€é–“">
    </div>
    
    <div class="flex-grow relative">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€æ‰‹æ©Ÿã€å‚™è¨»..." class="input-std pl-9" onkeyup="if(event.key==='Enter') fetchData()">
      <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
      <button onclick="clearSearch()" id="btnClearSearch" class="hidden absolute right-2 top-2.5 text-gray-400 font-bold">âœ•</button>
    </div>
    <button onclick="fetchData()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div onclick="setStore('å…¨éƒ¨')" id="btnTotal" class="card btn-stat flex flex-col justify-center items-center active py-6"><div class="text-xs font-bold text-gray-500 mb-1">ç¸½å®¢æ•¸</div><div class="text-4xl font-extrabold text-gray-800" id="statTotal">--</div></div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="btnLinAn" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">è‡¨å®‰åº—</div><div class="text-4xl font-extrabold text-blue-600" id="statLinAn">--</div></div>
    <div onclick="setStore('å—ç§‘åº—')" id="btnNanKe" class="card btn-stat flex flex-col justify-center items-center py-6"><div class="text-xs font-bold text-gray-500 mb-1">å—ç§‘åº—</div><div class="text-4xl font-extrabold text-green-600" id="statNanKe">--</div></div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">å®¢æºåˆ†æ</h3><select id="sourceFilter" onchange="filterSource()" class="border rounded text-xs p-1"><option value="ALL">å…¨éƒ¨</option></select></div>
      <div class="flex-grow relative"><canvas id="chartSource"></canvas></div>
      <div id="trendBox" class="hidden mt-4 h-24 w-full"><div class="text-xs font-bold text-gray-400">è¶¨å‹¢: <span id="trendLabel"></span></div><div class="relative w-full h-full"><canvas id="chartTrend"></canvas></div></div>
    </div>
    <div class="card h-[450px] flex flex-col">
      <div class="flex justify-between mb-4"><h3 class="font-bold">ä¾†åº—ç›®çš„</h3></div>
      <div class="flex-grow relative flex justify-center"><canvas id="chartPurpose"></canvas></div>
    </div>
  </div>

  <!-- Table (å‰å°åªé¡¯ç¤ºæœ€æ–° 10 ç­† + æ›´å¤šæŒ‰éˆ•) -->
  <div class="card overflow-hidden shadow-lg border-0 p-0">
    <div class="p-4 bg-white border-b flex justify-between">
      <h3 class="font-bold text-lg text-gray-800">æœ€æ–°ä¾†å®¢ç´€éŒ„</h3>
      <span class="text-xs text-gray-400" id="recordCountDisplay">é¡¯ç¤ºæœ€æ–° 10 ç­†</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead>
          <tr>
            <th class="p-3 pl-4">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 pr-4 admin-only text-right" style="width: 80px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-white"></tbody>
      </table>
    </div>
    <!-- Load More Button -->
    <div class="p-4 text-center border-t bg-gray-50">
        <button onclick="loadMore()" id="btnLoadMore" class="text-blue-600 font-bold text-sm hover:underline">â¬‡ï¸ è¼‰å…¥æ›´å¤š (20ç­†)</button>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div id="detailModal" class="modal-overlay">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h2 class="text-xl font-bold">è©³ç´°è³‡æ–™</h2>
      <div class="flex gap-2">
        <button onclick="toggleEditMode()" class="admin-only bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm font-bold">ç·¨è¼¯</button>
        <button onclick="closeDetailModal()" class="text-2xl text-gray-400">&times;</button>
      </div>
    </div>
    <!-- View Mode -->
    <div id="detailView"></div>
    <!-- Edit Mode -->
    <div id="detailEdit" class="hidden space-y-3">
      <input type="hidden" id="eId">
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><input type="date" id="eDate" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><select id="eStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><input type="text" id="eName" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">å®¢æº(é€—è™Ÿéš”é–‹)</div><input type="text" id="eSources" class="input-std"></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„(é€—è™Ÿéš”é–‹)</div><input type="text" id="ePurposes" class="input-std"></div>
      <div class="detail-row flex-col items-start"><div class="detail-label mb-2">å‚™è¨»</div><textarea id="eDetail" class="input-std h-24"></textarea></div>
      <button onclick="saveEdit()" class="btn-primary w-full bg-green-600 hover:bg-green-700">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="text-xl font-bold mb-4">æ–°å¢è³‡æ–™</h2>
    <div class="space-y-3">
      <input type="date" id="mDate" class="input-std">
      <select id="mStore" class="input-std"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select>
      <input type="text" id="mName" class="input-std" placeholder="å§“å">
      <input type="text" id="mSources" class="input-std" placeholder="å®¢æº (å¯è¤‡é¸)">
      <input type="text" id="mPurposes" class="input-std" placeholder="ç›®çš„ (å¯è¤‡é¸)">
      <textarea id="mDetail" class="input-std" placeholder="å‚™è¨»"></textarea>
      <button onclick="saveData()" class="btn-primary w-full">å„²å­˜</button>
      <button onclick="closeModal()" class="w-full text-center text-sm text-gray-500 mt-2">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
  let visits = [], stats = {}, currentStore = 'å…¨éƒ¨', savedSourceFilter = 'ALL', charts = {};
  let currentLimit = 10; // åˆå§‹åªé¡¯ç¤º 10 ç­†
  let datePicker;

  window.onload = async () => {
    // 1. åˆå§‹åŒ– Flatpickr æ—¥æœŸé¸æ“‡å™¨ (Agoda Style)
    const today = new Date();
    const lastMonth = new Date(); lastMonth.setMonth(today.getMonth() - 1);
    
    datePicker = flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        defaultDate: [lastMonth, today],
        locale: "zh_tw",
        onClose: function(selectedDates, dateStr, instance) {
            if(selectedDates.length === 2) fetchData();
        }
    });

    // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    const { data: { session } } = await supabase.auth.getSession();
    if(session) {
        document.body.classList.add('is-admin');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminActions').classList.remove('hidden');
    }

    // 3. åˆå§‹è¼‰å…¥
    fetchData();
  };

  window.fetchData = async () => {
    const dates = document.getElementById('dateRange').value.split(' è‡³ ');
    const from = dates[0] || '2023-01-01';
    const to = dates[1] || dates[0] || new Date().toISOString().split('T')[0];
    const key = document.getElementById('qSearch').value;
    
    // UI Update
    if(key) document.getElementById('btnClearSearch').classList.remove('hidden');
    
    // æ•¸æ“šè¼‰å…¥ä¸­æç¤º
    document.getElementById('statTotal').innerText = '...';

    // å‘¼å« Supabase RPC
    const { data, error } = await supabase.rpc('get_visits_public', { 
        start_date: from, 
        end_date: to, 
        keyword: key, 
        store_filter: currentStore 
    });

    if(error) {
        console.error(error);
        alert('è®€å–è³‡æ–™éŒ¯èª¤: ' + error.message);
        return;
    }

    if(data) {
      visits = data;
      // æ›´æ–°çµ±è¨ˆæ•¸å­—
      document.getElementById('statTotal').innerText = visits.length;
      document.getElementById('statLinAn').innerText = visits.filter(x=>x.store_branch=='è‡¨å®‰åº—').length;
      document.getElementById('statNanKe').innerText = visits.filter(x=>x.store_branch=='å—ç§‘åº—').length;
      
      // é‡ç½®é¡¯ç¤ºæ•¸é‡
      currentLimit = 10;
      renderAll();
    }
  };

  function renderAll() {
    // 1. è™•ç†åœ–è¡¨ (Charts)
    let list = visits;
    if(savedSourceFilter !== 'ALL') {
      list = visits.filter(v => (v.source_tags||[]).includes(savedSourceFilter));
      document.getElementById('trendBox').classList.remove('hidden');
      document.getElementById('trendLabel').innerText = savedSourceFilter;
      renderTrend(savedSourceFilter);
    } else {
      document.getElementById('trendBox').classList.add('hidden');
    }

    const sMap = {}, pMap = {};
    list.forEach(v => {
      (v.source_tags||[]).forEach(x => sMap[x] = (sMap[x]||0)+1);
      (v.visit_purposes||[]).forEach(x => pMap[x] = (pMap[x]||0)+1);
    });

    // ç‚ºäº†ç¾è§€ï¼Œåœ–è¡¨åªé¡¯ç¤ºå‰ 10 å
    const sortedSource = Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    const sortedPurpose = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0, 8);

    renderChart('chartSource', 'bar', sortedSource, 'å®¢æºTop15');
    renderChart('chartPurpose', 'doughnut', sortedPurpose, 'ç›®çš„åˆ†ä½ˆ');

    // Update Dropdown (é¿å…é‡è¤‡æ¸²æŸ“å°è‡´é–ƒçˆï¼Œé€™è£¡åšå€‹ç°¡å–®åˆ¤æ–·)
    const sel = document.getElementById('sourceFilter');
    if(sel.options.length <= 1 || savedSourceFilter === 'ALL') {
        sel.innerHTML = '<option value="ALL">å…¨éƒ¨</option>';
        Object.keys(sMap).sort().forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`);
        sel.value = savedSourceFilter;
    }

    // 2. æ¸²æŸ“è¡¨æ ¼ (åªé¡¯ç¤º currentLimit ç­†)
    renderTableList();
  }

  function renderTableList() {
    const tbody = document.getElementById('tableBody');
    // ä¾æ—¥æœŸæ’åº (æ–° -> èˆŠ)
    const sortedVisits = [...visits].sort((a, b) => new Date(b.form_date) - new Date(a.form_date));
    const visibleData = sortedVisits.slice(0, currentLimit);

    tbody.innerHTML = visibleData.map(v => `
      <tr data-id="${v.id}" onclick="showDetail(${v.id})">
        <td class="p-3 pl-4 font-mono text-gray-500">${v.form_date.slice(5)}</td>
        <td class="p-3"><span class="px-2 py-0.5 rounded text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${v.store_branch}</span></td>
        <td class="p-3 font-bold text-gray-900">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]" title="${(v.source_tags||[]).join(',')}">${(v.source_tags||[]).join(',')}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[100px]" title="${(v.visit_purposes||[]).join(',')}">${(v.visit_purposes||[]).join(',')}</td>
        <td class="p-3 pr-4 admin-only text-right" onclick="event.stopPropagation()">
            <button class="text-red-500 hover:bg-red-50 p-2 rounded font-bold" onclick="deleteData(${v.id})">åˆª</button>
        </td>
      </tr>
    `).join('');

    // æ›´æ–°ç­†æ•¸é¡¯ç¤º
    document.getElementById('recordCountDisplay').innerText = `é¡¯ç¤º ${visibleData.length} / ${visits.length} ç­†`;
    
    // æ§åˆ¶ "è¼‰å…¥æ›´å¤š" æŒ‰éˆ•
    if(visibleData.length >= visits.length) {
        document.getElementById('btnLoadMore').style.display = 'none';
    } else {
        document.getElementById('btnLoadMore').style.display = 'block';
    }
  }

  window.loadMore = () => {
    currentLimit += 20;
    renderTableList();
  };

  window.showDetail = (id) => {
    const v = visits.find(x => x.id == id);
    if(!v) return;
    
    // é–±è®€æ¨¡å¼
    document.getElementById('detailView').innerHTML = `
      <div class="detail-row"><div class="detail-label">æ—¥æœŸ</div><div>${v.form_date}</div></div>
      <div class="detail-row"><div class="detail-label">åˆ†åº—</div><div>${v.store_branch}</div></div>
      <div class="detail-row"><div class="detail-label">å§“å</div><div class="text-2xl font-bold text-blue-600">${v.customer_name}</div></div>
      <div class="detail-row"><div class="detail-label">å®¢æº</div><div class="flex flex-wrap gap-1">${(v.source_tags||[]).map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="detail-row"><div class="detail-label">ç›®çš„</div><div class="flex flex-wrap gap-1">${(v.visit_purposes||[]).map(t=>`<span class="bg-gray-100 px-2 rounded text-xs">${t}</span>`).join('')}</div></div>
      <div class="mt-4 p-4 bg-gray-50 rounded text-sm text-gray-600 whitespace-pre-wrap">${v.detail_desc||'ç„¡å‚™è¨»'}</div>
    `;
    
    // ç·¨è¼¯æ¨¡å¼å¡«å€¼
    document.getElementById('eId').value = v.id;
    document.getElementById('eDate').value = v.form_date;
    document.getElementById('eStore').value = v.store_branch;
    document.getElementById('eName').value = v.customer_name;
    document.getElementById('eSources').value = (v.source_tags||[]).join(',');
    document.getElementById('ePurposes').value = (v.visit_purposes||[]).join(',');
    document.getElementById('eDetail').value = v.detail_desc||'';
    
    // Reset to view mode
    document.getElementById('detailView').classList.remove('hidden');
    document.getElementById('detailEdit').classList.add('hidden');
    document.getElementById('detailModal').style.display = 'flex';
  };
  
  window.closeDetailModal = () => document.getElementById('detailModal').style.display='none';

  // --- CHART ---
  function renderChart(id, type, data, label) {
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: data.map(x=>x[0]),
        datasets: [{ 
            label: label, 
            data: data.map(x=>x[1]), 
            backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#6366f1','#ec4899'], 
            borderWidth:1,
            borderRadius: 4 // åœ“è§’
        }]
      },
      options: { 
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{ legend:{position:'right', labels: {boxWidth: 12}} } 
      }
    });
  }

  function renderTrend(tag) {
    const ctx = document.getElementById('chartTrend').getContext('2d');
    if(charts.trend) charts.trend.destroy();
    const map = {};
    // çµ±è¨ˆæ¯æœˆæ•¸é‡
    visits.filter(v=>(v.source_tags||[]).includes(tag)).forEach(v => {
      const m = v.form_date.slice(0,7); // YYYY-MM
      map[m] = (map[m]||0)+1;
    });
    const lbls = Object.keys(map).sort();
    charts.trend = new Chart(ctx, {
      type: 'line',
      data: { labels: lbls, datasets: [{ label:'æ•¸é‡', data:lbls.map(k=>map[k]), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.1)', fill:true, tension: 0.3 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
    });
  }

  // --- IMPORT FIX (ç©©å¥ç‰ˆ) ---
  window.previewCSV = (input) => {
    const f = input.files[0]; if(!f) return;
    const label = input.parentElement.querySelector('span');
    const oldText = label.innerText;
    label.innerText = 'è™•ç†ä¸­...';
    
    Papa.parse(f, {
      header: true, skipEmptyLines: true,
      complete: async (res) => {
        if(!confirm(`æº–å‚™åŒ¯å…¥ ${res.data.length} ç­†è³‡æ–™ï¼Ÿ`)) { label.innerText=oldText; return; }
        let success = 0;
        const chunkSize = 50; 
        for (let i = 0; i < res.data.length; i += chunkSize) {
            const chunk = res.data.slice(i, i + chunkSize);
            const promises = chunk.map(r => {
                const d = r['form_date']||r['å¡«è¡¨æ—¥æœŸ']; 
                const n = r['customer_name']||r['é¡§å®¢å§“å'];
                if(!d || !n) return null;
                const s = (r['ä¾†æºçµ±è¨ˆ']||r['source_tags']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                const p = (r['ä¾†åº—ç›®çš„']||r['visit_purposes']||'').split(/,|ï¼Œ|ã€/).map(x=>x.trim()).filter(x=>x);
                
                return supabase.rpc('submit_visit', {
                    p_date: d.replace(/\//g,'-'), p_store: r['store_branch']||r['é–€åº—']||'è‡¨å®‰åº—',
                    p_name: n, p_sources: s, p_purposes: p, p_gender:'', p_age:'', p_tainan:false, p_keyword:'', p_detail: r['detail_desc']||r['è©³ç´°æè¿°']||''
                });
            }).filter(p=>p);
            const results = await Promise.all(promises);
            success += results.filter(x => x && !x.error).length;
            label.innerText = `è™•ç†ä¸­...${i}/${res.data.length}`;
        }
        alert(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸ: ${success} ç­†`);
        label.innerText = oldText;
        input.value = '';
        fetchData();
      }
    });
  };

  // --- ADMIN ACTIONS ---
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  
  window.login = async () => {
    const { data, error } = await supabase.auth.signInWithPassword({ 
        email: document.getElementById('admEmail').value, 
        password: document.getElementById('admPwd').value 
    });
    if(error) alert(error.message);
    else { 
        document.body.classList.add('is-admin'); 
        document.getElementById('adminPanel').classList.add('hidden'); 
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('adminActions').classList.remove('hidden');
        alert("ç™»å…¥æˆåŠŸï¼");
        fetchData(); // é‡æ–°æ•´ç†ä»¥å•Ÿç”¨ç·¨è¼¯æŒ‰éˆ•
    }
  };

  window.logout = async () => { 
      await supabase.auth.signOut(); 
      document.body.classList.remove('is-admin'); 
      document.getElementById('adminActions').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
      alert("å·²ç™»å‡º");
  };

  window.wipeData = async () => { 
      if(prompt('è«‹è¼¸å…¥ admin ä»¥ç¢ºèªæ¸…ç©º') === 'admin') {
          const { error } = await supabase.from('visits').delete().neq('id', 0);
          if(error) alert(error.message);
          else { alert('è³‡æ–™å·²æ¸…ç©º'); fetchData(); }
      }
  };
  
  window.deleteData = async (id) => {
      // é›™é‡ç¢ºèª
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      
      const { error } = await supabase.from('visits').delete().eq('id', id);
      if(error) {
          alert('åˆªé™¤å¤±æ•—: ' + error.message);
      } else {
          // ä¸é‡æ–° fetchï¼Œç›´æ¥å¾å‰ç«¯ç§»é™¤ä»¥æå‡æ•ˆèƒ½
          visits = visits.filter(v => v.id != id);
          renderAll(); 
      }
  };

  // --- EDIT & ADD ---
  window.toggleEditMode = () => { 
      document.getElementById('detailView').classList.toggle('hidden'); 
      document.getElementById('detailEdit').classList.toggle('hidden'); 
  };
  
  window.saveEdit = async () => {
    const id = document.getElementById('eId').value;
    const updates = {
      form_date: document.getElementById('eDate').value, 
      store_branch: document.getElementById('eStore').value,
      customer_name: document.getElementById('eName').value, 
      source_tags: document.getElementById('eSources').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x),
      visit_purposes: document.getElementById('ePurposes').value.split(/,|ï¼Œ/).map(x=>x.trim()).filter(x=>x), 
      detail_desc: document.getElementById('eDetail').value
    };

    const { error } = await supabase.from('visits').update(updates).eq('id', id);
    if(error) {
        alert('æ›´æ–°å¤±æ•—: ' + error.message);
    } else { 
        alert('æ›´æ–°æˆåŠŸ'); 
        // æ›´æ–°å‰ç«¯è³‡æ–™
        const idx = visits.findIndex(v => v.id == id);
        if(idx !== -1) visits[idx] = { ...visits[idx], ...updates };
        
        document.getElementById('detailModal').style.display='none'; 
        renderAll(); 
    }
  };

  window.saveData = async () => {
    const { error } = await supabase.rpc('submit_visit', {
      p_date: document.getElementById('mDate').value, 
      p_store: document.getElementById('mStore').value,
      p_name: document.getElementById('mName').value, 
      p_sources: document.getElementById('mSources').value.split(/,|ï¼Œ/).filter(x=>x),
      p_purposes: document.getElementById('mPurposes').value.split(/,|ï¼Œ/).filter(x=>x), 
      p_detail: document.getElementById('mDetail').value,
      p_gender:'', p_age:'', p_tainan:false, p_keyword:''
    });
    if(error) alert('æ–°å¢å¤±æ•—: '+error.message);
    else { alert('æ–°å¢æˆåŠŸ'); closeModal(); fetchData(); }
  };

  // --- UI HELPERS ---
  window.setStore = s => { currentStore=s; document.querySelectorAll('.btn-stat').forEach(b=>b.classList.remove('active')); if(s=='å…¨éƒ¨')document.getElementById('btnTotal').classList.add('active'); if(s=='è‡¨å®‰åº—')document.getElementById('btnLinAn').classList.add('active'); if(s=='å—ç§‘åº—')document.getElementById('btnNanKe').classList.add('active'); fetchData(); };
  window.filterSource = () => { savedSourceFilter=document.getElementById('sourceFilter').value; renderAll(); };
  window.clearSearch = () => { document.getElementById('qSearch').value=''; document.getElementById('btnClearSearch').classList.add('hidden'); fetchData(); };
  window.openAddModal = () => { document.getElementById('mDate').value=new Date().toISOString().split('T')[0]; document.getElementById('modal').style.display='flex'; };
  window.closeModal = () => document.getElementById('modal').style.display='none';
</script>
</body>
</html>
