<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V6.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient("https://yxalpzculcyhzvnyvecb.supabase.co", "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k");
  </script>
  <style>
    :root { --accent: #2563eb; --row-hover: #fef9c3; }
    body { background: #f3f4f6; font-family: system-ui, sans-serif; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .btn-primary { background: var(--accent); color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; }
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat.active { border-color: var(--accent); background: #eff6ff; }
    .load-more-btn { width: 100%; padding: 12px; text-align: center; cursor: pointer; color: #9ca3af; background: #f9fafb; border-top: 1px solid #eee; }
    .load-more-btn:hover { color: var(--accent); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4 space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
      <span>ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</span>
      <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">V6.1</span>
    </h1>
    <div class="flex gap-2">
      <button onclick="toggleAdminPanel()" class="text-gray-400 p-2">âš™ï¸</button>
      <button onclick="openAddModal()" class="btn-primary">+ æ–°å¢</button>
    </div>
  </div>

  <!-- Admin Panel (Hidden) -->
  <div id="adminPanel" class="hidden card bg-gray-800 text-white">
    <div id="loginForm" class="flex gap-2"><input id="admPwd" type="password" class="p-2 rounded text-black" placeholder="å¯†ç¢¼"><button onclick="login()" class="btn-primary">ç™»å…¥</button></div>
    <div id="adminActions" class="hidden flex gap-4 items-center">
      <span class="text-green-400 font-bold">âœ… ç®¡ç†å“¡</span>
      <button onclick="exportCSV()" class="bg-blue-600 px-3 py-1 rounded text-sm">â¬‡ï¸ åŒ¯å‡º</button>
      <label class="cursor-pointer bg-gray-600 px-3 py-1 rounded text-sm">ğŸ“‚ åŒ¯å…¥ <input type="file" class="hidden" onchange="previewCSV(this)"></label>
      <button onclick="wipeData()" class="text-red-400 text-sm ml-auto border border-red-400 px-2 py-1 rounded">âš ï¸ æ¸…ç©º</button>
    </div>
  </div>

  <!-- Filter & KPIs -->
  <div class="card flex gap-3 sticky top-2 z-30 items-center shadow-md">
    <input id="dateRange" class="p-2 border rounded w-64 text-center font-bold" placeholder="æ—¥æœŸç¯„åœ">
    <button onclick="resetDate()" class="text-gray-400 hover:text-blue-600 font-bold px-2" title="é‡ç½®æ—¥æœŸ">â†º</button>
    <input id="qSearch" class="p-2 border rounded flex-grow" placeholder="æœå°‹..." onkeyup="if(event.key==='Enter') applyFilter()">
    <button onclick="applyFilter()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <div class="grid grid-cols-3 gap-4">
    <!-- ç¸½æ•¸é‚è¼¯ä¿®æ­£ï¼šé€™è£¡é¡¯ç¤ºçš„æ˜¯ã€Œå…¨éƒ¨åˆ†åº—ã€çš„å›ºå®šæ•¸å­—ï¼Œä¸å—ä¸‹æ–¹åˆ†åº—æŒ‰éˆ•å½±éŸ¿ -->
    <div class="card flex flex-col items-center py-6"><div class="text-xs text-gray-500">ç¸½å®¢æ•¸</div><div class="text-4xl font-bold" id="kpiTotal">--</div></div>
    <div class="card flex flex-col items-center py-6"><div class="text-xs text-gray-500">è‡¨å®‰åº—</div><div class="text-4xl font-bold text-blue-600" id="kpiLinAn">--</div></div>
    <div class="card flex flex-col items-center py-6"><div class="text-xs text-gray-500">å—ç§‘åº—</div><div class="text-4xl font-bold text-green-600" id="kpiNanKe">--</div></div>
  </div>

  <!-- Store Switcher (é€™åªå½±éŸ¿åœ–è¡¨å’Œåˆ—è¡¨) -->
  <div class="flex gap-2 justify-center">
    <button onclick="setStore('å…¨éƒ¨')" id="btnStoreAll" class="btn-stat active px-6 py-2 rounded-full bg-white font-bold shadow-sm">å…¨éƒ¨é–€å¸‚</button>
    <button onclick="setStore('è‡¨å®‰åº—')" id="btnStoreLin" class="btn-stat px-6 py-2 rounded-full bg-white font-bold shadow-sm text-blue-600">è‡¨å®‰åº—</button>
    <button onclick="setStore('å—ç§‘åº—')" id="btnStoreNan" class="btn-stat px-6 py-2 rounded-full bg-white font-bold shadow-sm text-green-600">å—ç§‘åº—</button>
  </div>

  <!-- Charts Area -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card h-[450px]">
      <div class="flex justify-between mb-2">
        <h3 class="font-bold">å®¢æºåˆ†æ <span id="sourceLockStatus" class="text-xs text-red-500 hidden">(é–å®šä¸­)</span></h3>
        <span class="text-xs text-gray-400">é»æ“Šé•·æ¢å¯é–å®š</span>
      </div>
      <div class="h-full relative"><canvas id="chartSource"></canvas></div>
    </div>
    <div class="card h-[450px] flex flex-col">
       <h3 class="font-bold mb-2">é€£å‹•åˆ†æ: <span id="crossLabel" class="text-blue-600">æ•´é«”</span></h3>
       <div class="flex-grow flex flex-col gap-4">
         <div class="h-1/2 relative"><canvas id="chartPurpose"></canvas></div>
         <div class="h-1/2 relative border-t pt-2">
           <div class="text-xs text-gray-400 mb-1">è¶¨å‹¢èµ°å‹¢</div>
           <canvas id="chartTrend"></canvas>
         </div>
       </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card p-0 overflow-hidden">
    <div class="p-4 border-b bg-white flex justify-between"><h3 class="font-bold">ä¾†å®¢åˆ—è¡¨</h3><span id="listCount" class="text-xs text-gray-500">--</span></div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead class="bg-yellow-100"><tr><th class="p-3">æ—¥æœŸ</th><th class="p-3">åˆ†åº—</th><th class="p-3">å§“å</th><th class="p-3">å®¢æº</th><th class="p-3">ç›®çš„</th><th class="p-3 w-20"></th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <button onclick="loadMore()" id="btnLoadMore" class="load-more-btn hidden">â–¼ è¼‰å…¥æ›´å¤š</button>
  </div>
</div>

<!-- Add Modal -->
<div id="modal" class="modal-overlay"><div class="modal-content"><h2 class="font-bold mb-4">æ–°å¢</h2><input type="date" id="mDate" class="w-full p-2 border rounded mb-2"><select id="mStore" class="w-full p-2 border rounded mb-2"><option>è‡¨å®‰åº—</option><option>å—ç§‘åº—</option></select><input id="mName" class="w-full p-2 border rounded mb-2" placeholder="å§“å"><input id="mSources" class="w-full p-2 border rounded mb-2" placeholder="å®¢æº (è‡ªå‹•ä¿®æ­£é€—è™Ÿ)"><input id="mPurposes" class="w-full p-2 border rounded mb-2" placeholder="ç›®çš„"><textarea id="mDetail" class="w-full p-2 border rounded mb-2 h-24" placeholder="å‚™è¨»"></textarea><button onclick="saveData()" class="btn-primary w-full">å„²å­˜</button><button onclick="closeModal()" class="w-full mt-2 text-gray-400">å–æ¶ˆ</button></div></div>

<script>
  // Global Data Cache (Hybrid Architecture)
  let rawData = []; // All 2000+ rows
  let filteredData = []; // After Date/Store filter
  let displayLimit = 20;
  let currentStore = 'å…¨éƒ¨';
  let lockedSource = null; // For click-lock interaction
  let charts = {};
  let datePicker;

  window.onload = async () => {
    datePicker = flatpickr("#dateRange", { mode: "range", dateFormat: "Y-m-d", locale: "zh_tw", onChange: (d) => { if(d.length===2) applyFilter(); } });
    Chart.register(ChartDataLabels); // Enable % labels
    
    // Auth
    const { data: { session } } = await supabase.auth.getSession();
    if(session) { document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('adminActions').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); }

    // Init Data
    await initData();
  };

  async function initData() {
    // 1. Fetch ALL data (Hybrid approach)
    // We fetch only needed columns for analytics to save bandwidth, full details on demand? 
    // No, 2000 rows is small, fetch * is fine.
    const { data, error } = await supabase.from('visits').select('*').order('form_date', {ascending: false}).limit(5000);
    if(error) { alert('Error: '+error.message); return; }
    
    rawData = data;
    
    // Set Date Range based on data
    if(rawData.length > 0) {
       const dates = rawData.map(x=>x.form_date).sort();
       datePicker.setDate([dates[0], dates[dates.length-1]]);
    } else {
       datePicker.setDate(['2024-01-01', new Date()]);
    }
    
    // Initial Calc
    applyFilter();
  }

  // --- Core Filter Logic ---
  window.applyFilter = () => {
    const dates = datePicker.selectedDates;
    const start = dates[0] ? datePicker.formatDate(dates[0], 'Y-m-d') : '2000-01-01';
    const end = dates[1] ? datePicker.formatDate(dates[1], 'Y-m-d') : '2099-12-31';
    const key = document.getElementById('qSearch').value.toLowerCase();

    // 1. Calculate KPI (Total, regardless of store filter)
    const timeFiltered = rawData.filter(v => v.form_date >= start && v.form_date <= end);
    document.getElementById('kpiTotal').innerText = timeFiltered.length;
    document.getElementById('kpiLinAn').innerText = timeFiltered.filter(v=>v.store_branch=='è‡¨å®‰åº—').length;
    document.getElementById('kpiNanKe').innerText = timeFiltered.filter(v=>v.store_branch=='å—ç§‘åº—').length;

    // 2. Filter for Charts & Table
    filteredData = timeFiltered.filter(v => {
       if(currentStore !== 'å…¨éƒ¨' && v.store_branch !== currentStore) return false;
       if(key && !v.customer_name.toLowerCase().includes(key) && !(v.detail_desc||'').toLowerCase().includes(key)) return false;
       return true;
    });

    // 3. Reset View
    displayLimit = 20;
    lockedSource = null;
    updateLockedStatus();
    renderCharts(filteredData);
    renderTable();
  };

  // --- The "Tech Feel" Interaction Logic ---
  function renderCharts(baseData) {
    // Aggregation
    const sMap = {}; 
    baseData.forEach(v => (v.source_tags||[]).forEach(t => sMap[t] = (sMap[t]||0)+1));
    
    // Source Chart
    const ctxS = document.getElementById('chartSource').getContext('2d');
    if(charts.source) charts.source.destroy();

    const sortedS = Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0, 15);
    
    charts.source = new Chart(ctxS, {
      type: 'bar',
      data: {
        labels: sortedS.map(x=>x[0]),
        datasets: [{
          label: 'å®¢æº',
          data: sortedS.map(x=>x[1]),
          backgroundColor: '#3b82f6',
          borderRadius: 4,
          hoverBackgroundColor: '#2563eb'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {display:false},
          datalabels: {
            anchor: 'end', align: 'top',
            formatter: (val, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
              return Math.round(val/total*100) + '%';
            },
            font: {weight: 'bold', size: 10}, color: '#666'
          }
        },
        onHover: (e, els) => {
          if(lockedSource) return; // Locked? Don't change
          const el = els[0];
          const canvas = e.native.target;
          canvas.style.cursor = el ? 'pointer' : 'default';
          
          if(el) {
            const label = sortedS[el.index][0];
            updateCrossCharts(label); // Hover Preview
          } else {
            updateCrossCharts(null); // Reset
          }
        },
        onClick: (e, els) => {
          const el = els[0];
          if(!el) { lockedSource=null; updateLockedStatus(); updateCrossCharts(null); return; }
          
          const label = sortedS[el.index][0];
          if(lockedSource === label) {
             lockedSource = null; // Unlock
          } else {
             lockedSource = label; // Lock
          }
          updateLockedStatus();
          updateCrossCharts(lockedSource);
        }
      }
    });

    // Init Cross Charts (Default: All)
    updateCrossCharts(null);
  }

  function updateCrossCharts(sourceFilter) {
    const label = sourceFilter || 'æ•´é«”';
    document.getElementById('crossLabel').innerText = label;
    
    // Filter logic: if sourceFilter is present, narrow down data
    let subset = filteredData;
    if(sourceFilter) {
       subset = filteredData.filter(v => (v.source_tags||[]).includes(sourceFilter));
    }

    // Purpose Chart (Doughnut)
    const pMap = {};
    subset.forEach(v => (v.visit_purposes||[]).forEach(t => pMap[t] = (pMap[t]||0)+1));
    const sortedP = Object.entries(pMap).sort((a,b)=>b[1]-a[1]).slice(0, 8);
    
    const ctxP = document.getElementById('chartPurpose').getContext('2d');
    if(charts.purpose) charts.purpose.destroy();
    charts.purpose = new Chart(ctxP, {
      type: 'doughnut',
      data: {
        labels: sortedP.map(x=>x[0]),
        datasets: [{ data: sortedP.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
    });

    // Trend Chart (Line)
    const tMap = {};
    subset.forEach(v => { const m = v.form_date.slice(0,7); tMap[m] = (tMap[m]||0)+1; });
    const sortedT = Object.keys(tMap).sort();
    
    const ctxT = document.getElementById('chartTrend').getContext('2d');
    if(charts.trend) charts.trend.destroy();
    charts.trend = new Chart(ctxT, {
      type: 'line',
      data: {
        labels: sortedT,
        datasets: [{ label:'æ•¸é‡', data: sortedT.map(k=>tMap[k]), borderColor: '#f59e0b', tension:0.3, fill:true, backgroundColor:'rgba(245,158,11,0.1)' }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}} }
    });
  }

  function updateLockedStatus() {
     const tag = document.getElementById('sourceLockStatus');
     if(lockedSource) {
       tag.classList.remove('hidden');
       tag.innerText = `(é–å®š: ${lockedSource})`;
     } else {
       tag.classList.add('hidden');
     }
  }

  // --- Table & Helper ---
  function renderTable() {
    const tbody = document.getElementById('tableBody');
    const pageData = filteredData.slice(0, displayLimit);
    
    tbody.innerHTML = pageData.map(v => `
      <tr class="border-b hover:bg-yellow-50 cursor-pointer">
        <td class="p-3 font-mono text-gray-500">${v.form_date}</td>
        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${v.store_branch=='è‡¨å®‰åº—'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${v.store_branch}</span></td>
        <td class="p-3 font-bold">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 max-w-[150px] truncate">${(v.source_tags||[]).join(',')}</td>
        <td class="p-3 text-xs text-gray-500 max-w-[150px] truncate">${(v.visit_purposes||[]).join(',')}</td>
        <td class="p-3 text-right"><button onclick="deleteData(${v.id})" class="text-red-400 font-bold hover:text-red-600">Ã—</button></td>
      </tr>
    `).join('');
    
    document.getElementById('listCount').innerText = `${pageData.length} / ${filteredData.length}`;
    if(pageData.length >= filteredData.length) document.getElementById('btnLoadMore').classList.add('hidden');
    else document.getElementById('btnLoadMore').classList.remove('hidden');
  }

  window.loadMore = () => { displayLimit += 20; renderTable(); };
  window.setStore = (s) => { currentStore = s; document.querySelectorAll('.btn-stat').forEach(b=>b.classList.remove('active', 'bg-blue-50', 'border-blue-500')); if(s=='å…¨éƒ¨')document.getElementById('btnStoreAll').classList.add('active'); if(s=='è‡¨å®‰åº—')document.getElementById('btnStoreLin').classList.add('active'); if(s=='å—ç§‘åº—')document.getElementById('btnStoreNan').classList.add('active'); applyFilter(); };
  window.resetDate = () => { datePicker.setDate(['2024-01-01', new Date()]); applyFilter(); };
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  window.openAddModal = () => document.getElementById('modal').style.display='flex';
  window.closeModal = () => document.getElementById('modal').style.display='none';

  // --- CSV Import ---
  window.previewCSV = (input) => {
    const f = input.files[0];
    Papa.parse(f, { header:true, skipEmptyLines:true, complete: async (res) => {
       if(!confirm(`åŒ¯å…¥ ${res.data.length} ç­†? (é‡è¤‡è€…å°‡è‡ªå‹•è¦†è“‹)`)) return;
       // Clean Keys logic (remove extra spaces in keys if any)
       const cleanData = res.data.map(row => {
          // Mapping logic
          const d = row['form_date']||row['å¡«è¡¨æ—¥æœŸ']; 
          const n = row['customer_name']||row['é¡§å®¢å§“å'];
          if(!d || !n) return null;
          
          // Smart Clean Tags
          let sRaw = row['source_tags']||row['ä¾†æºçµ±è¨ˆ']||'';
          sRaw = sRaw.replace(/ï¼Œ/g, ',').replace(/ã€/g, ','); // å…¨å½¢è½‰åŠå½¢
          const s = sRaw.split(',').map(x=>x.trim()).filter(x=>x);
          
          let pRaw = row['visit_purposes']||row['ä¾†åº—ç›®çš„']||'';
          pRaw = pRaw.replace(/ï¼Œ/g, ',').replace(/ã€/g, ',');
          const p = pRaw.split(',').map(x=>x.trim()).filter(x=>x);

          return { p_date: d, p_store: row['store_branch']||row['é–€åº—']||'è‡¨å®‰åº—', p_name: n, p_sources: s, p_purposes: p, p_detail: row['detail_desc']||row['è©³ç´°æè¿°']||'' };
       }).filter(x=>x);

       // Batch Submit via RPC
       const batchSize = 20;
       for(let i=0; i<cleanData.length; i+=batchSize) {
          const chunk = cleanData.slice(i, i+batchSize);
          await Promise.all(chunk.map(r => supabase.rpc('submit_visit', r)));
       }
       alert('åŒ¯å…¥å®Œæˆ');
       initData();
    }});
  };

  window.wipeData = async () => {
     if(!confirm('è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼')) return;
     // Force Export
     window.exportCSV();
     const pwd = prompt('è³‡æ–™å·²å¼·åˆ¶åŒ¯å‡ºå‚™ä»½ã€‚\nè«‹è¼¸å…¥å¯†ç¢¼ç¢ºèªæ¸…ç©ºï¼š');
     if(pwd === 'admin888') { // Hardcoded safe password for now
        await supabase.from('visits').delete().neq('id', 0);
        location.reload();
     } else {
        alert('å¯†ç¢¼éŒ¯èª¤');
     }
  };
  
  // Basic CRUD
  window.saveData = async () => {
     const r = {
        p_date: document.getElementById('mDate').value,
        p_store: document.getElementById('mStore').value,
        p_name: document.getElementById('mName').value,
        p_sources: document.getElementById('mSources').value.replace(/ï¼Œ/g,',').split(',').filter(x=>x),
        p_purposes: document.getElementById('mPurposes').value.replace(/ï¼Œ/g,',').split(',').filter(x=>x),
        p_detail: document.getElementById('mDetail').value
     };
     await supabase.rpc('submit_visit', r);
     closeModal();
     initData();
  };
  window.deleteData = async (id) => { if(confirm('åˆªé™¤?')) { await supabase.from('visits').delete().eq('id', id); initData(); } };
  window.login = async () => { if(document.getElementById('admPwd').value==='admin') { document.getElementById('adminActions').classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); } };
  
  // Export Helper
  window.exportCSV = () => {
    const csv = Papa.unparse(rawData);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'}));
    link.download = `backup_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(link); link.click();
  };
</script>
</body>
</html>
