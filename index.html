<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…‰å ‚çœ¼é¡æˆ°æƒ…å®¤ v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; }
    .btn-primary { background: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 500; transition: 0.2s; }
    .btn-primary:hover { background: #1d4ed8; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right: 4px; margin-bottom: 4px; background: #e5e7eb; color: #374151; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
    .chk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
    .chk-label { display: flex; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }
    .chk-label:hover { background: #f9fafb; }
    .chk-label input:checked + span { font-weight: bold; color: #2563eb; }
    .chk-label.checked { border-color: #2563eb; background: #eff6ff; }
  </style>
</head>
<body class="text-gray-800">

<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold text-gray-900">ğŸ‘“ å…‰å ‚çœ¼é¡æˆ°æƒ…å®¤</h1>
      <select id="storeSelect" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="å…¨éƒ¨">å…¨éƒ¨åº—èˆ–</option>
        <option value="è‡¨å®‰åº—" selected>è‡¨å®‰åº—</option>
        <option value="å—ç§‘åº—">å—ç§‘åº—</option>
      </select>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="openAddModal()" class="btn-primary flex items-center gap-2">
        <span>+ æ–°å¢è³‡æ–™</span>
      </button>
      <button onclick="toggleAdmin()" class="text-gray-500 text-sm hover:text-gray-700 px-2">ç®¡ç†å“¡</button>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center">
    <input type="date" id="qFrom" class="border rounded px-2 py-1" value="2026-01-01">
    <span class="text-gray-400">è‡³</span>
    <input type="date" id="qTo" class="border rounded px-2 py-1" value="2026-12-31">
    <input type="text" id="qSearch" placeholder="æœå°‹å§“å/é—œéµå­—..." class="border rounded px-2 py-1 flex-grow">
    <button onclick="fetchData()" class="btn-primary">æŸ¥è©¢</button>
  </div>

  <!-- Old Guest Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="card bg-blue-50 border-l-4 border-blue-500">
      <div class="text-gray-500 text-sm">è€å®¢ç¸½æ•¸ (Total)</div>
      <div class="text-3xl font-bold text-blue-700" id="statOldTotal">0</div>
    </div>
    <div class="card bg-green-50 border-l-4 border-green-500">
      <div class="text-gray-500 text-sm">è€å®¢å›è³¼ (Bought)</div>
      <div class="text-3xl font-bold text-green-700" id="statOldBuy">0</div>
    </div>
    <div class="card bg-orange-50 border-l-4 border-orange-500">
      <div class="text-gray-500 text-sm">è€å®¢æœªè³¼ (No Buy)</div>
      <div class="text-3xl font-bold text-orange-700" id="statOldNoBuy">0</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card" style="height: 400px;">
      <h3 class="font-bold mb-4 flex justify-between">
        å®¢æºåˆ†æ (Sources)
        <span class="text-xs text-gray-400 font-normal">é»æ“Šåœ–è¡¨å¯ç¯©é¸æ™‚é–“è»¸</span>
      </h3>
      <canvas id="chartSource"></canvas>
    </div>
    <div class="card" style="height: 400px;">
      <h3 class="font-bold mb-4">ä¾†è¨ªç›®çš„ (Purposes)</h3>
      <canvas id="chartPurpose"></canvas>
    </div>
  </div>

  <!-- Timeline (Hidden by default, shown when filtering) -->
  <div id="timelineCard" class="card mb-6 hidden">
    <h3 class="font-bold mb-4" id="timelineTitle">å®¢æºè¶¨å‹¢åˆ†æ</h3>
    <div style="height: 300px;"><canvas id="chartTimeline"></canvas></div>
  </div>

  <!-- Table -->
  <div class="card overflow-hidden">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold">æœ€æ–°è³‡æ–™åˆ—è¡¨ (Last 20)</h3>
      <span class="text-xs text-gray-500">é»æ“Šå§“åå¯æŸ¥çœ‹è©³æƒ…</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-gray-50 text-gray-600 font-medium border-b">
          <tr>
            <th class="p-3">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 admin-only hidden">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-gray-100">
          <!-- JS Render -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="card mt-6 hidden border-2 border-dashed border-gray-300">
    <h3 class="font-bold mb-4 text-red-600">ğŸ”§ ç®¡ç†å“¡å¾Œå°</h3>
    <div id="loginForm" class="flex gap-2">
      <input type="text" id="admEmail" placeholder="Email" class="border p-2 rounded" value="chanywang92@gmail.com">
      <input type="password" id="admPwd" placeholder="Password" class="border p-2 rounded">
      <button onclick="login()" class="btn-primary">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center">
      <div class="text-green-600 font-medium">å·²ç™»å…¥</div>
      <button onclick="logout()" class="text-sm underline">ç™»å‡º</button>
      <div class="h-6 w-px bg-gray-300 mx-2"></div>
      <button onclick="exportCSV()" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">åŒ¯å‡º CSV</button>
      <div class="flex gap-2 items-center border p-2 rounded bg-gray-50">
        <input type="file" id="csvFile" accept=".csv" class="text-xs">
        <button onclick="parseCSV()" class="bg-green-600 text-white px-3 py-1 rounded text-xs">åŒ¯å…¥ CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add / Edit / View -->
<div id="modal" class="modal-overlay">
  <div class="modal-content">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
    <h2 id="modalTitle" class="text-xl font-bold mb-6">æ–°å¢å®¢æºè³‡æ–™</h2>
    
    <div class="space-y-4">
      <!-- Basic Info -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ *</label>
          <input type="date" id="mDate" class="w-full border p-2 rounded">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†åº— *</label>
          <select id="mStore" class="w-full border p-2 rounded bg-gray-50">
            <option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option>
            <option value="å—ç§‘åº—">å—ç§‘åº—</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">å§“å *</label>
          <input type="text" id="mName" class="w-full border p-2 rounded" placeholder="é¡§å®¢å§“å">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">æ€§åˆ¥</label>
          <select id="mGender" class="w-full border p-2 rounded">
            <option value="">æœªé¸æ“‡</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">å¹´é½¡å±¤</label>
          <select id="mAge" class="w-full border p-2 rounded">
            <option value="18æ­²ä»¥ä¸‹">18æ­²ä»¥ä¸‹</option>
            <option value="18-24">18-24</option>
            <option value="25-34" selected>25-34</option>
            <option value="35-44">35-44</option>
            <option value="45-54">45-54</option>
            <option value="55æ­²ä»¥ä¸Š">55æ­²ä»¥ä¸Š</option>
          </select>
        </div>
        <div class="flex items-center pt-5">
          <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="mTainan" class="w-5 h-5 text-blue-600">
            <span class="font-bold text-gray-700">æ˜¯å°å—äºº</span>
          </label>
        </div>
      </div>

      <hr class="border-gray-100">

      <!-- Sources (Checkbox Grid) -->
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">å¾—çŸ¥æœ¬åº—ä¾†æº (å¯è¤‡é¸)</label>
        <div class="chk-grid" id="chkSources">
          <!-- JS Generate -->
        </div>
      </div>

      <!-- Keyword -->
      <div id="keywordBox" class="hidden bg-yellow-50 p-3 rounded border border-yellow-200">
        <label class="block text-xs font-bold text-yellow-700 mb-1">Google æœå°‹é—œéµå­—</label>
        <input type="text" id="mKeyword" class="w-full border p-2 rounded text-sm" placeholder="ä¾‹å¦‚ï¼šå°å—çœ¼é¡è¡Œã€é…é¡æ¨è–¦...">
      </div>

      <!-- Purposes -->
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-2">ä¾†åº—ç›®çš„ (å¯è¤‡é¸)</label>
        <div class="chk-grid" id="chkPurposes">
          <!-- JS Generate -->
        </div>
      </div>

      <!-- Detail -->
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">å®¢äººç°¡è¿° / å‚™è¨»</label>
        <textarea id="mDetail" class="w-full border p-2 rounded h-20 text-sm" placeholder="è¼¸å…¥è©³ç´°æè¿°..."></textarea>
      </div>

      <button id="btnSave" onclick="saveData()" class="w-full btn-primary py-3 text-lg mt-4 shadow-lg">ç¢ºèªé€å‡º</button>
    </div>
  </div>
</div>

<script>
  // Config
  const SOURCES = [
    "Google æœå°‹", "Google Map", "Facebook å»£å‘Š", "Instagram å»£å‘Š", 
    "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "Mobile 01", "PTT",
    "è¦ªå‹ä»‹ç´¹", "é€”ç¶“è·¯é", "å…¶ä»–", "æ¥­é…è²¼æ–‡ (FBã€IG)", "è€å®¢å›è³¼", 
    "è€å®¢-æœªè³¼", "å»£å‘Šçœ‹æ¿", "FB ç¤¾åœ˜æ–‡"
  ];
  const PURPOSES = [
    "é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢",
    "å–®ç´”çœ‹çœ‹", "è³¼è²·å…¶ä»–å•†å“", "ä½æˆ¶è¦–åŠ›æª¢æŸ¥"
  ];

  // State
  let visits = [];
  let stats = {};
  let isAdmin = false;

  // Init
  window.onload = () => {
    // Generate Checkboxes
    renderCheckboxes('chkSources', SOURCES);
    renderCheckboxes('chkPurposes', PURPOSES);
    
    // Auto Select Store from localStorage
    const savedStore = localStorage.getItem('store');
    if(savedStore) document.getElementById('storeSelect').value = savedStore;

    // Load Data
    fetchData();
    
    // Check Keyword Input Visibility
    document.getElementById('chkSources').addEventListener('change', checkKeywordVisibility);
  };

  function renderCheckboxes(id, list) {
    const container = document.getElementById(id);
    container.innerHTML = list.map(item => `
      <label class="chk-label">
        <input type="checkbox" value="${item}" class="mr-2">
        <span>${item}</span>
      </label>
    `).join('');
    // Add click effect
    container.querySelectorAll('input').forEach(input => {
      input.addEventListener('change', e => {
        e.target.parentElement.classList.toggle('checked', e.target.checked);
      });
    });
  }

  function checkKeywordVisibility() {
    const inputs = document.querySelectorAll('#chkSources input:checked');
    const hasGoogle = Array.from(inputs).some(i => i.value.includes('Google æœå°‹'));
    document.getElementById('keywordBox').classList.toggle('hidden', !hasGoogle);
  }

  // API Call
  window.fetchData = async () => {
    const from = document.getElementById('qFrom').value;
    const to = document.getElementById('qTo').value;
    const store = document.getElementById('storeSelect').value;
    const keyword = document.getElementById('qSearch').value;

    localStorage.setItem('store', store); // Remember selection

    // 1. Stats
    const { data: statData } = await supabase.rpc('get_stats_public', {
      start_date: from, end_date: to, store_filter: store
    });
    
    // 2. List
    const { data: listData } = await supabase.rpc('get_visits_public', {
      start_date: from, end_date: to, keyword: keyword, store_filter: store
    });

    if(statData && listData) {
      stats = statData;
      visits = listData;
      renderAll();
    }
  };

  function renderAll() {
    // 1. Old Guest Stats
    const old = stats.old_guests || {total:0, bought:0, not_bought:0};
    document.getElementById('statOldTotal').textContent = old.total;
    document.getElementById('statOldBuy').textContent = old.bought;
    document.getElementById('statOldNoBuy').textContent = old.not_bought;

    // 2. Charts
    renderChart('chartSource', 'bar', stats.sources, 'tag');
    renderChart('chartPurpose', 'doughnut', stats.purposes, 'purpose');

    // 3. Table
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = visits.map(v => `
      <tr class="hover:bg-blue-50 cursor-pointer transition" onclick="showDetail('${v.form_date}', '${v.customer_name}')">
        <td class="p-3">${v.form_date}</td>
        <td class="p-3"><span class="px-2 py-1 rounded text-xs ${v.store_branch==='è‡¨å®‰åº—'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${v.store_branch||'è‡¨å®‰åº—'}</span></td>
        <td class="p-3 font-medium text-blue-600 hover:underline">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[150px]">${(v.source_tags||[]).join(', ')}</td>
        <td class="p-3 text-xs text-gray-500 truncate max-w-[150px]">${(v.visit_purposes||[]).join(', ')}</td>
        <td class="p-3 admin-only ${isAdmin?'':'hidden'}">
          <button onclick="event.stopPropagation(); deleteVisit('${v.form_date}', '${v.customer_name}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button>
        </td>
      </tr>
    `).join('');
  }

  // Chart Logic
  let charts = {};
  function renderChart(id, type, data, key) {
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();

    const total = data.reduce((sum, d) => sum + d.c, 0);

    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: data.map(d => d[key]),
        datasets: [{
          data: data.map(d => d.c),
          backgroundColor: [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'
          ],
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', display: type==='doughnut' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const val = ctx.raw;
                const pct = total ? ((val/total)*100).toFixed(1) + '%' : '0%';
                return `${ctx.label}: ${val}äºº (${pct})`;
              }
            }
          }
        },
        onClick: (evt, elements) => {
          if(id === 'chartSource' && elements.length > 0) {
            const idx = elements[0].index;
            const label = data[idx][key];
            showTimeline(label);
          }
        }
      }
    });
  }

  function showTimeline(sourceTag) {
    document.getElementById('timelineCard').classList.remove('hidden');
    document.getElementById('timelineTitle').textContent = `è¶¨å‹¢åˆ†æï¼š${sourceTag}`;
    
    // Process Data
    const timeline = stats.timeline || [];
    // Group by Date
    const daily = {};
    timeline.forEach(item => {
      if(item.source_tags && item.source_tags.includes(sourceTag)) {
        daily[item.form_date] = (daily[item.form_date] || 0) + 1;
      }
    });
    
    const dates = Object.keys(daily).sort();
    const counts = dates.map(d => daily[d]);

    const ctx = document.getElementById('chartTimeline').getContext('2d');
    if(charts['timeline']) charts['timeline'].destroy();

    charts['timeline'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: sourceTag,
          data: counts,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37, 99, 235, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
    
    // Scroll to view
    document.getElementById('timelineCard').scrollIntoView({ behavior: 'smooth' });
  }

  // Modal Actions
  window.openAddModal = () => {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'æ–°å¢å®¢æºè³‡æ–™';
    document.getElementById('mDate').valueAsDate = new Date();
    document.getElementById('mStore').value = document.getElementById('storeSelect').value === 'å…¨éƒ¨' ? 'è‡¨å®‰åº—' : document.getElementById('storeSelect').value;
    document.getElementById('mName').value = '';
    document.getElementById('mDetail').value = '';
    document.getElementById('mKeyword').value = '';
    document.getElementById('mTainan').checked = false;
    
    document.querySelectorAll('input[type="checkbox"]').forEach(i => {
      i.checked = false; 
      i.parentElement.classList.remove('checked');
    });
    
    // Enable inputs
    document.querySelectorAll('#modal input, #modal select, #modal textarea').forEach(i => i.disabled = false);
    document.getElementById('btnSave').classList.remove('hidden');
  };

  window.showDetail = (date, name) => {
    const item = visits.find(v => v.form_date === date && v.customer_name === name);
    if(!item) return;

    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'è©³ç´°è³‡æ–™';
    
    // Fill Data
    document.getElementById('mDate').value = item.form_date;
    document.getElementById('mStore').value = item.store_branch || 'è‡¨å®‰åº—';
    document.getElementById('mName').value = item.customer_name;
    document.getElementById('mGender').value = item.gender || '';
    document.getElementById('mAge').value = item.age_group || '25-34';
    document.getElementById('mTainan').checked = item.is_tainan;
    document.getElementById('mDetail').value = (item.detail_desc || '') + (item.search_keyword ? `\n[é—œéµå­—]: ${item.search_keyword}` : '');
    
    // Checkboxes
    const setChecked = (id, tags) => {
      document.querySelectorAll(`#${id} input`).forEach(i => {
        const checked = (tags||[]).includes(i.value);
        i.checked = checked;
        i.parentElement.classList.toggle('checked', checked);
      });
    };
    setChecked('chkSources', item.source_tags);
    setChecked('chkPurposes', item.visit_purposes);

    // Read Only
    document.querySelectorAll('#modal input, #modal select, #modal textarea').forEach(i => i.disabled = true);
    document.getElementById('btnSave').classList.add('hidden');
  };

  window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };

  window.saveData = async () => {
    const btn = document.getElementById('btnSave');
    btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

    const getVals = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i => i.value);

    const payload = {
      p_date: document.getElementById('mDate').value,
      p_store: document.getElementById('mStore').value,
      p_name: document.getElementById('mName').value,
      p_gender: document.getElementById('mGender').value,
      p_age: document.getElementById('mAge').value,
      p_tainan: document.getElementById('mTainan').checked,
      p_sources: getVals('chkSources'),
      p_purposes: getVals('chkPurposes'),
      p_keyword: document.getElementById('mKeyword').value,
      p_detail: document.getElementById('mDetail').value
    };

    if(!payload.p_date || !payload.p_name) {
      alert('æ—¥æœŸèˆ‡å§“åç‚ºå¿…å¡«');
      btn.disabled = false; btn.textContent = 'ç¢ºèªé€å‡º';
      return;
    }

    const { error } = await supabase.rpc('submit_visit', payload);

    if(error) alert('Error: ' + error.message);
    else {
      closeModal();
      fetchData();
    }
    btn.disabled = false; btn.textContent = 'ç¢ºèªé€å‡º';
  };

  // Admin
  window.toggleAdmin = () => { document.getElementById('adminPanel').classList.toggle('hidden'); };
  
  window.login = async () => {
    const { error } = await supabase.auth.signInWithPassword({
      email: document.getElementById('admEmail').value,
      password: document.getElementById('admPwd').value
    });
    if(error) alert('ç™»å…¥å¤±æ•—');
    else checkAuth();
  };

  window.logout = async () => { await supabase.auth.signOut(); checkAuth(); };

  async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    isAdmin = !!data.session;
    if(isAdmin) {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('adminActions').classList.remove('hidden');
      document.querySelectorAll('.admin-only').forEach(e => e.classList.remove('hidden'));
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminActions').classList.add('hidden');
      document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));
    }
  }
  checkAuth();
  
  // CSV Import/Export
  window.exportCSV = () => {
    const csv = Papa.unparse(visits);
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `visits_export.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  };
</script>
</body>
</html>
