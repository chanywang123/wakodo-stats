<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V7.5</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    :root { 
      --bg: #0f0f23; 
      --card-bg: #1a1a35; 
      --accent: #3b82f6; 
      --text-gray: #6b7280; 
    }
    
    body { 
      background: var(--bg); 
      font-family: system-ui, -apple-system, sans-serif; 
      color: white; 
      margin: 0; 
      padding-bottom: 100px; 
    }
    
    .glass-card { 
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 20px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
    }
    
    /* ç§‘æŠ€æ„Ÿç™¼å…‰å…‰é» */
    .tech-glow {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #3b82f6;
      border-radius: 50%;
      box-shadow: 
        0 0 10px #3b82f6,
        0 0 20px #3b82f6,
        0 0 30px #3b82f6;
      animation: glow-pulse 2s ease-in-out infinite;
      position: relative;
      top: -2px;
      margin-right: 8px;
    }
    
    @keyframes glow-pulse {
      0%, 100% { 
        opacity: 1;
        box-shadow: 
          0 0 10px #3b82f6,
          0 0 20px #3b82f6,
          0 0 30px #3b82f6;
      }
      50% { 
        opacity: 0.6;
        box-shadow: 
          0 0 5px #3b82f6,
          0 0 10px #3b82f6,
          0 0 15px #3b82f6;
      }
    }
    
    /* Top1 å„ªåŒ–æ¨£å¼ */
    .top-badge {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 2px solid #fbbf24;
      box-shadow: 
        0 4px 6px rgba(251, 191, 36, 0.3),
        0 0 15px rgba(251, 191, 36, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .top-badge:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 6px 12px rgba(251, 191, 36, 0.4),
        0 0 25px rgba(251, 191, 36, 0.3);
      background: rgba(255, 255, 255, 0.25);
    }
    
    .top-badge-icon {
      width: 12px;
      height: 12px;
      background: #fbbf24;
      border-radius: 50%;
      border: 2px solid white;
    }
    
    /* ç™»å‡ºæŒ‰éˆ• */
    .logout-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: #fecaca;
      font-weight: bold;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: #ef4444;
    }
    
    /* å…¶ä»–ä¿æŒåŸæœ‰æ¨£å¼ */
    .btn-primary { 
      background: var(--accent); 
      color: white; 
      padding: 10px 20px; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-weight: bold; 
      transition: all 0.2s; 
    }
    
    .btn-primary:hover { 
      background: #2563eb; 
      transform: translateY(-1px); 
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #60a5fa;
    }
    
    .stat-label {
      color: var(--text-gray);
      font-size: 0.875rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="glass-card mb-6 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <span class="tech-glow"></span>
      <h1 class="text-2xl font-bold">å’Œå…‰å ‚æˆ°æƒ…å®¤</h1>
      <span class="text-xs text-gray-400 ml-2">V7.5</span>
    </div>
    <div class="flex items-center gap-3">
      <div id="dateRangeDisplay" class="text-sm text-gray-400"></div>
      <button id="logoutBtn" class="logout-btn hidden" onclick="logout()">
        ğŸšª ç™»å‡ºç®¡ç†æ¨¡å¼
      </button>
      <button onclick="window.location.href='form.html'" class="btn-primary">
        â• æ–°å¢è³‡æ–™
      </button>
      <button onclick="refreshData()" class="btn-primary">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="statsContainer">
    <!-- å‹•æ…‹ç”Ÿæˆ -->
  </div>

  <!-- Charts Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- è¶¨å‹¢åˆ†æ -->
    <div class="glass-card">
      <h3 class="text-lg font-bold mb-4">ğŸ“ˆ å®¢æµè¶¨å‹¢åˆ†æ</h3>
      <canvas id="trendChart" height="300"></canvas>
    </div>
    
    <!-- ç›®çš„åˆ†æ -->
    <div class="glass-card">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        ğŸ¯ é¡§å®¢ç›®çš„åˆ†æ
        <span class="top-badge" id="topPurposeBadge">
          <span class="top-badge-icon"></span>
          <span id="topPurposeText">è¼‰å…¥ä¸­...</span>
        </span>
      </h3>
      <canvas id="purposeChart" height="300"></canvas>
    </div>
  </div>

  <!-- More charts... -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- å®¢æºåˆ†æ -->
    <div class="glass-card">
      <h3 class="text-lg font-bold mb-4">ğŸŒ å®¢æºæ¸ é“åˆ†æ</h3>
      <canvas id="sourceChart" height="300"></canvas>
    </div>
    
    <!-- å¹´é½¡åˆ†å¸ƒ -->
    <div class="glass-card">
      <h3 class="text-lg font-bold mb-4">ğŸ‘¥ å¹´é½¡åˆ†å¸ƒ</h3>
      <canvas id="ageChart" height="300"></canvas>
    </div>
  </div>
</div>

<script>
let allData = [];
let trendChartInstance = null;
let purposeChartInstance = null;
let sourceChartInstance = null;
let ageChartInstance = null;
let isAdminMode = false;

// æª¢æŸ¥ç®¡ç†å“¡æ¨¡å¼
function checkAdminMode() {
  const urlParams = new URLSearchParams(window.location.search);
  isAdminMode = urlParams.get('admin') === 'true';
  
  if(isAdminMode) {
    document.getElementById('logoutBtn').classList.remove('hidden');
  }
}

// ç™»å‡ºç®¡ç†æ¨¡å¼
function logout() {
  window.location.href = window.location.pathname;
}

// åˆå§‹åŒ–
window.onload = async () => {
  checkAdminMode();
  await loadAllData();
  renderDashboard();
};

// è¼‰å…¥å…¨éƒ¨è³‡æ–™ï¼ˆä¿®æ­£ï¼šç§»é™¤é™åˆ¶ï¼‰
async function loadAllData() {
  try {
    let allRecords = [];
    let from = 0;
    const batchSize = 1000;
    let hasMore = true;
    
    while(hasMore) {
      const { data, error } = await supabase
        .from('customer_visits')
        .select('*')
        .range(from, from + batchSize - 1)
        .order('visit_date', { ascending: false });
      
      if(error) throw error;
      
      if(data && data.length > 0) {
        allRecords = allRecords.concat(data);
        from += batchSize;
        hasMore = data.length === batchSize;
      } else {
        hasMore = false;
      }
    }
    
    allData = allRecords;
    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allData.length} ç­†è³‡æ–™`);
    
  } catch(err) {
    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', err);
    alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + err.message);
  }
}

// æ¸²æŸ“å„€è¡¨æ¿
function renderDashboard() {
  renderStats();
  renderTrendChart();
  renderPurposeChart();
  renderSourceChart();
  renderAgeChart();
}

// çµ±è¨ˆå¡ç‰‡
function renderStats() {
  const total = allData.length;
  const male = allData.filter(d => d.gender === 'ç”·').length;
  const local = allData.filter(d => d.is_local).length;
  const avgPerDay = (total / 30).toFixed(1);
  
  document.getElementById('statsContainer').innerHTML = `
    <div class="stat-card">
      <div class="stat-value">${total}</div>
      <div class="stat-label">ç¸½å®¢æµé‡</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${male}/${total-male}</div>
      <div class="stat-label">ç”· / å¥³</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${((local/total)*100).toFixed(1)}%</div>
      <div class="stat-label">å°å—å¸‚æ°‘å æ¯”</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${avgPerDay}</div>
      <div class="stat-label">æ—¥å‡å®¢æµ</div>
    </div>
  `;
}

// è¶¨å‹¢åœ–è¡¨ï¼ˆä¿®æ­£ï¼šå¢åŠ åˆ»åº¦ç·©è¡ï¼‰
function renderTrendChart() {
  const dateCount = {};
  allData.forEach(d => {
    const date = d.visit_date;
    dateCount[date] = (dateCount[date] || 0) + 1;
  });
  
  const sortedDates = Object.keys(dateCount).sort();
  const values = sortedDates.map(d => dateCount[d]);
  const maxValue = Math.max(...values);
  const suggestedMax = Math.ceil(maxValue * 1.3); // å¢åŠ 30%ç·©è¡
  
  const ctx = document.getElementById('trendChart').getContext('2d');
  if(trendChartInstance) trendChartInstance.destroy();
  
  trendChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sortedDates,
      datasets: [{
        label: 'å®¢æµé‡',
        data: values,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          suggestedMax: suggestedMax,
          ticks: { color: '#9ca3af' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }
        },
        x: {
          ticks: { color: '#9ca3af', maxRotation: 45 },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// ç›®çš„åœ–è¡¨ï¼ˆç”œç”œåœˆï¼‰+ Top1 è¯å‹•
function renderPurposeChart() {
  const purposeCount = {};
  allData.forEach(d => {
    d.purposes?.forEach(p => {
      purposeCount[p] = (purposeCount[p] || 0) + 1;
    });
  });
  
  const sorted = Object.entries(purposeCount).sort((a,b) => b[1] - a[1]);
  const labels = sorted.map(x => x[0]);
  const values = sorted.map(x => x[1]);
  
  // æ›´æ–° Top1 æ¨™ç±¤
  if(sorted.length > 0) {
    const topPurpose = sorted[0][0];
    document.getElementById('topPurposeText').textContent = `TOP1 ${topPurpose}`;
  }
  
  const ctx = document.getElementById('purposeChart').getContext('2d');
  if(purposeChartInstance) purposeChartInstance.destroy();
  
  purposeChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
          '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          position: 'right',
          labels: { color: '#9ca3af', padding: 15 }
        }
      },
      onHover: (event, activeElements) => {
        const badge = document.getElementById('topPurposeBadge');
        if(activeElements.length > 0) {
          badge.style.transform = 'scale(1.05)';
        } else {
          badge.style.transform = 'scale(1)';
        }
      }
    }
  });
  
  // é»æ“Š Top1 æ¨™ç±¤èšç„¦åœ–è¡¨ç¬¬ä¸€é …
  document.getElementById('topPurposeBadge').onclick = () => {
    purposeChartInstance.setActiveElements([{datasetIndex: 0, index: 0}]);
    purposeChartInstance.update();
  };
}

// å®¢æºåœ–è¡¨
function renderSourceChart() {
  const sourceCount = {};
  allData.forEach(d => {
    d.sources?.forEach(s => {
      sourceCount[s] = (sourceCount[s] || 0) + 1;
    });
  });
  
  const sorted = Object.entries(sourceCount).sort((a,b) => b[1] - a[1]).slice(0, 10);
  const labels = sorted.map(x => x[0]);
  const values = sorted.map(x => x[1]);
  
  const ctx = document.getElementById('sourceChart').getContext('2d');
  if(sourceChartInstance) sourceChartInstance.destroy();
  
  sourceChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'å®¢æºæ•¸é‡',
        data: values,
        backgroundColor: '#10b981'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: {
          ticks: { color: '#9ca3af' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }
        },
        y: {
          ticks: { color: '#9ca3af' },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// å¹´é½¡åœ–è¡¨
function renderAgeChart() {
  const ageCount = {};
  allData.forEach(d => {
    ageCount[d.age] = (ageCount[d.age] || 0) + 1;
  });
  
  const ages = ["18æ­²ä»¥ä¸‹", "18-24", "25-34", "35-44", "45-54", "55æ­²ä»¥ä¸Š"];
  const values = ages.map(age => ageCount[age] || 0);
  
  const ctx = document.getElementById('ageChart').getContext('2d');
  if(ageChartInstance) ageChartInstance.destroy();
  
  ageChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ages,
      datasets: [{
        label: 'äººæ•¸',
        data: values,
        backgroundColor: '#f59e0b'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#9ca3af' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' }
        },
        x: {
          ticks: { color: '#9ca3af' },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// é‡æ–°è¼‰å…¥
async function refreshData() {
  await loadAllData();
  renderDashboard();
  alert(`âœ… è³‡æ–™å·²æ›´æ–°ï¼å…±è¼‰å…¥ ${allData.length} ç­†`);
}
</script>

</body>
</html>
