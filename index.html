<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; transition: 0.2s; }
    .btn-primary { background: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 500; transition: 0.2s; }
    .btn-primary:hover { background: #1d4ed8; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
    .chk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
    .chk-label { display: flex; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.1s; }
    .chk-label:hover { background: #f9fafb; }
    .chk-label input:checked + span { font-weight: bold; color: #2563eb; }
    .chk-label.checked { border-color: #2563eb; background: #eff6ff; }
  </style>
</head>
<body class="text-gray-800">

<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-gray-900 tracking-tight">ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</h1>
      <div class="flex flex-col text-[10px] text-blue-600 font-bold leading-tight border-l-2 border-blue-200 pl-2">
        <span>v2.1 Last Update</span>
        <span id="updateTime">2026-01-13</span>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <select id="storeSelect" onchange="fetchData()" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium shadow-sm focus:ring-2 focus:ring-blue-500">
        <option value="å…¨éƒ¨">å…¨éƒ¨åº—èˆ–</option>
        <option value="è‡¨å®‰åº—" selected>è‡¨å®‰åº—</option>
        <option value="å—ç§‘åº—">å—ç§‘åº—</option>
      </select>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
      <button onclick="toggleAdmin()" class="text-gray-400 hover:text-gray-600 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
    </div>
  </div>

  <!-- Filter -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center bg-white">
    <div class="flex items-center border rounded px-2 bg-gray-50">
      <span class="text-gray-400 text-xs mr-2">æœŸé–“</span>
      <input type="date" id="qFrom" class="bg-transparent py-1 text-sm outline-none" value="2026-01-01">
      <span class="text-gray-400 mx-1">-</span>
      <input type="date" id="qTo" class="bg-transparent py-1 text-sm outline-none" value="2026-12-31">
    </div>
    <div class="flex-grow relative">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å‚™è¨»..." class="w-full border rounded pl-8 pr-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
      <svg class="w-4 h-4 text-gray-400 absolute left-2 top-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>
    <button onclick="fetchData()" class="bg-gray-800 text-white px-4 py-1 rounded text-sm hover:bg-gray-700">æŸ¥è©¢</button>
  </div>

  <!-- Store Stats (Dynamic) -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="storeStatsGrid">
    <!-- JS will populate this -->
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card h-[400px]">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-700">å®¢æºåˆ†æ (é»æ“Šé•·æ¢çœ‹è¶¨å‹¢)</h3>
      </div>
      <div class="h-[320px]"><canvas id="chartSource"></canvas></div>
    </div>
    <div class="card h-[400px]">
      <h3 class="font-bold text-gray-700 mb-4">ä¾†è¨ªç›®çš„</h3>
      <div class="h-[320px]"><canvas id="chartPurpose"></canvas></div>
    </div>
  </div>

  <!-- Trend Chart (Hidden by default) -->
  <div id="trendCard" class="card mb-6 hidden">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-blue-700" id="trendTitle">è¶¨å‹¢åˆ†æ</h3>
      <button onclick="document.getElementById('trendCard').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">&times;</button>
    </div>
    <div class="h-[300px]"><canvas id="chartTrend"></canvas></div>
  </div>

  <!-- Table -->
  <div class="card overflow-hidden">
    <div class="flex justify-between items-center mb-4 px-1">
      <h3 class="font-bold text-gray-700">æœ€æ–°ä¾†å®¢ç´€éŒ„ (Top 50)</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-gray-50 text-gray-500 font-medium border-b">
          <tr>
            <th class="p-3">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 hidden admin-only">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Admin -->
  <div id="adminPanel" class="hidden mt-8 border-t pt-4">
    <div id="loginForm" class="flex gap-2 max-w-md mx-auto">
      <input type="password" id="admPwd" placeholder="ç®¡ç†å“¡å¯†ç¢¼" class="border p-2 rounded flex-grow">
      <button onclick="login()" class="btn-primary">ç™»å…¥</button>
    </div>
    <div id="adminActions" class="hidden flex gap-4 justify-center items-center bg-gray-100 p-4 rounded">
      <span class="text-green-600 font-bold">ç®¡ç†å“¡å·²ç™»å…¥</span>
      <button onclick="exportCSV()" class="underline text-blue-600">åŒ¯å‡º CSV</button>
      <button onclick="logout()" class="text-red-500">ç™»å‡º</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-content">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 text-2xl">&times;</button>
    <h2 id="modalTitle" class="text-xl font-bold mb-6 text-gray-800">æ–°å¢è³‡æ–™</h2>
    
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input type="date" id="mDate" class="w-full border rounded p-2"></div>
        <div>
          <label class="text-xs font-bold text-gray-500">åˆ†åº—</label>
          <select id="mStore" class="w-full border rounded p-2 bg-gray-50">
            <option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option>
            <option value="å—ç§‘åº—">å—ç§‘åº—</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-xs font-bold text-gray-500">å§“å</label><input type="text" id="mName" class="w-full border rounded p-2" placeholder="é¡§å®¢å§“å"></div>
        <div>
          <label class="text-xs font-bold text-gray-500">æ€§åˆ¥</label>
          <select id="mGender" class="w-full border rounded p-2">
            <option value="">æœªé¸æ“‡</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 items-end">
        <div>
          <label class="text-xs font-bold text-gray-500">å¹´é½¡å±¤</label>
          <select id="mAge" class="w-full border rounded p-2">
            <option value="25-34">25-34</option><option value="35-44">35-44</option>
            <option value="18-24">18-24</option><option value="45-54">45-54</option>
            <option value="55æ­²ä»¥ä¸Š">55æ­²ä»¥ä¸Š</option><option value="18æ­²ä»¥ä¸‹">18æ­²ä»¥ä¸‹</option>
          </select>
        </div>
        <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
          <input type="checkbox" id="mTainan" class="w-4 h-4 text-blue-600">
          <span class="text-sm font-bold text-gray-700">æ˜¯å°å—äºº</span>
        </label>
      </div>
      
      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">å®¢æº (è¤‡é¸)</label>
        <div class="chk-grid" id="chkSources"></div>
      </div>

      <div id="keywordBox" class="hidden bg-yellow-50 p-2 rounded border border-yellow-200">
        <input type="text" id="mKeyword" class="w-full bg-transparent text-sm outline-none" placeholder="è¼¸å…¥ Google æœå°‹é—œéµå­—...">
      </div>

      <div>
        <label class="text-xs font-bold text-gray-500 mb-1 block">ç›®çš„ (è¤‡é¸)</label>
        <div class="chk-grid" id="chkPurposes"></div>
      </div>

      <div>
        <label class="text-xs font-bold text-gray-500">å‚™è¨»</label>
        <textarea id="mDetail" class="w-full border rounded p-2 text-sm h-20" placeholder="è©³ç´°æè¿°..."></textarea>
      </div>

      <button id="btnSave" onclick="saveData()" class="w-full btn-primary py-3 font-bold text-lg mt-2">å„²å­˜è³‡æ–™</button>
    </div>
  </div>
</div>

<script>
  // Config
  const SOURCES = ["Google æœå°‹", "Google Map", "è¦ªå‹ä»‹ç´¹", "è€å®¢å›è³¼", "è€å®¢-æœªè³¼", "é€”ç¶“è·¯é", "Facebook å»£å‘Š", "Instagram å»£å‘Š", "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "PTT", "å…¶ä»–"];
  const PURPOSES = ["é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢", "è³¼è²·å…¶ä»–å•†å“"];
  
  // State
  let visits = [];
  let stats = {};
  let isAdmin = false;

  // Init
  document.getElementById('updateTime').textContent = new Date().toISOString().split('T')[0];
  
  window.onload = () => {
    initCheckboxes('chkSources', SOURCES);
    initCheckboxes('chkPurposes', PURPOSES);
    const savedStore = localStorage.getItem('store');
    if(savedStore) document.getElementById('storeSelect').value = savedStore;
    fetchData();
  };

  function initCheckboxes(id, list) {
    document.getElementById(id).innerHTML = list.map(item => `
      <label class="chk-label">
        <input type="checkbox" value="${item}" class="mr-2 hidden" onchange="this.parentElement.classList.toggle('checked', this.checked)">
        <span>${item}</span>
      </label>
    `).join('');
    
    // Keyword toggle
    if(id === 'chkSources') {
      document.getElementById(id).addEventListener('change', () => {
        const hasGoogle = Array.from(document.querySelectorAll('#chkSources input:checked')).some(i => i.value.includes('Google'));
        document.getElementById('keywordBox').classList.toggle('hidden', !hasGoogle);
      });
    }
  }

  window.fetchData = async () => {
    const from = document.getElementById('qFrom').value;
    const to = document.getElementById('qTo').value;
    const store = document.getElementById('storeSelect').value;
    const keyword = document.getElementById('qSearch').value;
    
    localStorage.setItem('store', store);

    // 1. Get List
    const { data: listData } = await supabase.rpc('get_visits_public', {
      start_date: from, end_date: to, keyword: keyword, store_filter: store
    });

    // 2. Get Stats
    const { data: statData } = await supabase.rpc('get_stats_public', {
      start_date: from, end_date: to, store_filter: store
    });

    if(listData && statData) {
      visits = listData;
      stats = statData;
      renderAll();
    }
  };

  function renderAll() {
    // 1. Store Stats (Total, LinAn, NanKe)
    // é€™è£¡æˆ‘å€‘å‹•æ…‹è¨ˆç®—ï¼Œå³ä½¿æœªä¾†æœ‰æ–°åˆ†åº—ä¹Ÿä¸æ€•
    const totalCount = visits.length; // ç•¶å‰ç¯©é¸ä¸‹çš„ç¸½æ•¸
    const linanCount = visits.filter(v => v.store_branch === 'è‡¨å®‰åº—').length;
    const nankeCount = visits.filter(v => v.store_branch === 'å—ç§‘åº—').length;
    
    const storeStatsHtml = `
      <div class="card bg-blue-50 border-l-4 border-blue-500 p-4">
        <div class="text-xs text-gray-500 mb-1">ç¸½å®¢æ•¸ (ç›®å‰ç¯©é¸)</div>
        <div class="text-2xl font-bold text-blue-700">${totalCount}</div>
      </div>
      <div class="card bg-white border border-gray-100 p-4">
        <div class="text-xs text-gray-400 mb-1">è‡¨å®‰åº—ä½”æ¯”</div>
        <div class="text-xl font-bold text-gray-700">${linanCount} <span class="text-xs font-normal text-gray-400">/ ${totalCount}</span></div>
      </div>
      <div class="card bg-white border border-gray-100 p-4">
        <div class="text-xs text-gray-400 mb-1">å—ç§‘åº—ä½”æ¯”</div>
        <div class="text-xl font-bold text-gray-700">${nankeCount} <span class="text-xs font-normal text-gray-400">/ ${totalCount}</span></div>
      </div>
      <!-- Future expansion slot -->
      <div class="card border border-dashed border-g
