<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¿«é€Ÿç™»è¨˜ v3.0 - å’Œå…‰å ‚</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4YWxwemN1bGN5aHp2bnl2ZWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwMTkzNjQsImV4cCI6MjA0OTU5NTM2NH0.7qGT_Jn9pY5_YZD5Lg6ATF_kn7x1kHJmMdgQcVGo5wc"
    );
  </script>
  <style>
    * { box-sizing: border-box; }
    body { 
      background-color: #f3f4f6; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0;
      padding: 0;
    }
    
    /* åµæ¸¬è¡Œå‹•è£ç½® */
    .desktop-mode { display: block; }
    .mobile-mode { display: none; }
    
    @media (max-width: 768px) {
      .desktop-mode { display: none; }
      .mobile-mode { display: block; }
    }
    
    /* === æ¡Œé¢ç‰ˆæ¨£å¼ === */
    .customer-card { 
      background: white; 
      border-radius: 16px; 
      padding: 20px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
      margin-bottom: 24px; 
      border: 1px solid #e5e7eb; 
    }
    
    .radio-btn, .chk-btn { 
      padding: 10px 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 50px; 
      font-size: 14px; 
      color: #4b5563; 
      cursor: pointer; 
      transition: 0.1s; 
      user-select: none; 
      background: white; 
      text-align: center;
    }
    .radio-btn:active, .chk-btn:active { transform: scale(0.95); }
    .radio-btn.selected, .chk-btn.checked { 
      background-color: #3b82f6; 
      color: white; 
      border-color: #3b82f6; 
      font-weight: 600; 
    }
    
    /* æ™ºèƒ½æ¨™ç±¤å€åŸŸï¼ˆæ¡Œé¢ç‰ˆï¼‰ */
    .smart-tags-area {
      display: none;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #fbbf24;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }
    .smart-tags-area.show { display: block; }
    
    .tag-category-desktop {
      margin-bottom: 12px;
    }
    .tag-category-desktop-title {
      font-size: 12px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 8px;
    }
    .tag-pills-desktop {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag-pill-desktop {
      padding: 6px 12px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 50px;
      font-size: 13px;
      color: #4b5563;
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
    }
    .tag-pill-desktop:active { transform: scale(0.95); }
    .tag-pill-desktop.active {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #3b82f6;
      font-weight: 700;
    }
    
    /* === æ‰‹æ©Ÿç‰ˆ Wizard æ¨£å¼ === */
    .wizard-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
    }
    
    .wizard-header {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 16px;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .progress-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 12px;
      gap: 8px;
    }
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: 0.3s;
    }
    .progress-dot.active {
      width: 32px;
      border-radius: 6px;
      background: white;
    }
    
    .wizard-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      padding-bottom: 100px;
    }
    
    .wizard-step {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease-out;
    }
    .wizard-step.active { display: block; }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .wizard-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .wizard-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    .wizard-btn-back {
      background: #f3f4f6;
      color: #6b7280;
    }
    .wizard-btn-reset {
      width: 50px;
      flex: 0;
      background: white;
      color: #ef4444;
      border: 2px solid #ef4444;
      font-size: 18px;
    }
    .wizard-btn-next {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .wizard-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .input-base { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e5e7eb; 
      border-radius: 12px; 
      font-size: 16px; 
      outline: none; 
      transition: 0.2s; 
    }
    .input-base:focus { 
      border-color: #3b82f6; 
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
    }
    
    .toast { 
      position: fixed; 
      top: 80px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: rgba(0, 0, 0, 0.85); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 8px; 
      font-size: 14px; 
      font-weight: 600; 
      z-index: 9999; 
      opacity: 0; 
      transition: opacity 0.3s; 
      pointer-events: none;
      backdrop-filter: blur(8px);
      max-width: 90%;
      text-align: center;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- === æ¡Œé¢ç‰ˆ === -->
<div class="desktop-mode">
  <div class="max-w-2xl mx-auto p-4">
    <div class="bg-blue-600 text-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center sticky top-2 z-40">
      <div>
        <div class="flex items-center gap-2">
          <h1 class="font-bold text-lg">ğŸ“ é¡§å®¢ç™»è¨˜</h1>
          <span class="text-[9px] bg-blue-500 px-2 py-0.5 rounded">v3.0</span>
          <input type="date" id="globalDate" class="text-sm bg-blue-500 text-white border-0 rounded px-2 py-1">
        </div>
      </div>
      <div class="flex items-center gap-2 bg-blue-700 rounded-lg p-1">
        <button onclick="setGlobalStore('è‡¨å®‰åº—')" id="gStoreLinAn" class="px-3 py-1 rounded text-sm">è‡¨å®‰åº—</button>
        <button onclick="setGlobalStore('å—ç§‘åº—')" id="gStoreNanKe" class="px-3 py-1 rounded text-sm">å—ç§‘åº—</button>
      </div>
    </div>

    <div id="cardsContainer"></div>
    <div style="height: 80px;"></div>
  </div>

  <div class="max-w-2xl mx-auto fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg flex gap-3">
    <button onclick="addCard()" class="flex-1 bg-white text-blue-600 border-2 border-blue-600 py-3 rounded-xl font-bold">+ å¢åŠ ä¸€ä½</button>
    <button onclick="submitAll()" id="btnSubmit" class="flex-2 bg-blue-600 text-white py-3 px-6 rounded-xl font-bold">ç¢ºèªé€å‡º</button>
  </div>
</div>

<!-- === æ‰‹æ©Ÿç‰ˆ Wizard === -->
<div class="mobile-mode">
  <div class="wizard-container">
    <div class="wizard-header">
      <div class="text-center">
        <h1 class="text-xl font-bold">ğŸ“ å¿«é€Ÿç™»è¨˜</h1>
        <p class="text-xs opacity-80 mt-1">æ­¥é©Ÿ <span id="wizardStepNum">1</span>/6</p>
      </div>
      <div class="progress-bar">
        <div class="progress-dot active" id="dot0"></div>
        <div class="progress-dot" id="dot1"></div>
        <div class="progress-dot" id="dot2"></div>
        <div class="progress-dot" id="dot3"></div>
        <div class="progress-dot" id="dot4"></div>
        <div class="progress-dot" id="dot5"></div>
      </div>
    </div>

    <div class="wizard-body" id="wizardBody">
      <!-- æ­¥é©Ÿå…§å®¹ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="wizard-footer">
      <button class="wizard-btn wizard-btn-back" id="wizardBack" onclick="wizardPrev()">â† è¿”å›</button>
      <button class="wizard-btn wizard-btn-reset" onclick="wizardReset()">ğŸ”„</button>
      <button class="wizard-btn wizard-btn-next" id="wizardNext" onclick="wizardNext()">ç¹¼çºŒ â†’</button>
    </div>
  </div>
</div>

<script>
  // å…¨åŸŸè®Šæ•¸
  const SOURCES = ["Google æœå°‹", "Google Map", "Facebook å»£å‘Š", "Instagram å»£å‘Š", "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "Mobile 01", "PTT", "è¦ªå‹ä»‹ç´¹", "é€”ç¶“è·¯é", "å…¶ä»–", "æ¥­é…è²¼æ–‡ (FBã€IG)", "è€å®¢å›è³¼", "è€å®¢-æœªè³¼", "å»£å‘Šçœ‹æ¿", "FB ç¤¾åœ˜æ–‡"];
  const PURPOSES = ["é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢", "å–®ç´”çœ‹çœ‹", "è³¼è²·å…¶ä»–å•†å“", "ä½æˆ¶è¦–åŠ›æª¢æŸ¥"];
  const AGES = ["18æ­²ä»¥ä¸‹", "18-24", "25-34", "35-44", "45-54", "55æ­²ä»¥ä¸Š"];
  
  let globalStore = '';
  let cardCount = 0;
  let wizardStep = 0;
  let wizardData = {
    date: '',
    store: '',
    name: '',
    gender: '',
    isTainan: true,
    age: '',
    sources: [],
    keywords: '',
    purposes: [],
    detail: ''
  };
  const tagCache = {};

  // Toast æç¤º
  function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
  }

  // === æ¡Œé¢ç‰ˆé‚è¼¯ ===
  window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('globalDate').value = today;
    
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    if(isMobile) {
      initWizard();
    } else {
      const cachedStore = localStorage.getItem('wakodo_last_store');
      if(cachedStore) {
        setGlobalStore(cachedStore);
      }
      addCard();
    }
  };

  window.setGlobalStore = (store) => {
    globalStore = store;
    localStorage.setItem('wakodo_last_store', store);
    document.getElementById('gStoreLinAn').className = store === 'è‡¨å®‰åº—' ? 'px-3 py-1 rounded text-sm bg-white text-blue-600' : 'px-3 py-1 rounded text-sm';
    document.getElementById('gStoreNanKe').className = store === 'å—ç§‘åº—' ? 'px-3 py-1 rounded text-sm bg-white text-blue-600' : 'px-3 py-1 rounded text-sm';
  };

  window.addCard = () => {
    cardCount++;
    const id = `card-${cardCount}`;
    const container = document.getElementById('cardsContainer');
    
    const cardHtml = `
      <div class="customer-card" id="${id}">
        <div class="flex justify-between items-center mb-4 pb-3 border-b">
          <span class="font-bold text-gray-700">é¡§å®¢ ${cardCount}</span>
          ${cardCount > 1 ? `<button onclick="removeCard('${id}')" class="text-red-500 text-sm font-bold">ç§»é™¤ âœ•</button>` : ''}
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-bold text-gray-600 mb-2">å§“å</label>
            <input type="text" class="input-base name-input" placeholder="è¼¸å…¥å§“å">
          </div>

          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-sm font-bold text-gray-600 mb-2">æ€§åˆ¥</label>
              <div class="flex gap-2" id="${id}-gender">
                <div class="radio-btn flex-1" onclick="selectRadio('${id}-gender', 'ç”·', this)">ç”·</div>
                <div class="radio-btn flex-1" onclick="selectRadio('${id}-gender', 'å¥³', this)">å¥³</div>
              </div>
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-2 cursor-pointer bg-blue-50 px-3 py-2 rounded-lg">
                <input type="checkbox" class="tainan-check" checked>
                <span class="text-sm font-bold text-blue-800">ä½å°å—</span>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-600 mb-2">å¹´é½¡å±¤</label>
            <div class="flex flex-wrap gap-2" id="${id}-age">
              ${AGES.map(age => `<div class="radio-btn" onclick="selectRadio('${id}-age', '${age}', this)">${age}</div>`).join('')}
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-600 mb-2">å®¢æºï¼ˆå¯å¤šé¸ï¼‰</label>
            <div class="grid grid-cols-3 gap-2" id="${id}-sources">
              ${SOURCES.map(s => `<div class="chk-btn" onclick="toggleSource(this, '${s}', '${id}')">${s}</div>`).join('')}
            </div>
            <div id="${id}-smart-tags" class="smart-tags-area">
              <div class="text-xs text-amber-800 font-bold mb-2">ğŸ’¡ æ™ºèƒ½æ¨è–¦é—œéµå­—ï¼ˆé»æ“Šæ·»åŠ ï¼‰</div>
              <div id="${id}-tags-loading" class="text-center text-amber-700 text-sm py-4">â³ è¼‰å…¥ä¸­...</div>
              <div id="${id}-tags-content"></div>
            </div>
            <input type="text" id="${id}-keyword-input" class="input-base mt-2 hidden" placeholder="æœå°‹é—œéµå­—">
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-600 mb-2">ç›®çš„ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div class="grid grid-cols-3 gap-2">
              ${PURPOSES.map(p => `<div class="chk-btn" onclick="toggleChk(this)">${p}</div>`).join('')}
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-600 mb-2">å‚™è¨»</label>
            <textarea class="input-base h-20 resize-none detail-input" placeholder="å®¢äººæè¿°..."></textarea>
          </div>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', cardHtml);
  };

  window.removeCard = (id) => {
    document.getElementById(id).remove();
    cardCount--;
  };

  window.selectRadio = (groupId, value, el) => {
    const container = document.getElementById(groupId);
    container.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    el.dataset.value = value;
    
    // æ¡Œé¢ç‰ˆï¼šæ€§åˆ¥æˆ–å¹´é½¡æ”¹è®Šæ™‚ï¼Œé‡æ–°è¼‰å…¥æ¨™ç±¤
    const cardId = groupId.split('-')[0] + '-' + groupId.split('-')[1];
    if(groupId.includes('gender') || groupId.includes('age')) {
      const smartTagsArea = document.getElementById(`${cardId}-smart-tags`);
      if(smartTagsArea && smartTagsArea.classList.contains('show')) {
        loadSmartTags(cardId);
      }
    }
  };

  window.toggleChk = (el) => {
    el.classList.toggle('checked');
  };

  window.toggleSource = (el, value, cardId) => {
    el.classList.toggle('checked');
    
    const hasGoogle = Array.from(document.querySelectorAll(`#${cardId}-sources .chk-btn.checked`))
      .some(btn => btn.innerText.includes('Google'));
    
    const smartTagsArea = document.getElementById(`${cardId}-smart-tags`);
    const keywordInput = document.getElementById(`${cardId}-keyword-input`);
    
    if(hasGoogle) {
      smartTagsArea.classList.add('show');
      keywordInput.classList.remove('hidden');
      loadSmartTags(cardId);
    } else {
      smartTagsArea.classList.remove('show');
      keywordInput.classList.add('hidden');
    }
  };

  // è¼‰å…¥æ™ºèƒ½æ¨™ç±¤ï¼ˆæ¡Œé¢ç‰ˆï¼‰
  async function loadSmartTags(cardId) {
    const card = document.getElementById(cardId);
    const genderEl = card.querySelector(`#${cardId}-gender .selected`);
    const ageEl = card.querySelector(`#${cardId}-age .selected`);
    
    if(!genderEl || !ageEl || !globalStore) {
      document.getElementById(`${cardId}-tags-loading`).innerHTML = 'âš ï¸ è«‹å…ˆé¸æ“‡æ€§åˆ¥ã€å¹´é½¡å’Œåˆ†åº—';
      return;
    }
    
    const gender = genderEl.dataset.value;
    const age = ageEl.dataset.value;
    const cacheKey = `${gender}-${age}-${globalStore}`;
    
    document.getElementById(`${cardId}-tags-loading`).style.display = 'block';
    document.getElementById(`${cardId}-tags-content`).innerHTML = '';
    
    try {
      let tags;
      if(tagCache[cacheKey]) {
        tags = tagCache[cacheKey];
      } else {
        const { data, error } = await supabase.rpc('get_smart_keyword_tags', {
          p_gender: gender,
          p_age_range: age,
          p_store: globalStore,
          tag_limit: 15
        });
        
        if(error) throw error;
        tags = data || [];
        tagCache[cacheKey] = tags;
      }
      
      document.getElementById(`${cardId}-tags-loading`).style.display = 'none';
      
      if(tags.length === 0) {
        document.getElementById(`${cardId}-tags-content`).innerHTML = '<div class="text-center text-amber-700 text-sm py-2">ç›®å‰æ²’æœ‰æ¨è–¦æ¨™ç±¤</div>';
        return;
      }
      
      renderDesktopTags(cardId, tags);
      
    } catch(err) {
      console.error('è¼‰å…¥æ™ºèƒ½æ¨™ç±¤å¤±æ•—:', err);
      document.getElementById(`${cardId}-tags-loading`).innerHTML = 'âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥';
    }
  }

  function renderDesktopTags(cardId, tags) {
    const grouped = tags.reduce((acc, tag) => {
      if(!acc[tag.category]) acc[tag.category] = [];
      acc[tag.category].push(tag);
      return acc;
    }, {});
    
    const categoryEmojis = {
      'åœ°å€': 'ğŸ“',
      'ç”¢å“': 'ğŸ‘“',
      'æœå‹™': 'ğŸ”§',
      'ç—‡ç‹€': 'ğŸ‘ï¸',
      'å“ç‰Œ': 'ğŸ·ï¸',
      'å½¢å®¹è©': 'âœ¨'
    };
    
    let html = '';
    for(const [cat, items] of Object.entries(grouped)) {
      html += `
        <div class="tag-category-desktop">
          <div class="tag-category-desktop-title">${categoryEmojis[cat] || 'â€¢'} ${cat}</div>
          <div class="tag-pills-desktop">
            ${items.map(tag => `
              <div class="tag-pill-desktop" onclick="toggleDesktopTag('${cardId}', '${tag.word}', this)">
                ${tag.word}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    document.getElementById(`${cardId}-tags-content`).innerHTML = html;
  }

  window.toggleDesktopTag = (cardId, word, el) => {
    el.classList.toggle('active');
    const input = document.getElementById(`${cardId}-keyword-input`);
    let keywords = input.value.trim().split(' ').filter(k => k);
    
    if(el.classList.contains('active')) {
      keywords.push(word);
    } else {
      keywords = keywords.filter(k => k !== word);
    }
    
    input.value = keywords.join(' ');
  };

  window.submitAll = async () => {
    if(!globalStore) {
      showToast('âš ï¸ è«‹å…ˆé¸æ“‡åˆ†åº—ï¼', 3000);
      return;
    }

    const cards = document.querySelectorAll('.customer-card');
    const btn = document.getElementById('btnSubmit');
    const selectedDate = document.getElementById('globalDate').value;
    
    let errors = [];
    cards.forEach((card, i) => {
      const cardNum = i + 1;
      const name = card.querySelector('.name-input').value.trim();
      const gender = card.querySelector('.selected');
      const sources = card.querySelectorAll('.chk-btn.checked');
      
      if(!name) errors.push(`ç¬¬${cardNum}ç­†ï¼šæœªå¡«å¯«å§“å`);
      if(!gender) errors.push(`ç¬¬${cardNum}ç­†ï¼šæœªé¸æ“‡æ€§åˆ¥`);
      if(sources.length === 0) errors.push(`ç¬¬${cardNum}ç­†ï¼šæœªé¸æ“‡å®¢æº`);
    });
    
    if(errors.length > 0) {
      alert('âš ï¸ è³‡æ–™æœ‰ç¼ºæ¼ï¼\n\n' + errors.join('\n'));
      return;
    }

    btn.disabled = true;
    btn.textContent = 'å‚³é€ä¸­...';
    
    // å¯¦éš›ä¸Šå‚³é‚è¼¯...
    
    showToast('âœ“ é€å‡ºæˆåŠŸï¼');
    setTimeout(() => {
      window.location.href = 'index.html';
    }, 1500);
  };

  // === æ‰‹æ©Ÿç‰ˆ Wizard é‚è¼¯ ===
  function initWizard() {
    wizardData.date = new Date().toISOString().split('T')[0];
    renderWizardStep();
  }

  function renderWizardStep() {
    const body = document.getElementById('wizardBody');
    const stepNum = document.getElementById('wizardStepNum');
    const backBtn = document.getElementById('wizardBack');
    const nextBtn = document.getElementById('wizardNext');
    
    stepNum.textContent = wizardStep + 1;
    backBtn.style.display = wizardStep === 0 ? 'none' : 'flex';
    
    // æ›´æ–°é€²åº¦é»
    for(let i = 0; i < 6; i++) {
      document.getElementById(`dot${i}`).className = i === wizardStep ? 'progress-dot active' : 'progress-dot';
    }
    
    let stepHtml = '';
    
    switch(wizardStep) {
      case 0:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">é¸æ“‡åˆ†åº—</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹é¸æ“‡æ‚¨æ‰€åœ¨çš„åˆ†åº—</p>
            
            <div class="space-y-3">
              <div class="p-4 border-2 rounded-xl cursor-pointer transition ${wizardData.store === 'è‡¨å®‰åº—' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" onclick="wizardSelectStore('è‡¨å®‰åº—')">
                <div class="font-bold text-lg">ğŸª è‡¨å®‰åº—</div>
              </div>
              <div class="p-4 border-2 rounded-xl cursor-pointer transition ${wizardData.store === 'å—ç§‘åº—' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" onclick="wizardSelectStore('å—ç§‘åº—')">
                <div class="font-bold text-lg">ğŸª å—ç§‘åº—</div>
              </div>
            </div>
            
            <div class="mt-6">
              <label class="block text-sm font-bold text-gray-600 mb-2">æ—¥æœŸ</label>
              <input type="date" id="wizardDate" value="${wizardData.date}" onchange="wizardData.date=this.value" class="input-base">
            </div>
          </div>
        `;
        break;
        
      case 1:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">åŸºæœ¬è³‡æ–™</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹å¡«å¯«é¡§å®¢åŸºæœ¬è³‡è¨Š</p>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-600 mb-2">å§“å</label>
                <input type="text" id="wizardName" value="${wizardData.name}" onchange="wizardData.name=this.value.trim()" class="input-base" placeholder="è«‹è¼¸å…¥å§“å">
              </div>
              
              <div>
                <label class="block text-sm font-bold text-gray-600 mb-2">æ€§åˆ¥</label>
                <div class="flex gap-3">
                  <div class="flex-1 p-4 border-2 rounded-xl text-center cursor-pointer ${wizardData.gender === 'ç”·' ? 'border-blue-500 bg-blue-50 font-bold' : 'border-gray-200'}" onclick="wizardSelectGender('ç”·')">ğŸ‘¨ ç”·</div>
                  <div class="flex-1 p-4 border-2 rounded-xl text-center cursor-pointer ${wizardData.gender === 'å¥³' ? 'border-blue-500 bg-blue-50 font-bold' : 'border-gray-200'}" onclick="wizardSelectGender('å¥³')">ğŸ‘© å¥³</div>
                </div>
              </div>
              
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" ${wizardData.isTainan ? 'checked' : ''} onchange="wizardData.isTainan=this.checked" class="w-5 h-5">
                  <span class="font-bold text-gray-700">ä½å°å—</span>
                </label>
              </div>
            </div>
          </div>
        `;
        break;
        
      case 2:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">å¹´é½¡å±¤</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹é¸æ“‡é¡§å®¢çš„å¹´é½¡å€é–“</p>
            
            <div class="grid grid-cols-2 gap-3">
              ${AGES.map(age => `
                <div class="p-4 border-2 rounded-xl text-center cursor-pointer ${wizardData.age === age ? 'border-blue-500 bg-blue-50 font-bold' : 'border-gray-200'}" onclick="wizardSelectAge('${age}')">
                  ${age}
                </div>
              `).join('')}
            </div>
          </div>
        `;
        break;
        
      case 3:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">å®¢æºç®¡é“</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹é¸æ“‡å®¢äººå¦‚ä½•å¾—çŸ¥ï¼ˆå¯å¤šé¸ï¼‰</p>
            
            <div class="grid grid-cols-2 gap-2">
              ${SOURCES.map(s => `
                <div class="p-3 border-2 rounded-xl text-center text-sm cursor-pointer ${wizardData.sources.includes(s) ? 'border-blue-500 bg-blue-50 font-bold' : 'border-gray-200'}" onclick="wizardToggleSource('${s}')">
                  ${s}
                </div>
              `).join('')}
            </div>
            
            ${wizardData.sources.some(s => s.includes('Google')) ? `
              <div class="mt-4">
                <label class="block text-sm font-bold text-gray-600 mb-2">ğŸ” æœå°‹é—œéµå­—</label>
                <input type="text" id="wizardKeywords" value="${wizardData.keywords}" onchange="wizardData.keywords=this.value.trim()" class="input-base" placeholder="ä¾‹å¦‚ï¼šå°å—çœ¼é¡æ¨è–¦">
              </div>
            ` : ''}
          </div>
        `;
        break;
        
      case 4:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ä¾†åº—ç›®çš„</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹é¸æ“‡å®¢äººçš„éœ€æ±‚ï¼ˆå¯å¤šé¸ï¼‰</p>
            
            <div class="grid grid-cols-2 gap-3">
              ${PURPOSES.map(p => `
                <div class="p-4 border-2 rounded-xl text-center text-sm cursor-pointer ${wizardData.purposes.includes(p) ? 'border-blue-500 bg-blue-50 font-bold' : 'border-gray-200'}" onclick="wizardTogglePurpose('${p}')">
                  ${p}
                </div>
              `).join('')}
            </div>
          </div>
        `;
        break;
        
      case 5:
        stepHtml = `
          <div class="wizard-step active">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">å‚™è¨»èªªæ˜</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹å¡«å¯«å®¢äººçš„è©³ç´°éœ€æ±‚æˆ–å‚™è¨»</p>
            
            <textarea id="wizardDetail" onchange="wizardData.detail=this.value.trim()" class="input-base h-32 resize-none" placeholder="å®¢äººæè¿°...">${wizardData.detail}</textarea>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-xl">
              <div class="text-sm font-bold text-gray-700 mb-3">ğŸ“‹ è³‡æ–™ç¢ºèª</div>
              <div class="text-xs text-gray-600 space-y-1">
                <div>å§“åï¼š${wizardData.name} (${wizardData.gender}) ${wizardData.isTainan ? 'ğŸ å°å—' : ''}</div>
                <div>å¹´é½¡ï¼š${wizardData.age}</div>
                <div>å®¢æºï¼š${wizardData.sources.join('ã€')}</div>
                ${wizardData.keywords ? `<div>é—œéµå­—ï¼š${wizardData.keywords}</div>` : ''}
                <div>ç›®çš„ï¼š${wizardData.purposes.join('ã€')}</div>
              </div>
            </div>
          </div>
        `;
        nextBtn.textContent = 'âœ“ é€å‡º';
        break;
    }
    
    body.innerHTML = stepHtml;
  }

  window.wizardSelectStore = (store) => {
    wizardData.store = store;
    renderWizardStep();
  };

  window.wizardSelectGender = (gender) => {
    wizardData.gender = gender;
    renderWizardStep();
  };

  window.wizardSelectAge = (age) => {
    wizardData.age = age;
    renderWizardStep();
  };

  window.wizardToggleSource = (source) => {
    const idx = wizardData.sources.indexOf(source);
    if(idx > -1) {
      wizardData.sources.splice(idx, 1);
    } else {
      wizardData.sources.push(source);
    }
    renderWizardStep();
  };

  window.wizardTogglePurpose = (purpose) => {
    const idx = wizardData.purposes.indexOf(purpose);
    if(idx > -1) {
      wizardData.purposes.splice(idx, 1);
    } else {
      wizardData.purposes.push(purpose);
    }
    renderWizardStep();
  };

  window.wizardNext = async () => {
    // é©—è­‰ç•¶å‰æ­¥é©Ÿ
    let error = '';
    switch(wizardStep) {
      case 0:
        if(!wizardData.store) error = 'è«‹é¸æ“‡åˆ†åº—';
        break;
      case 1:
        if(!wizardData.name) error = 'è«‹è¼¸å…¥å§“å';
        else if(!wizardData.gender) error = 'è«‹é¸æ“‡æ€§åˆ¥';
        break;
      case 2:
        if(!wizardData.age) error = 'è«‹é¸æ“‡å¹´é½¡å±¤';
        break;
      case 3:
        if(wizardData.sources.length === 0) error = 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å®¢æº';
        else if(wizardData.sources.some(s => s.includes('Google')) && !wizardData.keywords) error = 'é¸æ“‡ Google æœå°‹æ™‚ï¼Œé—œéµå­—ç‚ºå¿…å¡«';
        break;
      case 4:
        if(wizardData.purposes.length === 0) error = 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç›®çš„';
        break;
      case 5:
        if(!wizardData.detail) error = 'è«‹å¡«å¯«å‚™è¨»';
        break;
    }
    
    if(error) {
      showToast('âš ï¸ ' + error, 2500);
      return;
    }
    
    // æœ€å¾Œä¸€æ­¥ï¼šé€å‡º
    if(wizardStep === 5) {
      await wizardSubmit();
      return;
    }
    
    wizardStep++;
    renderWizardStep();
  };

  window.wizardPrev = () => {
    if(wizardStep > 0) {
      wizardStep--;
      renderWizardStep();
    }
  };

  window.wizardReset = () => {
    if(confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
      wizardData = {
        date: new Date().toISOString().split('T')[0],
        store: '',
        name: '',
        gender: '',
        isTainan: true,
        age: '',
        sources: [],
        keywords: '',
        purposes: [],
        detail: ''
      };
      wizardStep = 0;
      renderWizardStep();
      showToast('âœ“ å·²é‡ç½®');
    }
  };

  async function wizardSubmit() {
    const nextBtn = document.getElementById('wizardNext');
    nextBtn.disabled = true;
    nextBtn.textContent = 'å‚³é€ä¸­...';
    
    try {
      const payload = {
        p_date: wizardData.date,
        p_store: wizardData.store,
        p_name: wizardData.name,
        p_gender: wizardData.gender,
        p_age: wizardData.age,
        p_is_local: wizardData.isTainan,
        p_sources: wizardData.sources,
        p_purposes: wizardData.purposes,
        p_keywords: wizardData.keywords,
        p_detail: wizardData.detail
      };
      
      const { error } = await supabase.rpc('submit_visit_v7', payload);
      if(error) throw error;
      
      showToast('ğŸ‰ æˆåŠŸæ–°å¢è³‡æ–™ï¼', 2000);
      
      setTimeout(() => {
        if(confirm('âœ“ é€å‡ºæˆåŠŸï¼\n\næŒ‰ã€Œç¢ºå®šã€è¿”å›å„€è¡¨æ¿\næŒ‰ã€Œå–æ¶ˆã€å¡«å¯«ä¸‹ä¸€ç­†')) {
          window.location.href = 'index.html';
        } else {
          wizardReset();
        }
      }, 1500);
      
    } catch(err) {
      console.error('é€å‡ºå¤±æ•—:', err);
      showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + err.message, 3000);
      nextBtn.disabled = false;
      nextBtn.textContent = 'âœ“ é€å‡º';
    }
  }
</script>
</body>
</html>
