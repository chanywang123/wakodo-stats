<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“ é¡§å®¢ç™»è¨˜ v3.4</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4YWxwemN1bGN5aHp2bnl2ZWNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjk5OTIsImV4cCI6MjA4MzYwNTk5Mn0.rxdujTa6x37QpDtm1uTrYIZ_6MTNVcqLMEuJYvfFKPI"
    );
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: #f5f7fa;
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 110px; /* é¿å…åº•éƒ¨ fixed æŒ‰éˆ•æ“‹ä½å…§å®¹ */
    }

    /* åˆ†åº—æŒ‰éˆ•ï¼šæ²¿ç”¨æ–°ç‰ˆ active æ¨£å¼ï¼ˆJS æœƒ toggle activeï¼‰ */
    .store-btn {
      border: 2px solid #e5e7eb;
      background: white;
      color: #6b7280;
      transition: all 0.2s;
      font-weight: 600;
    }
    .store-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    /* é¡§å®¢å¡ç‰‡ */
    .customer-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 16px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f3f4f6;
    }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
    }
    .remove-btn {
      padding: 6px 16px;
      background: #fee;
      color: #dc2626;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
    }

    /* è¡¨å–®å€å¡Š */
    .form-section { margin-bottom: 20px; }
    .section-label {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      margin-bottom: 10px;
      display: block;
    }
    .required-mark { color: #dc2626; margin-left: 4px; }

    /* è¼¸å…¥æ¡† */
    .text-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      background: white;
    }
    .text-input:focus { border-color: #3b82f6; }
    .text-input.error { border-color: #dc2626; }

    /* æŒ‰éˆ•ç¶²æ ¼ */
    .btn-grid { display: grid; gap: 10px; }
    @media (max-width: 768px) {
      .btn-grid { grid-template-columns: repeat(3, 1fr); }
      .btn-grid.two-col { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 769px) {
      .btn-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .btn-grid.two-col { grid-template-columns: repeat(2, 1fr); }
    }

    /* é¸é …æŒ‰éˆ• */
    .option-btn {
      padding: 14px 8px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      background: white;
      color: #4b5563;
      font-size: 15px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .option-btn:active { transform: scale(0.96); }
    .option-btn.selected {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
      font-weight: 700;
    }

    /* å±…ä½åœ°åˆ‡æ›æŒ‰éˆ• */
    .toggle-btn {
      padding: 14px;
      border: 2px solid #10b981;
      border-radius: 10px;
      background: #d1fae5;
      color: #065f46;
      font-size: 15px;
      font-weight: 800;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toggle-btn.unchecked {
      background: white;
      border-color: #e5e7eb;
      color: #6b7280;
      font-weight: 600;
    }
    .warning-text {
      font-size: 12px;
      color: #dc2626;
      margin-top: 6px;
      font-weight: 700;
    }

    /* æ–‡å­—å€åŸŸ */
    textarea.text-input {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    /* Toast é€šçŸ¥ */
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* æˆåŠŸå½ˆçª— */
    .success-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .success-modal.show { display: flex; }
    .success-content {
      background: white;
      border-radius: 16px;
      padding: 32px 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .success-icon { font-size: 64px; margin-bottom: 16px; }
    .success-title {
      font-size: 24px;
      font-weight: 800;
      color: #10b981;
      margin-bottom: 24px;
    }
    .success-actions { display: flex; flex-direction: column; gap: 12px; }
    .success-btn {
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .success-btn-primary { background: #3b82f6; color: white; }
    .success-btn-secondary { background: #10b981; color: white; }
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <!-- é€å‡ºæˆåŠŸå½ˆçª— -->
  <div id="successModal" class="success-modal">
    <div class="success-content">
      <div class="success-icon">âœ…</div>
      <div class="success-title">é€å‡ºæˆåŠŸï¼</div>
      <div class="success-actions">
        <button class="success-btn success-btn-primary" onclick="window.location.href='index.html'">ğŸ“Š å‰å¾€æŸ¥çœ‹æ•¸æ“š</button>
        <button class="success-btn success-btn-secondary" onclick="location.reload()">â• ç¹¼çºŒå¡«å¯«</button>
      </div>
    </div>
  </div>

  <!-- èˆŠç‰ˆçª„ç‰ˆå¤–è§€ï¼ˆç½®ä¸­ + max-wï¼‰ï¼Œä½†ä¿ç•™æ–°ç‰ˆåŠŸèƒ½ id/onclick -->
  <div class="max-w-xl mx-auto p-4">
    <div class="bg-blue-600 text-white p-4 rounded-xl shadow-md mb-4 flex justify-between items-center sticky top-2 z-40">
      <div class="flex items-center gap-2 flex-wrap">
        <h1 class="font-bold text-lg">ğŸ“ é¡§å®¢ç™»è¨˜</h1>
        <span class="text-[9px] bg-blue-500 px-2 py-0.5 rounded">v3.4</span>
        <input type="date" id="globalDate" class="text-sm bg-blue-500 text-white border-0 rounded px-2 py-1" required>
      </div>

      <div class="flex items-center gap-2 bg-blue-700 rounded-lg p-1">
        <button onclick="selectStore('è‡¨å®‰åº—')" id="btnStore1" class="store-btn px-3 py-1 rounded text-sm">è‡¨å®‰åº—</button>
        <button onclick="selectStore('å—ç§‘åº—')" id="btnStore2" class="store-btn px-3 py-1 rounded text-sm">å—ç§‘åº—</button>
      </div>
    </div>

    <div class="text-xs text-gray-500 px-1 mb-2">ğŸ’¡ è‹¥ç‚ºè£œç™»å‰å¹¾å¤©çš„å®¢äººï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„åˆ°åº—æ—¥æœŸ</div>

    <div class="bg-amber-50 border border-amber-200 text-amber-800 text-sm font-semibold rounded-xl p-3 mb-4">
      âš ï¸ è«‹ç¢ºèªé¸æ“‡æ­£ç¢ºçš„é–€åº—èˆ‡æ—¥æœŸï¼Œé¿å…è³‡æ–™éŒ¯èª¤
    </div>

    <div id="cardsContainer"></div>

    <!-- æ’é–‹åº•éƒ¨ç©ºé–“ï¼Œé¿å…è¢« fixed footer æ“‹ä½ -->
    <div style="height: 90px;"></div>
  </div>

  <!-- èˆŠç‰ˆçª„ç‰ˆåº•éƒ¨å›ºå®šåˆ—ï¼ˆåŒå¯¬ç½®ä¸­ï¼‰ -->
  <div class="max-w-xl mx-auto fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg flex gap-3">
    <button onclick="addCustomerCard()" class="flex-1 bg-white text-blue-600 border-2 border-blue-600 py-3 rounded-xl font-bold">+ å¢åŠ </button>
    <button onclick="submitAllData()" id="btnSubmit" class="flex-[2] bg-blue-600 text-white py-3 px-6 rounded-xl font-bold">ç¢ºèªé€å‡º</button>
  </div>

  <script>
    const SOURCES = ["Google æœå°‹", "Google Map", "Facebook å»£å‘Š", "Instagram å»£å‘Š", "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "Mobile 01", "PTT", "è¦ªå‹ä»‹ç´¹", "é€”ç¶“è·¯é", "å…¶ä»–", "æ¥­é…è²¼æ–‡ (FBã€IG)", "è€å®¢å›è³¼", "è€å®¢-æœªè³¼", "å»£å‘Šçœ‹æ¿", "FBã€IG ç¤¾åœ˜"];
    const PURPOSES = ["é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢", "å–®ç´”çœ‹çœ‹", "è³¼è²·å…¶ä»–å•†å“", "ä½æˆ¶è¦–åŠ›æª¢æŸ¥"];
    const AGES = ["18æ­²ä»¥ä¸‹", "18-24", "25-34", "35-44", "45-54", "55æ­²ä»¥ä¸Š"];

    let globalStore = '';
    let cardCounter = 0;

    function showToast(message, duration = 2500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('globalDate').value = today;

      const savedStore = localStorage.getItem('wakodo_store');
      if (savedStore) selectStore(savedStore);

      addCustomerCard();
    };

    window.selectStore = (store) => {
      globalStore = store;
      localStorage.setItem('wakodo_store', store);

      document.getElementById('btnStore1').classList.toggle('active', store === 'è‡¨å®‰åº—');
      document.getElementById('btnStore2').classList.toggle('active', store === 'å—ç§‘åº—');
    };

    window.addCustomerCard = () => {
      cardCounter++;
      const cardId = `card-${cardCounter}`;
      const cardNum = cardCounter;

      const cardHtml = `
        <div class="customer-card" id="${cardId}">
          <div class="card-header">
            <div class="card-title">ğŸ‘¤ é¡§å®¢ ${cardNum}</div>
            ${cardNum > 1 ? `<button class="remove-btn" onclick="removeCard('${cardId}')">ç§»é™¤</button>` : ''}
          </div>

          <div class="form-section">
            <label class="section-label">å§“å <span class="required-mark">*</span></label>
            <input type="text" class="text-input name-input" placeholder="è«‹è¼¸å…¥é¡§å®¢å§“å" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-section" style="margin-bottom: 0;">
              <label class="section-label">æ€§åˆ¥ <span class="required-mark">*</span></label>
              <div class="btn-grid two-col" data-type="radio" data-name="gender">
                <div class="option-btn" onclick="selectRadio(this, 'gender-${cardId}')">ç”·</div>
                <div class="option-btn" onclick="selectRadio(this, 'gender-${cardId}')">å¥³</div>
              </div>
            </div>

            <div class="form-section" style="margin-bottom: 0;">
              <label class="section-label">å±…ä½åœ° <span class="required-mark">*</span></label>
              <div class="toggle-btn" id="local-${cardId}" onclick="toggleLocal(this)">ğŸ  å°å—ä½æˆ¶</div>
              <div class="warning-text">âš ï¸ éå°å—ä½æˆ¶è«‹å–æ¶ˆ</div>
            </div>
          </div>

          <div class="form-section">
            <label class="section-label">å¹´é½¡å±¤ <span class="required-mark">*</span></label>
            <div class="btn-grid" data-type="radio" data-name="age">
              ${AGES.map(age => `<div class="option-btn" onclick="selectRadio(this, 'age-${cardId}')">${age}</div>`).join('')}
            </div>
          </div>

          <div class="form-section">
            <label class="section-label">å®¢æº <span class="required-mark">*</span> (å¯å¤šé¸)</label>

            <div class="form-section" id="keyword-section-${cardId}" style="display: none; margin-bottom: 12px;">
              <input type="text" class="text-input keyword-input" id="keyword-${cardId}" placeholder="è«‹è¼¸å…¥ Google æœå°‹é—œéµå­—" required>
            </div>

            <div class="btn-grid" id="sources-${cardId}" data-type="checkbox">
              ${SOURCES.map(src => `<div class="option-btn" onclick="toggleCheckbox(this, '${cardId}')">${src}</div>`).join('')}
            </div>
          </div>

          <div class="form-section">
            <label class="section-label">ä¾†åº—ç›®çš„ <span class="required-mark">*</span> (å¯å¤šé¸)</label>
            <div class="btn-grid" data-type="checkbox">
              ${PURPOSES.map(p => `<div class="option-btn" onclick="toggleCheckbox(this, '${cardId}')">${p}</div>`).join('')}
            </div>
          </div>

          <div class="form-section">
            <label class="section-label">å‚™è¨» <span class="required-mark">*</span></label>
            <textarea class="text-input detail-input" placeholder="è«‹æè¿°é¡§å®¢éœ€æ±‚ã€ç‰¹å¾µæˆ–å…¶ä»–é‡è¦è³‡è¨Š" required></textarea>
          </div>
        </div>
      `;

      document.getElementById('cardsContainer').insertAdjacentHTML('beforeend', cardHtml);

      if (cardNum > 1) {
        setTimeout(() => {
          document.getElementById(cardId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }
    };

    window.removeCard = (cardId) => {
      if (confirm('ç¢ºå®šè¦ç§»é™¤é€™ä½é¡§å®¢çš„è³‡æ–™å—ï¼Ÿ')) {
        document.getElementById(cardId).remove();
      }
    };

    window.selectRadio = (el, groupName) => {
      const container = el.parentElement;
      container.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      el.classList.add('selected');
    };

    window.toggleCheckbox = (el, cardId) => {
      el.classList.toggle('selected');

      const sourcesContainer = document.getElementById(`sources-${cardId}`);
      if (sourcesContainer && sourcesContainer.contains(el)) {
        const selectedSources = Array.from(sourcesContainer.querySelectorAll('.option-btn.selected'))
          .map(btn => btn.textContent.trim());

        const hasGoogle = selectedSources.some(s => s.includes('Google'));
        const keywordSection = document.getElementById(`keyword-section-${cardId}`);

        if (hasGoogle) {
          keywordSection.style.display = 'block';
        } else {
          keywordSection.style.display = 'none';
          document.getElementById(`keyword-${cardId}`).value = '';
        }
      }
    };

    window.toggleLocal = (el) => {
      el.classList.toggle('unchecked');
      if (el.classList.contains('unchecked')) {
        el.textContent = 'âŒ éå°å—ä½æˆ¶';
      } else {
        el.textContent = 'ğŸ  å°å—ä½æˆ¶';
      }
    };

    window.submitAllData = async () => {
      if (!globalStore) {
        showToast('âš ï¸ è«‹å…ˆé¸æ“‡åˆ†åº—ï¼');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }

      const date = document.getElementById('globalDate').value;
      if (!date) {
        showToast('âš ï¸ è«‹é¸æ“‡æ—¥æœŸï¼');
        return;
      }

      const cards = document.querySelectorAll('.customer-card');
      let allData = [];
      let errors = [];

      cards.forEach((card, idx) => {
        const num = idx + 1;
        const cardId = card.id;

        const name = card.querySelector('.name-input').value.trim();
        const genderEl = card.querySelector('[data-name^="gender"] .selected');
        const gender = genderEl ? genderEl.textContent.trim() : '';

        const localBtn = card.querySelector(`[id^="local-"]`);
        const isLocal = !localBtn.classList.contains('unchecked');

        const ageEl = card.querySelector('[data-name^="age"] .selected');
        const age = ageEl ? ageEl.textContent.trim() : '';

        const sources = Array.from(card.querySelectorAll('[id^="sources-"] .selected')).map(el => el.textContent.trim());
        const purposes = Array.from(card.querySelectorAll('[data-type="checkbox"]:not([id]) .selected')).map(el => el.textContent.trim());

        const keywordInput = card.querySelector('.keyword-input');
        const keyword = keywordInput ? keywordInput.value.trim() : '';

        const detail = card.querySelector('.detail-input').value.trim();

        if (!name) errors.push(`ã€é¡§å®¢ ${num}ã€‘å§“åæœªå¡«å¯«`);
        if (!gender) errors.push(`ã€é¡§å®¢ ${num}ã€‘æ€§åˆ¥æœªé¸æ“‡`);
        if (!age) errors.push(`ã€é¡§å®¢ ${num}ã€‘å¹´é½¡å±¤æœªé¸æ“‡`);
        if (sources.length === 0) errors.push(`ã€é¡§å®¢ ${num}ã€‘å®¢æºæœªé¸æ“‡`);
        if (purposes.length === 0) errors.push(`ã€é¡§å®¢ ${num}ã€‘ä¾†åº—ç›®çš„æœªé¸æ“‡`);
        if (!detail) errors.push(`ã€é¡§å®¢ ${num}ã€‘å‚™è¨»æœªå¡«å¯«`);

        const hasGoogle = sources.some(s => s.includes('Google'));
        if (hasGoogle && !keyword) {
          errors.push(`ã€é¡§å®¢ ${num}ã€‘é¸æ“‡äº† Google ç›¸é—œä¾†æºï¼Œä½†æœªå¡«å¯«æœå°‹é—œéµå­—`);
        }

        allData.push({
          p_date: date,
          p_store: globalStore,
          p_name: name,
          p_gender: gender,
          p_age: age,
          p_is_local: isLocal,
          p_sources: sources,
          p_purposes: purposes,
          p_keywords: keyword,
          p_detail: detail
        });
      });

      if (errors.length > 0) {
        alert('âŒ è³‡æ–™æœªå®Œæ•´å¡«å¯«ï¼š\n\n' + errors.join('\n'));
        return;
      }

      if (!confirm(`ç¢ºå®šè¦é€å‡º ${allData.length} ä½é¡§å®¢çš„è³‡æ–™å—ï¼Ÿ`)) return;

      const btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.textContent = 'å‚³é€ä¸­...';

      try {
        for (let data of allData) {
          const { error } = await supabase.rpc('submit_visit_v7', data);
          if (error) throw error;
        }

        btn.textContent = 'ç¢ºèªé€å‡º';
        btn.disabled = false;

        document.getElementById('successModal').classList.add('show');
      } catch (err) {
        console.error(err);
        alert('âŒ é€å‡ºå¤±æ•—ï¼š' + err.message);
        btn.disabled = false;
        btn.textContent = 'ç¢ºèªé€å‡º';
      }
    };
  </script>
</body>
</html>
