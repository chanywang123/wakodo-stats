<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å’Œå…‰å ‚æˆ°æƒ…å®¤ V3.4 (Final)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    window.supabase = createClient(
      "https://yxalpzculcyhzvnyvecb.supabase.co", 
      "sb_publishable_NqpdQeAYGWTFBcdjkAQ4eQ_AT2GXf5k"
    );
  </script>
  <style>
    body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; transition: 0.2s; }
    .btn-stat { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .btn-stat:hover { transform: translateY(-2px); shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-stat.active { border-color: #3b82f6; background-color: #eff6ff; }
    .btn-primary { background: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 500; transition: 0.2s; }
    .btn-primary:hover { background: #1d4ed8; }
    
    /* Modal Styling */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
    
    /* Checkbox Grid */
    .chk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
    .chk-label { display: flex; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.1s; }
    .chk-label:hover { background: #f9fafb; }
    .chk-label input:checked + span { font-weight: bold; color: #2563eb; }
    .chk-label.checked { border-color: #2563eb; background: #eff6ff; }
    
    /* Admin Styling - strict visibility control */
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: table-cell !important; } /* For table cells */
    body.is-admin div.admin-only, body.is-admin button.admin-only { display: inline-block !important; }
  </style>
</head>
<body class="text-gray-800">

<div class="max-w-7xl mx-auto p-4">
  <!-- Top Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-gray-900 tracking-tight">ğŸ‘“ å’Œå…‰å ‚æˆ°æƒ…å®¤</h1>
      <div class="flex flex-col text-[10px] text-blue-600 font-bold leading-tight border-l-2 border-blue-200 pl-2">
        <span>V3.4 Stable</span>
        <span id="updateTime">2026-01-13</span>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <!-- Admin Gear -->
      <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition" title="ç®¡ç†å“¡ç™»å…¥">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      </button>
      <button onclick="openAddModal()" class="btn-primary shadow-sm">+ æ–°å¢è³‡æ–™</button>
    </div>
  </div>

  <!-- Admin Panel (Collapsible) -->
  <div id="adminPanel" class="hidden mb-6 card bg-gray-800 text-white border border-gray-700">
    <!-- Login Form -->
    <div id="loginForm" class="flex flex-col md:flex-row gap-3 items-center">
      <div class="flex-grow w-full md:w-auto">
        <label class="text-xs text-gray-400 mb-1 block">ç®¡ç†å“¡ Email</label>
        <input type="email" id="admEmail" value="chanywang92@gmail.com" class="w-full text-gray-800 p-2 rounded text-sm" placeholder="Email">
      </div>
      <div class="flex-grow w-full md:w-auto">
        <label class="text-xs text-gray-400 mb-1 block">å¯†ç¢¼</label>
        <input type="password" id="admPwd" class="w-full text-gray-800 p-2 rounded text-sm" placeholder="Password">
      </div>
      <button onclick="login()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold mt-4 md:mt-0">ç™»å…¥</button>
    </div>

    <!-- Admin Actions (Show after login) -->
    <div id="adminActions" class="hidden flex flex-wrap gap-4 items-center justify-between w-full">
      <div class="flex items-center gap-2 text-green-400 font-bold">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <span>å·²ç™»å…¥ç®¡ç†æ¨¡å¼</span>
      </div>
      <div class="flex gap-2">
        <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 px-3 py-1.5 rounded text-sm flex items-center gap-1 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
          <span>åŒ¯å…¥ CSV</span>
          <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(this)">
        </label>
        <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-sm transition">åŒ¯å‡º CSV</button>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded text-sm transition">ç™»å‡º</button>
      </div>
    </div>
  </div>

  <!-- Search & Filter Bar -->
  <div class="card mb-6 flex flex-wrap gap-3 items-center bg-white sticky top-2 z-30 shadow-sm border border-gray-100">
    <div class="flex items-center border rounded px-2 bg-gray-50 py-1">
      <span class="text-gray-400 text-xs mr-2 font-bold">æœŸé–“</span>
      <input type="date" id="qFrom" class="bg-transparent text-sm outline-none w-28">
      <span class="text-gray-400 mx-1">-</span>
      <input type="date" id="qTo" class="bg-transparent text-sm outline-none w-28">
    </div>
    <div class="flex-grow relative">
      <input type="text" id="qSearch" placeholder="æœå°‹å§“åã€é›»è©±æˆ–å‚™è¨»..." class="w-full border rounded pl-9 pr-2 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
      <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>
    <button onclick="fetchData()" class="bg-gray-800 text-white px-5 py-1.5 rounded text-sm hover:bg-gray-700 font-medium transition">æŸ¥è©¢</button>
  </div>

  <!-- KPI Buttons -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div onclick="setStore('å…¨éƒ¨')" id="btnTotal" class="card btn-stat flex flex-col justify-center items-center active py-6">
      <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">ç¸½å®¢æ•¸</div>
      <div class="text-4xl font-extrabold text-gray-800" id="statTotal">--</div>
    </div>
    <div onclick="setStore('è‡¨å®‰åº—')" id="btnLinAn" class="card btn-stat flex flex-col justify-center items-center py-6">
      <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">è‡¨å®‰åº—</div>
      <div class="text-4xl font-extrabold text-blue-600" id="statLinAn">--</div>
    </div>
    <div onclick="setStore('å—ç§‘åº—')" id="btnNanKe" class="card btn-stat flex flex-col justify-center items-center py-6">
      <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">å—ç§‘åº—</div>
      <div class="text-4xl font-extrabold text-green-600" id="statNanKe">--</div>
    </div>
  </div>

  <!-- Dashboard Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Left: Source Analysis -->
    <div class="card h-[480px] flex flex-col">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h3 class="font-bold text-gray-800">å®¢æºåˆ†æ</h3>
        <select id="sourceFilter" onchange="filterSource()" class="border rounded px-2 py-1 text-xs bg-gray-50 outline-none focus:border-blue-500">
          <option value="ALL">é¡¯ç¤ºå…¨éƒ¨å®¢æº</option>
        </select>
      </div>
      <div class="flex-grow relative w-full h-full min-h-0">
        <canvas id="chartSource"></canvas>
      </div>
      <!-- Trend Mini Chart (Hidden by default) -->
      <div id="trendBox" class="h-[120px] mt-4 hidden bg-blue-50/50 rounded-lg p-2 border border-blue-100">
        <div class="flex justify-between items-center mb-1">
          <div class="text-xs font-bold text-blue-800 flex items-center gap-1">
            <span class="w-2 h-2 rounded-full bg-blue-600"></span>
            <span id="trendLabel"></span> è¶¨å‹¢
          </div>
        </div>
        <div class="relative h-[80px] w-full">
          <canvas id="chartTrendMini"></canvas>
        </div>
      </div>
    </div>

    <!-- Right: Purpose Analysis -->
    <div class="card h-[480px] flex flex-col">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
        <div class="flex items-center gap-2">
          <h3 class="font-bold text-gray-800">ä¾†åº—ç›®çš„</h3>
          <span id="purposeSubtitle" class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">(å…¨éƒ¨)</span>
        </div>
      </div>
      <div class="flex-grow relative w-full h-full min-h-0 flex justify-center">
        <canvas id="chartPurpose"></canvas>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="card overflow-hidden">
    <div class="flex justify-between items-center mb-4 px-2">
      <h3 class="font-bold text-gray-800 flex items-center gap-2">
        æœ€æ–°ä¾†å®¢ç´€éŒ„ 
        <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">Top 50</span>
      </h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left whitespace-nowrap">
        <thead class="bg-gray-50 text-gray-500 font-semibold border-b border-gray-200">
          <tr>
            <th class="p-3 pl-4">æ—¥æœŸ</th>
            <th class="p-3">åˆ†åº—</th>
            <th class="p-3">å§“å</th>
            <th class="p-3">å®¢æº</th>
            <th class="p-3">ç›®çš„</th>
            <th class="p-3 pr-4 admin-only text-right">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal-content shadow-2xl">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl transition">&times;</button>
    <h2 id="modalTitle" class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">æ–°å¢è³‡æ–™</h2>
    
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div><label class="text-xs font-bold text-gray-500 mb-1 block">æ—¥æœŸ</label><input type="date" id="mDate" class="w-full border border-gray-300 rounded p-2 focus:border-blue-500 outline-none"></div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">åˆ†åº—</label>
          <select id="mStore" class="w-full border border-gray-300 rounded p-2 bg-gray-50"><option value="è‡¨å®‰åº—">è‡¨å®‰åº—</option><option value="å—ç§‘åº—">å—ç§‘åº—</option></select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="text-xs font-bold text-gray-500 mb-1 block">å§“å</label><input type="text" id="mName" class="w-full border border-gray-300 rounded p-2" placeholder="é¡§å®¢å§“å"></div>
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">æ€§åˆ¥</label>
          <select id="mGender" class="w-full border border-gray-300 rounded p-2"><option value="">æœªé¸æ“‡</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 items-end">
        <div>
          <label class="text-xs font-bold text-gray-500 mb-1 block">å¹´é½¡å±¤</label>
          <select id="mAge" class="w-full border border-gray-300 rounded p-2"><option value="25-34">25-34</option><option value="35-44">35-44</option><option value="18-24">18-24</option><option value="45-54">45-54</option><option value="55æ­²ä»¥ä¸Š">55æ­²ä»¥ä¸Š</option><option value="18æ­²ä»¥ä¸‹">18æ­²ä»¥ä¸‹</option></select>
        </div>
        <label class="flex items-center gap-2 p-2 border border-gray-200 rounded cursor-pointer hover:bg-gray-50 transition h-[42px]">
          <input type="checkbox" id="mTainan" class="w-4 h-4 text-blue-600 rounded">
          <span class="text-sm font-bold text-gray-700">æ˜¯å°å—äºº</span>
        </label>
      </div>
      
      <div><label class="text-xs font-bold text-gray-500 mb-2 block">å®¢æº (è¤‡é¸)</label><div class="chk-grid" id="chkSources"></div></div>
      
      <div id="keywordBox" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-200 mt-2">
        <label class="text-xs font-bold text-yellow-700 mb-1 block">Google æœå°‹é—œéµå­—</label>
        <input type="text" id="mKeyword" class="w-full bg-white border border-yellow-300 rounded p-1 text-sm outline-none" placeholder="ä¾‹å¦‚ï¼šå°å—çœ¼é¡è¡Œã€é©—å…‰æ¨è–¦...">
      </div>
      
      <div><label class="text-xs font-bold text-gray-500 mb-2 block mt-2">ç›®çš„ (è¤‡é¸)</label><div class="chk-grid" id="chkPurposes"></div></div>
      
      <div><label class="text-xs font-bold text-gray-500 mb-1 block">å‚™è¨»</label><textarea id="mDetail" class="w-full border border-gray-300 rounded p-2 text-sm h-20 resize-none" placeholder="è¼¸å…¥é¡§å®¢è©³ç´°éœ€æ±‚æˆ–å°è©±é‡é»..."></textarea></div>
      
      <button id="btnSave" onclick="saveData()" class="w-full btn-primary py-3 font-bold text-lg shadow-md hover:shadow-lg mt-4">å„²å­˜è³‡æ–™</button>
    </div>
  </div>
</div>

<script>
  // --- CONFIGURATION ---
  const SOURCES = ["Google æœå°‹", "Google Map", "è¦ªå‹ä»‹ç´¹", "è€å®¢å›è³¼", "è€å®¢-æœªè³¼", "é€”ç¶“è·¯é", "Facebook å»£å‘Š", "Instagram å»£å‘Š", "FBã€IG ä¸€èˆ¬æ–‡ç« ", "TikTok & YouTube", "Dcard", "PTT", "å…¶ä»–"];
  const PURPOSES = ["é©—å…‰é…é¡", "è³¼è²·éš±å½¢çœ¼é¡", "èª¿æ•´çœ¼é¡", "å–®ç´”è²·æ¡†", "å•é¡Œè«®è©¢", "è³¼è²·å…¶ä»–å•†å“"];
  
  // --- STATE ---
  let visits = [], stats = {}, currentStore = 'å…¨éƒ¨', charts = {};

  document.getElementById('updateTime').textContent = new Date().toISOString().split('T')[0];
  
  // --- INITIALIZATION ---
  window.onload = () => {
    // é è¨­æ™‚é–“ï¼š2024-01-01 åˆ° ä»Šå¤©
    document.getElementById('qFrom').value = "2024-01-01";
    document.getElementById('qTo').value = new Date().toISOString().split('T')[0];

    // åˆå§‹åŒ– Checkbox èˆ‡ ä¸‹æ‹‰é¸å–®
    initCheckboxes('chkSources', SOURCES);
    initCheckboxes('chkPurposes', PURPOSES);
    SOURCES.forEach(s => {
      const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
      document.getElementById('sourceFilter').appendChild(opt);
    });

    setStore('å…¨éƒ¨');
    checkAuth(); // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
  };

  function initCheckboxes(id, list) {
    document.getElementById(id).innerHTML = list.map(item => `
      <label class="chk-label select-none">
        <input type="checkbox" value="${item}" class="mr-2 hidden" onchange="this.parentElement.classList.toggle('checked', this.checked)">
        <span>${item}</span>
      </label>
    `).join('');
    
    // Google é—œéµå­—é€£å‹•
    if(id === 'chkSources') {
      document.getElementById(id).addEventListener('change', () => {
        const hasGoogle = Array.from(document.querySelectorAll('#chkSources input:checked')).some(i => i.value.includes('Google'));
        document.getElementById('keywordBox').classList.toggle('hidden', !hasGoogle);
      });
    }
  }

  // --- CORE FUNCTIONS ---
  window.setStore = (storeName) => {
    currentStore = storeName;
    document.querySelectorAll('.btn-stat').forEach(b => b.classList.remove('active'));
    if(storeName === 'å…¨éƒ¨') document.getElementById('btnTotal').classList.add('active');
    if(storeName === 'è‡¨å®‰åº—') document.getElementById('btnLinAn').classList.add('active');
    if(storeName === 'å—ç§‘åº—') document.getElementById('btnNanKe').classList.add('active');
    fetchData();
  };

  window.fetchData = async () => {
    const from = document.getElementById('qFrom').value;
    const to = document.getElementById('qTo').value;
    const keyword = document.getElementById('qSearch').value;
    
    const { data: listData } = await supabase.rpc('get_visits_public', { start_date: from, end_date: to, keyword: keyword, store_filter: currentStore });
    const { data: statData } = await supabase.rpc('get_stats_public', { start_date: from, end_date: to, store_filter: currentStore });

    if(listData && statData) {
      visits = listData; stats = statData;
      
      // æ›´æ–°å³ä¸Šè§’æŒ‰éˆ•æ•¸å­— (å¦å¤–æŠ“å–çœŸå¯¦ç¸½æ•¸)
      const { data: countData } = await supabase.from('visits').select('store_branch').gte('form_date', from).lte('form_date', to);
      if(countData) {
        document.getElementById('statTotal').textContent = countData.length;
        document.getElementById('statLinAn').textContent = countData.filter(r => r.store_branch === 'è‡¨å®‰åº—').length;
        document.getElementById('statNanKe').textContent = countData.filter(r => r.store_branch === 'å—ç§‘åº—').length;
      }
      renderAll();
    }
  };

  function renderAll() {
    // é‡ç½®ç¯©é¸ç‹€æ…‹
    document.getElementById('sourceFilter').value = 'ALL';
    document.getElementById('trendBox').classList.add('hidden');
    document.getElementById('purposeSubtitle').textContent = '(å…¨éƒ¨)';
    
    // ç¹ªè£½åˆå§‹åœ–è¡¨
    renderChart('chartSource', 'bar', stats.sources, 'tag', 'å®¢æºæ•¸é‡');
    renderChart('chartPurpose', 'doughnut', stats.purposes, 'purpose', 'ç›®çš„åˆ†ä½ˆ');
    
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = visits.map(v => `
      <tr class="hover:bg-blue-50 cursor-pointer transition border-b border-gray-50 last:border-0 group" onclick="showDetail('${v.form_date}', '${v.customer_name}')">
        <td class="p-3 pl-4 text-gray-600 font-mono text-xs">${v.form_date.slice(5)}</td>
        <td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold tracking-wide ${v.store_branch==='è‡¨å®‰åº—'?'bg-blue-100 text-blue-700':'bg-green-100 text-green-700'}">${v.store_branch}</span></td>
        <td class="p-3 font-bold text-gray-800">${v.customer_name}</td>
        <td class="p-3 text-xs text-gray-500 max-w-[100px] truncate"><div class="flex gap-1 flex-wrap">${(v.source_tags||[]).map(t=>`<span class="bg-gray-100 px-1 rounded">${t}</span>`).join('')}</div></td>
        <td class="p-3 text-xs text-gray-500 max-w-[100px] truncate">${(v.visit_purposes||[]).join(', ')}</td>
        <td class="p-3 pr-4 admin-only text-right"><button onclick="deleteData('${v.id}', event)" class="bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-700 p-1.5 rounded transition" title="åˆªé™¤"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>
      </tr>
    `).join('');
  }

  // --- FILTER & INTERACTION LOGIC ---
  window.filterSource = () => {
    const selected = document.getElementById('sourceFilter').value;
    
    if(selected === 'ALL') {
      renderAll();
    } else {
      // 1. é¡¯ç¤ºè¶¨å‹¢åœ–
      document.getElementById('trendBox').classList.remove('hidden');
      document.getElementById('trendLabel').textContent = selected;
      
      const timeline = stats.timeline || [];
      const dateMap = {};
      // ç°¡å–®çš„è³‡æ–™èšåˆ
      timeline.forEach(t => { 
        if(t.source_tags && t.source_tags.includes(selected)) {
          dateMap[t.form_date] = (dateMap[t.form_date] || 0) + 1; 
        }
      });
      const dates = Object.keys(dateMap).sort();
      const counts = dates.map(d => dateMap[d]);
      
      const ctxT = document.getElementById('chartTrendMini').getContext('2d');
      if(charts['trend']) charts['trend'].destroy();
      charts['trend'] = new Chart(ctxT, {
        type: 'line',
        data: { labels: dates, datasets: [{ label: selected, data: counts, borderColor: '#2563eb', backgroundColor: (ctx) => { const grad = ctx.chart.ctx.createLinearGradient(0,0,0,100); grad.addColorStop(0, 'rgba(37,99,235,0.2)'); grad.addColorStop(1, 'rgba(37,99,235,0)'); return grad; }, fill: true, tension: 0.4, pointRadius: 3 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
      });

      // 2. é€£å‹•å³å´ç›®çš„åœ– (Filtering Purpose Chart)
      // æˆ‘å€‘ä½¿ç”¨å‰ç«¯å·²æŠ“å–åˆ°çš„ visits è³‡æ–™ä¾†é€²è¡Œå³æ™‚éæ¿¾ (æ¯”å¾Œç«¯å¿«ä¸”å° UX æ›´å¥½)
      // æ³¨æ„ï¼šé€™è£¡å‡è¨­ visits åŒ…å«è¶³å¤ çš„æ¨£æœ¬ (Top 50-100) ä¾†å‘ˆç¾åˆ†ä½ˆï¼Œè‹¥éœ€ç²¾ç¢ºå…¨é«”æ•¸æ“šéœ€å¾Œç«¯ API æ”¯æ´
      // ç‚ºæ±‚å±•ç¤ºæ•ˆæœï¼Œæˆ‘å€‘å…ˆç”¨å‰ç«¯æ•¸æ“šéæ¿¾
      const relatedVisits = visits.filter(v => (v.source_tags||[]).includes(selected));
      const purposeCounts = {};
      relatedVisits.forEach(v => (v.visit_purposes||[]).forEach(p => purposeCounts[p] = (purposeCounts[p]||0)+1));
      
      const purposeData = Object.entries(purposeCounts).map(([k,v]) => ({purpose: k, c: v})).sort((a,b) => b.c - a.c);
      
      renderChart('chartPurpose', 'doughnut', purposeData, 'purpose', 'ç›®çš„ä½”æ¯”');
      document.getElementById('purposeSubtitle').textContent = `(ä¾†è‡ª: ${selected})`;
    }
  };

  function renderChart(id, type, data, key, label) {
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];
    
    charts[id] = new Chart(ctx, {
      type: type,
      data: {
        labels: data.map(d => d[key]),
        datasets: [{
          label: label,
          data: data.map(d => d.c),
          backgroundColor: colors,
          borderRadius: 4,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: type === 'doughnut', position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 10, cornerRadius: 8 }
        },
        scales: type === 'bar' ? { 
          y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
          x: { grid: { display: false } } 
        } : {}
      }
    });
  }

  // --- ADMIN FUNCTIONS ---
  window.toggleAdminPanel = () => document.getElementById('adminPanel').classList.toggle('hidden');
  
  window.login = async () => {
    const email = document.getElementById('admEmail').value;
    const pwd = document.getElementById('admPwd').value;
    if(!email || !pwd) { alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼'); return; }
    
    const { error } = await supabase.auth.signInWithPassword({ email, password: pwd });
    if(error) alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
    else checkAuth();
  }
  
  window.logout = async () => { await supabase.auth.signOut(); checkAuth(); }
  
  async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    if(data.session) {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('adminActions').classList.remove('hidden');
      document.body.classList.add('is-admin'); // Important for CSS
    } else {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminActions').classList.add('hidden');
      document.body.classList.remove('is-admin');
    }
  }

  // --- DATA OPERATIONS ---
  window.deleteData = async (id, event) => {
    event.stopPropagation();
    if(!confirm('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
    const { error } = await supabase.from('visits').delete().eq('id', id);
    if(error) alert('åˆªé™¤å¤±æ•—'); else fetchData();
  };

  window.saveData = async () => {
    const btn = document.getElementById('btnSave');
    btn.textContent = 'è™•ç†ä¸­...'; btn.disabled = true;
    
    const getArr = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(c => c.value);
    const payload = {
      p_date: document.getElementById('mDate').value,
      p_store: document.getElementById('mStore').value,
      p_name: document.getElementById('mName').value,
      p_gender: document.getElementById('mGender').value,
      p_age: document.getElementById('mAge').value,
      p_tainan: document.getElementById('mTainan').checked,
      p_sources: getArr('chkSources'),
      p_purposes: getArr('chkPurposes'),
      p_keyword: document.getElementById('mKeyword').value,
      p_detail: document.getElementById('mDetail').value
    };

    if(!payload.p_date || !payload.p_name) {
      alert('è«‹å¡«å¯«æ—¥æœŸèˆ‡å§“å');
      btn.textContent = 'å„²å­˜è³‡æ–™'; btn.disabled = false;
      return;
    }

    const { error } = await supabase.rpc('submit_visit', payload);
    if(error) alert('å„²å­˜å¤±æ•—: ' + error.message);
    else { closeModal(); fetchData(); }
    btn.textContent = 'å„²å­˜è³‡æ–™'; btn.disabled = false;
  };

  // --- CSV IMPORT/EXPORT ---
  window.exportCSV = () => {
    if(visits.length === 0) { alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º'); return; }
    const csv = Papa.unparse(visits);
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `wakodo_export_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  };

  window.importCSV = (input) => {
    const file = input.files[0];
    if(!file) return;
    
    if(!confirm('å³å°‡åŒ¯å…¥è³‡æ–™ï¼Œè«‹ç¢ºä¿ CSV æ ¼å¼æ­£ç¢ºã€‚\n(éœ€åŒ…å« form_date, customer_name ç­‰æ¬„ä½)')) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: async (results) => {
        let count = 0;
        for(let row of results.data) {
          if(!row.form_date || !row.customer_name) continue;
          
          const payload = {
            p_date: row.form_date,
            p_store: row.store_branch || 'è‡¨å®‰åº—',
            p_name: row.customer_name,
            p_gender: row.gender || '',
            p_age: row.age_group || '',
            p_tainan: (row.is_tainan === 'true' || row.is_tainan === 'TRUE'),
            p_sources: row.source_tags ? row.source_tags.split(',') : [],
            p_purposes: row.visit_purposes ? row.visit_purposes.split(',') : [],
            p_keyword: row.search_keyword || '',
            p_detail: row.detail_desc || ''
          };
          
          await supabase.rpc('submit_visit', payload);
          count++;
        }
        alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™ï¼`);
        fetchData();
      }
    });
  };

  // --- MODAL UTILS ---
  window.openAddModal = () => {
    document.getElementById('modal').style.display = 'flex'; 
    document.getElementById('modalTitle').textContent = 'æ–°å¢è³‡æ–™'; 
    document.getElementById('mDate').valueAsDate = new Date(); 
    document.getElementById('mStore').value = currentStore === 'å…¨éƒ¨' ? 'è‡¨å®‰åº—' : currentStore; 
    document.getElementById('mName').value = ''; 
    document.getElementById('mDetail').value = ''; 
    document.getElementById('mKeyword').value = ''; 
    document.querySelectorAll('#modal input[type="checkbox"]').forEach(c => { c.checked = false; c.parentElement.classList.remove('checked'); });
    document.querySelectorAll('#modal input, #modal select, #modal textarea').forEach(i => i.disabled = false);
    document.getElementById('btnSave').classList.remove('hidden');
  };

  window.showDetail = (date, name) => {
    const item = visits.find(v => v.form_date === date && v.customer_name === name);
    if(!item) return;
    
    document.getElementById('modal').style.display = 'flex'; 
    document.getElementById('modalTitle').textContent = 'è©³ç´°è³‡æ–™'; 
    document.getElementById('mDate').value = item.form_date; 
    document.getElementById('mStore').value = item.store_branch; 
    document.getElementById('mName').value = item.customer_name; 
    document.getElementById('mGender').value = item.gender; 
    document.getElementById('mAge').value = item.age_group; 
    document.getElementById('mTainan').checked = item.is_tainan; 
    document.getElementById('mDetail').value = item.detail_desc; 
    document.getElementById('mKeyword').value = item.search_keyword || ''; 
    
    document.querySelectorAll('#chkSources input').forEach(c => { 
      c.checked = (item.source_tags||[]).includes(c.value); 
      c.parentElement.classList.toggle('checked', c.checked);
    });
    document.querySelectorAll('#chkPurposes input').forEach(c => { 
      c.checked = (item.visit_purposes||[]).includes(c.value); 
      c.parentElement.classList.toggle('checked', c.checked);
    });
    
    document.querySelectorAll('#modal input, #modal select, #modal textarea').forEach(i => i.disabled = true);
    document.getElementById('btnSave').classList.add('hidden');
  };

  window.closeModal = () => document.getElementById('modal').style.display = 'none';
</script>
</body>
</html>
